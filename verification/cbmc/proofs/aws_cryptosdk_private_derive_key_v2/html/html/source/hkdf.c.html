
<html>
<head>
<title>source/hkdf.c</title>
<link rel="stylesheet" type="text/css" href="../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * Licensed under the Apache License, Version 2.0 (the "License"). You may not</div><div id="5" class="line none">    5  * use this file except in compliance with the License. A copy of the License is</div><div id="6" class="line none">    6  * located at</div><div id="7" class="line none">    7  *</div><div id="8" class="line none">    8  *     http://aws.amazon.com/apache2.0/</div><div id="9" class="line none">    9  *</div><div id="10" class="line none">   10  * or in the "license" file accompanying this file. This file is distributed on</div><div id="11" class="line none">   11  * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either</div><div id="12" class="line none">   12  * express or implied. See the License for the specific language governing</div><div id="13" class="line none">   13  * permissions and limitations under the License.</div><div id="14" class="line none">   14  */</div><div id="15" class="line none">   15 #include &lt;assert.h&gt;</div><div id="16" class="line none">   16 #include &lt;aws/common/byte_buf.h&gt;</div><div id="17" class="line none">   17 #include &lt;aws/cryptosdk/error.h&gt;</div><div id="18" class="line none">   18 #include &lt;aws/cryptosdk/private/hkdf.h&gt;</div><div id="19" class="line none">   19 #include &lt;openssl/evp.h&gt;</div><div id="20" class="line none">   20 #include &lt;openssl/hmac.h&gt;</div><div id="21" class="line none">   21 #include &lt;openssl/opensslv.h&gt;</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 static const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#40">EVP_MD</a> *<a href="hkdf.c.html#23">aws_cryptosdk_get_evp_md</a>(enum <a href="../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> which_sha) {</div><div id="24" class="line hit">   24     switch (which_sha) {</div><div id="25" class="line hit">   25         case <a href="../include/aws/cryptosdk/private/hkdf.h.html#23">AWS_CRYPTOSDK_SHA256</a>: return <a href="../verification/cbmc/sources/openssl/evp_override.c.html#700">EVP_sha256</a>();</div><div id="26" class="line hit">   26         case <a href="../include/aws/cryptosdk/private/hkdf.h.html#24">AWS_CRYPTOSDK_SHA384</a>: return <a href="../verification/cbmc/sources/openssl/evp_override.c.html#704">EVP_sha384</a>();</div><div id="27" class="line hit">   27         case <a href="../include/aws/cryptosdk/private/hkdf.h.html#25">AWS_CRYPTOSDK_SHA512</a>: return <a href="../verification/cbmc/sources/openssl/evp_override.c.html#708">EVP_sha512</a>();</div><div id="28" class="line missed">   28         default: return NULL;</div><div id="29" class="line none">   29     }</div><div id="30" class="line both">   30 }</div><div id="31" class="line none">   31 </div><div id="32" class="line none">   32 #if OPENSSL_VERSION_NUMBER &lt; 0x10100000L</div><div id="33" class="line none">   33 </div><div id="34" class="line none">   34 static int <a href="hkdf.c.html#34">aws_cryptosdk_hkdf_extract</a>(</div><div id="35" class="line none">   35     /* prk must be a buffer of EVP_MAX_MD_SIZE bytes */</div><div id="36" class="line none">   36     uint8_t *prk,</div><div id="37" class="line none">   37     unsigned int *prk_len,</div><div id="38" class="line none">   38     enum <a href="../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> which_sha,</div><div id="39" class="line none">   39     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *salt,</div><div id="40" class="line none">   40     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *ikm) {</div><div id="41" class="line none">   41     const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#40">EVP_MD</a> *evp_md = <a href="hkdf.c.html#23">aws_cryptosdk_get_evp_md</a>(which_sha);</div><div id="42" class="line none">   42     if (!evp_md) return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT);</div><div id="43" class="line none">   43 </div><div id="44" class="line none">   44     static const uint8_t zeroes[EVP_MAX_MD_SIZE] = { 0 };</div><div id="45" class="line none">   45     const uint8_t *mysalt                        = NULL;</div><div id="46" class="line none">   46     size_t mysalt_len                            = 0;</div><div id="47" class="line none">   47 </div><div id="48" class="line none">   48     if (salt-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="49" class="line none">   49         mysalt     = (uint8_t *)salt-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="50" class="line none">   50         mysalt_len = salt-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>;</div><div id="51" class="line none">   51     } else {</div><div id="52" class="line none">   52         mysalt     = zeroes;</div><div id="53" class="line none">   53         mysalt_len = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#716">EVP_MD_size</a>(evp_md);</div><div id="54" class="line none">   54     }</div><div id="55" class="line none">   55     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#912">HMAC</a>(evp_md, mysalt, mysalt_len, ikm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, ikm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>, prk, prk_len) || *prk_len == 0) {</div><div id="56" class="line none">   56         <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(prk, EVP_MAX_MD_SIZE);</div><div id="57" class="line none">   57         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="58" class="line none">   58     }</div><div id="59" class="line none">   59     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="60" class="line none">   60 }</div><div id="61" class="line none">   61 </div><div id="62" class="line none">   62 static int <a href="hkdf.c.html#62">aws_cryptosdk_hkdf_expand</a>(</div><div id="63" class="line none">   63     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *okm,</div><div id="64" class="line none">   64     enum <a href="../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> which_sha,</div><div id="65" class="line none">   65     const uint8_t *prk,</div><div id="66" class="line none">   66     unsigned int prk_len,</div><div id="67" class="line none">   67     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *info) {</div><div id="68" class="line none">   68     const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#40">EVP_MD</a> *evp_md = <a href="hkdf.c.html#23">aws_cryptosdk_get_evp_md</a>(which_sha);</div><div id="69" class="line none">   69     if (!evp_md) return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT);</div><div id="70" class="line none">   70     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#36">HMAC_CTX</a> <a href="cipher_openssl.c.html#78">ctx</a>;</div><div id="71" class="line none">   71     uint8_t t[EVP_MAX_MD_SIZE];</div><div id="72" class="line none">   72     size_t n           = 0;</div><div id="73" class="line none">   73     unsigned int t_len = 0;</div><div id="74" class="line none">   74     size_t bytes_to_write;</div><div id="75" class="line none">   75     size_t bytes_remaining = okm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>;</div><div id="76" class="line none">   76     size_t hash_len        = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#716">EVP_MD_size</a>(evp_md);</div><div id="77" class="line none">   77     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#895">HMAC_CTX_init</a>(&amp;<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="78" class="line none">   78     if (!prk || !okm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> || !prk_len) goto err;</div><div id="79" class="line none">   79     n = (okm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> + hash_len - 1) / hash_len;</div><div id="80" class="line none">   80     if (n &gt; 255) goto err;</div><div id="81" class="line none">   81     for (uint32_t idx = 1; idx &lt;= n; idx++) {</div><div id="82" class="line none">   82         uint8_t idx_byte = idx;</div><div id="83" class="line none">   83         if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#948">HMAC_Init_ex</a>(&amp;<a href="cipher_openssl.c.html#78">ctx</a>, prk, prk_len, evp_md, NULL)) goto err;</div><div id="84" class="line none">   84         if (idx != 1) {</div><div id="85" class="line none">   85             if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#964">HMAC_Update</a>(&amp;<a href="cipher_openssl.c.html#78">ctx</a>, t, hash_len)) goto err;</div><div id="86" class="line none">   86         }</div><div id="87" class="line none">   87         if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#964">HMAC_Update</a>(&amp;<a href="cipher_openssl.c.html#78">ctx</a>, info-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, info-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto err;</div><div id="88" class="line none">   88         if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#964">HMAC_Update</a>(&amp;<a href="cipher_openssl.c.html#78">ctx</a>, &amp;idx_byte, 1)) goto err;</div><div id="89" class="line none">   89         if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#974">HMAC_Final</a>(&amp;<a href="cipher_openssl.c.html#78">ctx</a>, t, &amp;t_len)) goto err;</div><div id="90" class="line none">   90 </div><div id="91" class="line none">   91         assert(t_len == hash_len);</div><div id="92" class="line none">   92         bytes_to_write = bytes_remaining &lt; hash_len ? bytes_remaining : hash_len;</div><div id="93" class="line none">   93         memcpy(okm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + (idx - 1) * hash_len, t, bytes_to_write);</div><div id="94" class="line none">   94         bytes_remaining -= bytes_to_write;</div><div id="95" class="line none">   95     }</div><div id="96" class="line none">   96     assert(bytes_remaining == 0);</div><div id="97" class="line none">   97     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(t, sizeof(t));</div><div id="98" class="line none">   98     HMAC_CTX_cleanup(&amp;<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="99" class="line none">   99     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="100" class="line none">  100 </div><div id="101" class="line none">  101 err:</div><div id="102" class="line none">  102     HMAC_CTX_cleanup(&amp;<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="103" class="line none">  103     <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#87">aws_byte_buf_secure_zero</a>(okm);</div><div id="104" class="line none">  104     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(t, sizeof(t));</div><div id="105" class="line none">  105     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="106" class="line none">  106 }</div><div id="107" class="line none">  107 #else</div><div id="108" class="line none">  108 #    include &lt;openssl/kdf.h&gt;</div><div id="109" class="line none">  109 </div><div id="110" class="line none">  110 static int <a href="hkdf.c.html#110">aws_cryptosdk_openssl_hkdf_version</a>(</div><div id="111" class="line none">  111     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *okm,</div><div id="112" class="line none">  112     enum <a href="../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> which_sha,</div><div id="113" class="line none">  113     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *salt,</div><div id="114" class="line none">  114     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *ikm,</div><div id="115" class="line none">  115     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *info) {</div><div id="116" class="line hit">  116     const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#40">EVP_MD</a> *evp_md = <a href="hkdf.c.html#23">aws_cryptosdk_get_evp_md</a>(which_sha);</div><div id="117" class="line both">  117     if (!evp_md) return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT);</div><div id="118" class="line hit">  118     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#35">EVP_PKEY_CTX</a> *pctx = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#123">EVP_PKEY_CTX_new_id</a>(EVP_PKEY_HKDF, NULL);</div><div id="119" class="line hit">  119     if (!pctx) return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="120" class="line none">  120     static const uint8_t zeroes[EVP_MAX_MD_SIZE] = { 0 };</div><div id="121" class="line hit">  121     const uint8_t *mysalt                        = NULL;</div><div id="122" class="line hit">  122     size_t mysalt_len                            = 0;</div><div id="123" class="line hit">  123     if (salt-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="124" class="line hit">  124         mysalt     = (uint8_t *)salt-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="125" class="line hit">  125         mysalt_len = salt-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>;</div><div id="126" class="line none">  126     } else {</div><div id="127" class="line missed">  127         mysalt     = zeroes;</div><div id="128" class="line missed">  128         mysalt_len = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#716">EVP_MD_size</a>(evp_md);</div><div id="129" class="line missed">  129     }</div><div id="130" class="line none">  130 </div><div id="131" class="line hit">  131     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#144">EVP_PKEY_derive_init</a>(pctx) &lt;= 0) goto err;</div><div id="132" class="line hit">  132     if (EVP_PKEY_CTX_set_hkdf_md(pctx, evp_md) &lt;= 0) goto err;</div><div id="133" class="line hit">  133     if (EVP_PKEY_CTX_set1_hkdf_salt(pctx, mysalt, mysalt_len) &lt;= 0) goto err;</div><div id="134" class="line hit">  134     if (EVP_PKEY_CTX_set1_hkdf_key(pctx, ikm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, ikm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) &lt;= 0) goto err;</div><div id="135" class="line hit">  135     if (EVP_PKEY_CTX_add1_hkdf_info(pctx, info-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, info-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) &lt;= 0) goto err;</div><div id="136" class="line hit">  136     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#237">EVP_PKEY_derive</a>(pctx, okm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, &amp;okm-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) &lt;= 0) goto err;</div><div id="137" class="line none">  137 </div><div id="138" class="line hit">  138     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#402">EVP_PKEY_CTX_free</a>(pctx);</div><div id="139" class="line hit">  139     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="140" class="line none">  140 </div><div id="141" class="line none">  141 err:</div><div id="142" class="line hit">  142     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#402">EVP_PKEY_CTX_free</a>(pctx);</div><div id="143" class="line hit">  143     <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#87">aws_byte_buf_secure_zero</a>(okm);</div><div id="144" class="line hit">  144     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="145" class="line hit">  145 }</div><div id="146" class="line none">  146 #endif  // OPENSSL_VERSION_NUMBER</div><div id="147" class="line none">  147 </div><div id="148" class="line none">  148 int <a href="hkdf.c.html#148">aws_cryptosdk_hkdf</a>(</div><div id="149" class="line none">  149     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *okm,</div><div id="150" class="line none">  150     enum <a href="../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> which_sha,</div><div id="151" class="line none">  151     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *salt,</div><div id="152" class="line none">  152     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *ikm,</div><div id="153" class="line none">  153     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *info) {</div><div id="154" class="line none">  154 #if OPENSSL_VERSION_NUMBER &lt; 0x10100000L</div><div id="155" class="line none">  155     uint8_t prk[EVP_MAX_MD_SIZE];</div><div id="156" class="line none">  156     unsigned int prk_len = 0;</div><div id="157" class="line none">  157     if (<a href="hkdf.c.html#34">aws_cryptosdk_hkdf_extract</a>(prk, &amp;prk_len, which_sha, salt, ikm)) goto err;</div><div id="158" class="line none">  158     if (<a href="hkdf.c.html#62">aws_cryptosdk_hkdf_expand</a>(okm, which_sha, prk, prk_len, info)) goto err;</div><div id="159" class="line none">  159     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(prk, sizeof(prk));</div><div id="160" class="line none">  160     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="161" class="line none">  161 err:</div><div id="162" class="line none">  162     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(prk, sizeof(prk));</div><div id="163" class="line none">  163     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a>;</div><div id="164" class="line none">  164 #else</div><div id="165" class="line hit">  165     return <a href="hkdf.c.html#110">aws_cryptosdk_openssl_hkdf_version</a>(okm, which_sha, salt, ikm, info);</div><div id="166" class="line none">  166 #endif  // OPENSSL_VERSION_NUMBER</div><div id="167" class="line hit">  167 }</div>
</div>
</body>
</html>
