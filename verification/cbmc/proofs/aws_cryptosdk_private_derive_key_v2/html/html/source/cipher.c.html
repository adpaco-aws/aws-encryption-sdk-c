
<html>
<head>
<title>source/cipher.c</title>
<link rel="stylesheet" type="text/css" href="../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * Licensed under the Apache License, Version 2.0 (the "License"). You may not use</div><div id="5" class="line none">    5  * this file except in compliance with the License. A copy of the License is</div><div id="6" class="line none">    6  * located at</div><div id="7" class="line none">    7  *</div><div id="8" class="line none">    8  *     http://aws.amazon.com/apache2.0/</div><div id="9" class="line none">    9  *</div><div id="10" class="line none">   10  * or in the "license" file accompanying this file. This file is distributed on an</div><div id="11" class="line none">   11  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</div><div id="12" class="line none">   12  * implied. See the License for the specific language governing permissions and</div><div id="13" class="line none">   13  * limitations under the License.</div><div id="14" class="line none">   14  */</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 #include &lt;assert.h&gt;</div><div id="17" class="line none">   17 #include &lt;openssl/err.h&gt;</div><div id="18" class="line none">   18 #include &lt;openssl/evp.h&gt;</div><div id="19" class="line none">   19 #include &lt;openssl/pem.h&gt;</div><div id="20" class="line none">   20 #include &lt;openssl/rand.h&gt;</div><div id="21" class="line none">   21 #include &lt;openssl/rsa.h&gt;</div><div id="22" class="line none">   22 #include &lt;stdbool.h&gt;</div><div id="23" class="line none">   23 </div><div id="24" class="line none">   24 #include &lt;aws/common/byte_order.h&gt;</div><div id="25" class="line none">   25 #include &lt;aws/cryptosdk/error.h&gt;</div><div id="26" class="line none">   26 #include &lt;aws/cryptosdk/private/<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.h&gt;</div><div id="27" class="line none">   27 #include &lt;aws/cryptosdk/private/header.h&gt;</div><div id="28" class="line none">   28 #include &lt;aws/cryptosdk/private/hkdf.h&gt;</div><div id="29" class="line none">   29 </div><div id="30" class="line none">   30 #define <a href="cipher.c.html#30">MSG_ID_LEN</a> 16</div><div id="31" class="line none">   31 #define <a href="cipher.c.html#31">MSG_ID_LEN_V2</a> 32</div><div id="32" class="line none">   32 </div><div id="33" class="line none">   33 const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher.c.html#33">aws_cryptosdk_alg_props</a>(enum <a href="../include/aws/cryptosdk/header.h.html#26">aws_cryptosdk_alg_id</a> <a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>) {</div><div id="34" class="line none">   34 #define <a href="cipher.c.html#34">EVP_NULL</a> NULL</div><div id="35" class="line none">   35 #define <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(                                                                                      \</div><div id="36" class="line none">   36     alg_id_v,                                                                                                  \</div><div id="37" class="line none">   37     msg_format_version_v,                                                                                      \</div><div id="38" class="line none">   38     md,                                                                                                        \</div><div id="39" class="line none">   39     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>,                                                                                                    \</div><div id="40" class="line none">   40     dk_len_v,                                                                                                  \</div><div id="41" class="line none">   41     iv_len_v,                                                                                                  \</div><div id="42" class="line none">   42     tag_len_v,                                                                                                 \</div><div id="43" class="line none">   43     signature_len_v,                                                                                           \</div><div id="44" class="line none">   44     sig_md_v,                                                                                                  \</div><div id="45" class="line none">   45     curve_name_v,                                                                                              \</div><div id="46" class="line none">   46     alg_suite_data_len_v,                                                                                      \</div><div id="47" class="line none">   47     commitment_len_v)                                                                                          \</div><div id="48" class="line none">   48     case alg_id_v: {                                                                                           \</div><div id="49" class="line none">   49         static const struct <a href="../include/aws/cryptosdk/cipher.h.html#67">aws_cryptosdk_alg_impl</a> <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a> = {                                                    \</div><div id="50" class="line none">   50             .<a href="../include/aws/cryptosdk/private/cipher.h.html#26">md_ctor</a>     = (EVP_##md),                                                                         \</div><div id="51" class="line none">   51             .<a href="../include/aws/cryptosdk/private/cipher.h.html#27">sig_md_ctor</a> = (EVP_##sig_md_v),                                                                   \</div><div id="52" class="line none">   52             .<a href="../include/aws/cryptosdk/private/cipher.h.html#28">cipher_ctor</a> = (EVP_##<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>),                                                                     \</div><div id="53" class="line none">   53             .<a href="../verification/cbmc/sources/openssl/ec_override.c.html#28">curve_name</a>  = (curve_name_v),                                                                     \</div><div id="54" class="line none">   54         };                                                                                                     \</div><div id="55" class="line none">   55         static const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> <a href="cipher_openssl.c.html#75">props</a> = {                                             \</div><div id="56" class="line none">   56             .<a href="../include/aws/cryptosdk/cipher.h.html#56">md_name</a>     = #md,                                                                                \</div><div id="57" class="line none">   57             .<a href="../include/aws/cryptosdk/cipher.h.html#58">cipher_name</a> = #<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>,                                                                            \</div><div id="58" class="line none">   58             .<a href="../include/aws/cryptosdk/cipher.h.html#60">alg_name</a>    = #alg_id_v,                                                                          \</div><div id="59" class="line none">   59             .<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>        = &amp;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>,                                                                              \</div><div id="60" class="line none">   60             .<a href="../include/aws/cryptosdk/cipher.h.html#70">data_key_len</a> =                                                                                    \</div><div id="61" class="line none">   61                 (dk_len_v) / 8, /* Currently we don't support any algorithms where DK and CK lengths differ */ \</div><div id="62" class="line none">   62             .<a href="../include/aws/cryptosdk/cipher.h.html#75">content_key_len</a>    = (dk_len_v) / 8,                                                              \</div><div id="63" class="line none">   63             .<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a>             = (iv_len_v),                                                                  \</div><div id="64" class="line none">   64             .<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>            = (tag_len_v),                                                                 \</div><div id="65" class="line none">   65             .<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>             = (alg_id_v),                                                                  \</div><div id="66" class="line none">   66             .<a href="../include/aws/cryptosdk/cipher.h.html#88">signature_len</a>      = (signature_len_v),                                                           \</div><div id="67" class="line none">   67             .<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a> = (msg_format_version_v),                                                      \</div><div id="68" class="line none">   68             .<a href="../include/aws/cryptosdk/cipher.h.html#103">alg_suite_data_len</a> = (alg_suite_data_len_v) / 8,                                                  \</div><div id="69" class="line none">   69             .<a href="../include/aws/cryptosdk/cipher.h.html#109">commitment_len</a>     = (commitment_len_v) / 8,                                                      \</div><div id="70" class="line none">   70             .<a href="../include/aws/cryptosdk/cipher.h.html#112">sig_md_name</a>        = #sig_md_v                                                                    \</div><div id="71" class="line none">   71         };                                                                                                     \</div><div id="72" class="line none">   72         return &amp;<a href="cipher_openssl.c.html#75">props</a>;                                                                                         \</div><div id="73" class="line none">   73     }</div><div id="74" class="line hit">   74     switch (<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>) {</div><div id="75" class="line hit">   75         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="76" class="line none">   76             <a href="../include/aws/cryptosdk/header.h.html#37">ALG_AES128_GCM_IV12_TAG16_NO_KDF</a>,</div><div id="77" class="line none">   77             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="78" class="line none">   78             NULL,</div><div id="79" class="line none">   79             aes_128_gcm,</div><div id="80" class="line none">   80             128,</div><div id="81" class="line none">   81             12,</div><div id="82" class="line none">   82             16,</div><div id="83" class="line none">   83             0,</div><div id="84" class="line none">   84             NULL,</div><div id="85" class="line none">   85             NULL,</div><div id="86" class="line none">   86             0,</div><div id="87" class="line none">   87             0);</div><div id="88" class="line hit">   88         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="89" class="line none">   89             <a href="../include/aws/cryptosdk/header.h.html#34">ALG_AES128_GCM_IV12_TAG16_HKDF_SHA256</a>,</div><div id="90" class="line none">   90             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="91" class="line none">   91             sha256,</div><div id="92" class="line none">   92             aes_128_gcm,</div><div id="93" class="line none">   93             128,</div><div id="94" class="line none">   94             12,</div><div id="95" class="line none">   95             16,</div><div id="96" class="line none">   96             0,</div><div id="97" class="line none">   97             NULL,</div><div id="98" class="line none">   98             NULL,</div><div id="99" class="line none">   99             0,</div><div id="100" class="line none">  100             0);</div><div id="101" class="line hit">  101         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="102" class="line none">  102             <a href="../include/aws/cryptosdk/header.h.html#36">ALG_AES192_GCM_IV12_TAG16_NO_KDF</a>,</div><div id="103" class="line none">  103             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="104" class="line none">  104             NULL,</div><div id="105" class="line none">  105             aes_192_gcm,</div><div id="106" class="line none">  106             192,</div><div id="107" class="line none">  107             12,</div><div id="108" class="line none">  108             16,</div><div id="109" class="line none">  109             0,</div><div id="110" class="line none">  110             NULL,</div><div id="111" class="line none">  111             NULL,</div><div id="112" class="line none">  112             0,</div><div id="113" class="line none">  113             0);</div><div id="114" class="line hit">  114         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="115" class="line none">  115             <a href="../include/aws/cryptosdk/header.h.html#33">ALG_AES192_GCM_IV12_TAG16_HKDF_SHA256</a>,</div><div id="116" class="line none">  116             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="117" class="line none">  117             sha256,</div><div id="118" class="line none">  118             aes_192_gcm,</div><div id="119" class="line none">  119             192,</div><div id="120" class="line none">  120             12,</div><div id="121" class="line none">  121             16,</div><div id="122" class="line none">  122             0,</div><div id="123" class="line none">  123             NULL,</div><div id="124" class="line none">  124             NULL,</div><div id="125" class="line none">  125             0,</div><div id="126" class="line none">  126             0);</div><div id="127" class="line hit">  127         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="128" class="line none">  128             <a href="../include/aws/cryptosdk/header.h.html#35">ALG_AES256_GCM_IV12_TAG16_NO_KDF</a>,</div><div id="129" class="line none">  129             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="130" class="line none">  130             NULL,</div><div id="131" class="line none">  131             aes_256_gcm,</div><div id="132" class="line none">  132             256,</div><div id="133" class="line none">  133             12,</div><div id="134" class="line none">  134             16,</div><div id="135" class="line none">  135             0,</div><div id="136" class="line none">  136             NULL,</div><div id="137" class="line none">  137             NULL,</div><div id="138" class="line none">  138             0,</div><div id="139" class="line none">  139             0);</div><div id="140" class="line hit">  140         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="141" class="line none">  141             <a href="../include/aws/cryptosdk/header.h.html#32">ALG_AES256_GCM_IV12_TAG16_HKDF_SHA256</a>,</div><div id="142" class="line none">  142             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="143" class="line none">  143             sha256,</div><div id="144" class="line none">  144             aes_256_gcm,</div><div id="145" class="line none">  145             256,</div><div id="146" class="line none">  146             12,</div><div id="147" class="line none">  147             16,</div><div id="148" class="line none">  148             0,</div><div id="149" class="line none">  149             NULL,</div><div id="150" class="line none">  150             NULL,</div><div id="151" class="line none">  151             0,</div><div id="152" class="line none">  152             0);</div><div id="153" class="line hit">  153         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="154" class="line none">  154             <a href="../include/aws/cryptosdk/header.h.html#28">ALG_AES256_GCM_HKDF_SHA512_COMMIT_KEY</a>,</div><div id="155" class="line none">  155             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_2_0</a>,</div><div id="156" class="line none">  156             sha512,</div><div id="157" class="line none">  157             aes_256_gcm,</div><div id="158" class="line none">  158             256,</div><div id="159" class="line none">  159             12,</div><div id="160" class="line none">  160             16,</div><div id="161" class="line none">  161             0,</div><div id="162" class="line none">  162             NULL,</div><div id="163" class="line none">  163             NULL,</div><div id="164" class="line none">  164             256,</div><div id="165" class="line none">  165             256);</div><div id="166" class="line none">  166         // secp256r1 aka prime256v1 aka P-256</div><div id="167" class="line none">  167         // openssl does not define the 'secp256r1' alias however</div><div id="168" class="line hit">  168         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="169" class="line none">  169             <a href="../include/aws/cryptosdk/header.h.html#31">ALG_AES128_GCM_IV12_TAG16_HKDF_SHA256_ECDSA_P256</a>,</div><div id="170" class="line none">  170             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="171" class="line none">  171             sha256,</div><div id="172" class="line none">  172             aes_128_gcm,</div><div id="173" class="line none">  173             128,</div><div id="174" class="line none">  174             12,</div><div id="175" class="line none">  175             16,</div><div id="176" class="line none">  176             71,</div><div id="177" class="line none">  177             sha256,</div><div id="178" class="line none">  178             "prime256v1",</div><div id="179" class="line none">  179             0,</div><div id="180" class="line none">  180             0);</div><div id="181" class="line hit">  181         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="182" class="line none">  182             <a href="../include/aws/cryptosdk/header.h.html#30">ALG_AES192_GCM_IV12_TAG16_HKDF_SHA384_ECDSA_P384</a>,</div><div id="183" class="line none">  183             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="184" class="line none">  184             sha384,</div><div id="185" class="line none">  185             aes_192_gcm,</div><div id="186" class="line none">  186             192,</div><div id="187" class="line none">  187             12,</div><div id="188" class="line none">  188             16,</div><div id="189" class="line none">  189             103,</div><div id="190" class="line none">  190             sha384,</div><div id="191" class="line none">  191             "secp384r1",</div><div id="192" class="line none">  192             0,</div><div id="193" class="line none">  193             0);</div><div id="194" class="line hit">  194         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="195" class="line none">  195             <a href="../include/aws/cryptosdk/header.h.html#29">ALG_AES256_GCM_IV12_TAG16_HKDF_SHA384_ECDSA_P384</a>,</div><div id="196" class="line none">  196             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>,</div><div id="197" class="line none">  197             sha384,</div><div id="198" class="line none">  198             aes_256_gcm,</div><div id="199" class="line none">  199             256,</div><div id="200" class="line none">  200             12,</div><div id="201" class="line none">  201             16,</div><div id="202" class="line none">  202             103,</div><div id="203" class="line none">  203             sha384,</div><div id="204" class="line none">  204             "secp384r1",</div><div id="205" class="line none">  205             0,</div><div id="206" class="line none">  206             0);</div><div id="207" class="line hit">  207         <a href="cipher.c.html#35">STATIC_ALG_PROPS</a>(</div><div id="208" class="line none">  208             <a href="../include/aws/cryptosdk/header.h.html#27">ALG_AES256_GCM_HKDF_SHA512_COMMIT_KEY_ECDSA_P384</a>,</div><div id="209" class="line none">  209             <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_2_0</a>,</div><div id="210" class="line none">  210             sha512,</div><div id="211" class="line none">  211             aes_256_gcm,</div><div id="212" class="line none">  212             256,</div><div id="213" class="line none">  213             12,</div><div id="214" class="line none">  214             16,</div><div id="215" class="line none">  215             103,</div><div id="216" class="line none">  216             sha384,</div><div id="217" class="line none">  217             "secp384r1",</div><div id="218" class="line none">  218             256,</div><div id="219" class="line none">  219             256);</div><div id="220" class="line hit">  220         default: return NULL;</div><div id="221" class="line none">  221     }</div><div id="222" class="line none">  222 #undef <a href="cipher.c.html#35">STATIC_ALG_PROPS</a></div><div id="223" class="line none">  223 #undef <a href="cipher.c.html#34">EVP_NULL</a></div><div id="224" class="line both">  224 }</div><div id="225" class="line none">  225 </div><div id="226" class="line none">  226 size_t <a href="cipher.c.html#226">aws_cryptosdk_private_algorithm_message_id_len</a>(const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *alg_props) {</div><div id="227" class="line none">  227     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(alg_props));</div><div id="228" class="line none">  228 </div><div id="229" class="line none">  229     switch (alg_props-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a>) {</div><div id="230" class="line none">  230         case <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>: return <a href="cipher.c.html#30">MSG_ID_LEN</a>;</div><div id="231" class="line none">  231         case <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_2_0</a>: return <a href="cipher.c.html#31">MSG_ID_LEN_V2</a>;</div><div id="232" class="line none">  232         default: return 0;</div><div id="233" class="line none">  233     }</div><div id="234" class="line none">  234 }</div><div id="235" class="line none">  235 </div><div id="236" class="line none">  236 /**</div><div id="237" class="line none">  237  * Returns the SHA to be used in the KDF for the given algorithm.</div><div id="238" class="line none">  238  */</div><div id="239" class="line none">  239 static enum <a href="../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> <a href="cipher.c.html#239">aws_cryptosdk_which_sha</a>(enum <a href="../include/aws/cryptosdk/header.h.html#26">aws_cryptosdk_alg_id</a> <a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>) {</div><div id="240" class="line hit">  240     switch (<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>) {</div><div id="241" class="line none">  241         case <a href="../include/aws/cryptosdk/header.h.html#27">ALG_AES256_GCM_HKDF_SHA512_COMMIT_KEY_ECDSA_P384</a>:</div><div id="242" class="line hit">  242         case <a href="../include/aws/cryptosdk/header.h.html#28">ALG_AES256_GCM_HKDF_SHA512_COMMIT_KEY</a>: return <a href="../include/aws/cryptosdk/private/hkdf.h.html#25">AWS_CRYPTOSDK_SHA512</a>;</div><div id="243" class="line none">  243         case <a href="../include/aws/cryptosdk/header.h.html#29">ALG_AES256_GCM_IV12_TAG16_HKDF_SHA384_ECDSA_P384</a>:</div><div id="244" class="line hit">  244         case <a href="../include/aws/cryptosdk/header.h.html#30">ALG_AES192_GCM_IV12_TAG16_HKDF_SHA384_ECDSA_P384</a>: return <a href="../include/aws/cryptosdk/private/hkdf.h.html#24">AWS_CRYPTOSDK_SHA384</a>;</div><div id="245" class="line none">  245         case <a href="../include/aws/cryptosdk/header.h.html#31">ALG_AES128_GCM_IV12_TAG16_HKDF_SHA256_ECDSA_P256</a>:</div><div id="246" class="line none">  246         case <a href="../include/aws/cryptosdk/header.h.html#32">ALG_AES256_GCM_IV12_TAG16_HKDF_SHA256</a>:</div><div id="247" class="line none">  247         case <a href="../include/aws/cryptosdk/header.h.html#33">ALG_AES192_GCM_IV12_TAG16_HKDF_SHA256</a>:</div><div id="248" class="line hit">  248         case <a href="../include/aws/cryptosdk/header.h.html#34">ALG_AES128_GCM_IV12_TAG16_HKDF_SHA256</a>: return <a href="../include/aws/cryptosdk/private/hkdf.h.html#23">AWS_CRYPTOSDK_SHA256</a>;</div><div id="249" class="line none">  249         case <a href="../include/aws/cryptosdk/header.h.html#35">ALG_AES256_GCM_IV12_TAG16_NO_KDF</a>:</div><div id="250" class="line none">  250         case <a href="../include/aws/cryptosdk/header.h.html#36">ALG_AES192_GCM_IV12_TAG16_NO_KDF</a>:</div><div id="251" class="line hit">  251         case <a href="../include/aws/cryptosdk/header.h.html#37">ALG_AES128_GCM_IV12_TAG16_NO_KDF</a>:</div><div id="252" class="line both">  252         default: return <a href="../include/aws/cryptosdk/private/hkdf.h.html#22">AWS_CRYPTOSDK_NOSHA</a>;</div><div id="253" class="line none">  253     }</div><div id="254" class="line both">  254 }</div><div id="255" class="line none">  255 </div><div id="256" class="line none">  256 static bool <a href="cipher.c.html#256">aws_cryptosdk_alg_properties_equal</a>(</div><div id="257" class="line none">  257     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> alg_props1, const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> alg_props2) {</div><div id="258" class="line none">  258     /* Note: We are not checking whether the names (md/cipher/alg) are</div><div id="259" class="line none">  259      * equal */</div><div id="260" class="line none">  260 </div><div id="261" class="line none">  261     /* Note: We are not checking whether the underlying alg_impl</div><div id="262" class="line none">  262      * structs are equal. */</div><div id="263" class="line hit">  263     return alg_props1.<a href="../include/aws/cryptosdk/cipher.h.html#70">data_key_len</a> == alg_props2.<a href="../include/aws/cryptosdk/cipher.h.html#70">data_key_len</a> &amp;&amp;</div><div id="264" class="line none">  264            alg_props1.<a href="../include/aws/cryptosdk/cipher.h.html#75">content_key_len</a> == alg_props2.<a href="../include/aws/cryptosdk/cipher.h.html#75">content_key_len</a> &amp;&amp; alg_props1.<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a> == alg_props2.<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a> &amp;&amp;</div><div id="265" class="line none">  265            alg_props1.<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a> == alg_props2.<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a> &amp;&amp; alg_props1.<a href="../include/aws/cryptosdk/cipher.h.html#88">signature_len</a> == alg_props2.<a href="../include/aws/cryptosdk/cipher.h.html#88">signature_len</a> &amp;&amp;</div><div id="266" class="line none">  266            alg_props1.<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a> == alg_props2.<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>;</div><div id="267" class="line hit">  267 }</div><div id="268" class="line none">  268 </div><div id="269" class="line none">  269 bool <a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *const alg_props) {</div><div id="270" class="line hit">  270     if (alg_props == NULL) {</div><div id="271" class="line hit">  271         return false;</div><div id="272" class="line none">  272     }</div><div id="273" class="line hit">  273     enum <a href="../include/aws/cryptosdk/header.h.html#26">aws_cryptosdk_alg_id</a> id                             = alg_props-&gt;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>;</div><div id="274" class="line hit">  274     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *std_alg_props = <a href="cipher.c.html#33">aws_cryptosdk_alg_props</a>(id);</div><div id="275" class="line hit">  275     if (std_alg_props == NULL) {</div><div id="276" class="line hit">  276         return false;</div><div id="277" class="line none">  277     }</div><div id="278" class="line hit">  278     return alg_props-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#56">md_name</a> &amp;&amp; alg_props-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#58">cipher_name</a> &amp;&amp; alg_props-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#60">alg_name</a> &amp;&amp;</div><div id="279" class="line hit">  279            <a href="cipher.c.html#256">aws_cryptosdk_alg_properties_equal</a>(*alg_props, *std_alg_props);</div><div id="280" class="line hit">  280 }</div><div id="281" class="line none">  281 </div><div id="282" class="line none">  282 bool <a href="cipher.c.html#282">aws_cryptosdk_private_commitment_eq</a>(struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *a, struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *b) {</div><div id="283" class="line none">  283     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(a));</div><div id="284" class="line none">  284     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(b));</div><div id="285" class="line none">  285 </div><div id="286" class="line none">  286     if (a-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != b-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) return false;</div><div id="287" class="line none">  287 </div><div id="288" class="line none">  288     // If the (expected and true) commitment is zero-length, we're in a non-committing</div><div id="289" class="line none">  289     // algorithm suite, so we succeed trivially.</div><div id="290" class="line none">  290     if (a-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> == 0) return true;</div><div id="291" class="line none">  291 </div><div id="292" class="line none">  292     // Currently, we only support 32-byte commitment values.</div><div id="293" class="line none">  293     // Anything else we'll just return false.</div><div id="294" class="line none">  294     if (a-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != 32) return false;</div><div id="295" class="line none">  295 </div><div id="296" class="line none">  296     uintptr_t accum = 0;</div><div id="297" class="line none">  297 </div><div id="298" class="line none">  298     // If written using a byte-by-byte comparison to support arbitrary length</div><div id="299" class="line none">  299     // buffers, then this compiles to a very complex SIMD/unrolled loop on</div><div id="300" class="line none">  300     // which it is difficult to verify constant-time behavior. This</div><div id="301" class="line none">  301     // implementation instead results in very compact output which can be</div><div id="302" class="line none">  302     // easily seen to be constant time.</div><div id="303" class="line none">  303     assert((32 % sizeof(uintptr_t)) == 0);</div><div id="304" class="line none">  304     for (size_t i = 0; i &lt; (32 / sizeof(uintptr_t)); i++) {</div><div id="305" class="line none">  305         // Deal with architectures which don't support unaligned accesses.</div><div id="306" class="line none">  306         // On x86 and ARMv7+, this memcpy is optimized out.</div><div id="307" class="line none">  307         uintptr_t tmp_a, tmp_b;</div><div id="308" class="line none">  308         memcpy(&amp;tmp_a, a-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + i * sizeof(uintptr_t), sizeof(tmp_a));</div><div id="309" class="line none">  309         memcpy(&amp;tmp_b, b-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + i * sizeof(uintptr_t), sizeof(tmp_b));</div><div id="310" class="line none">  310 </div><div id="311" class="line none">  311         accum |= tmp_a ^ tmp_b;</div><div id="312" class="line none">  312     }</div><div id="313" class="line none">  313 </div><div id="314" class="line none">  314     // We assume uintptr_t compare is constant time, or at least that all non-zero</div><div id="315" class="line none">  315     // values take equal time to compare to zero.</div><div id="316" class="line none">  316     return accum == 0;</div><div id="317" class="line none">  317 }</div><div id="318" class="line none">  318 </div><div id="319" class="line none">  319 static int <a href="cipher.c.html#319">aws_cryptosdk_private_derive_key_v1</a>(</div><div id="320" class="line none">  320     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="321" class="line none">  321     struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>,</div><div id="322" class="line none">  322     const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>,</div><div id="323" class="line none">  323     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>) {</div><div id="324" class="line none">  324     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="325" class="line none">  325     AWS_PRECONDITION(<a href="cipher.c.html#1060">aws_cryptosdk_content_key_is_valid</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>));</div><div id="326" class="line none">  326     AWS_PRECONDITION(<a href="cipher.c.html#1056">aws_cryptosdk_data_key_is_valid</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>));</div><div id="327" class="line none">  327     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>));</div><div id="328" class="line none">  328 </div><div id="329" class="line none">  329     if (<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher.c.html#30">MSG_ID_LEN</a>) {</div><div id="330" class="line none">  330         return AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT;</div><div id="331" class="line none">  331     }</div><div id="332" class="line none">  332 </div><div id="333" class="line none">  333     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, sizeof(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>));</div><div id="334" class="line none">  334     uint8_t info[<a href="cipher.c.html#30">MSG_ID_LEN</a> + 2];</div><div id="335" class="line none">  335     uint16_t <a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a> = <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>;</div><div id="336" class="line none">  336     info[0]         = <a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a> &gt;&gt; 8;</div><div id="337" class="line none">  337     info[1]         = <a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a> &amp; 0xFF;</div><div id="338" class="line none">  338     memcpy(&amp;info[2], <a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, sizeof(info) - 2);</div><div id="339" class="line none">  339     enum <a href="../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> which_sha = <a href="cipher.c.html#239">aws_cryptosdk_which_sha</a>(<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>);</div><div id="340" class="line none">  340     if (which_sha == <a href="../include/aws/cryptosdk/private/hkdf.h.html#22">AWS_CRYPTOSDK_NOSHA</a>) {</div><div id="341" class="line none">  341         memcpy(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#70">data_key_len</a>);</div><div id="342" class="line none">  342         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="343" class="line none">  343     }</div><div id="344" class="line none">  344     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> myokm        = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#75">content_key_len</a>);</div><div id="345" class="line none">  345     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> mysalt = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#900">aws_byte_buf_from_c_str</a>("");</div><div id="346" class="line none">  346     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> myikm  = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#70">data_key_len</a>);</div><div id="347" class="line none">  347     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> myinfo = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(info, sizeof(info));</div><div id="348" class="line none">  348     int ret                          = <a href="hkdf.c.html#148">aws_cryptosdk_hkdf</a>(&amp;myokm, which_sha, &amp;mysalt, &amp;myikm, &amp;myinfo);</div><div id="349" class="line none">  349     return ret;</div><div id="350" class="line none">  350 }</div><div id="351" class="line none">  351 </div><div id="352" class="line none">  352 static int <a href="cipher.c.html#352">aws_cryptosdk_private_derive_key_v2</a>(</div><div id="353" class="line none">  353     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="354" class="line none">  354     struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>,</div><div id="355" class="line none">  355     const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>,</div><div id="356" class="line none">  356     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *commitment,</div><div id="357" class="line none">  357     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>) {</div><div id="358" class="line hit">  358     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="359" class="line hit">  359     AWS_PRECONDITION(<a href="cipher.c.html#1060">aws_cryptosdk_content_key_is_valid</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>));</div><div id="360" class="line hit">  360     AWS_PRECONDITION(<a href="cipher.c.html#1056">aws_cryptosdk_data_key_is_valid</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>));</div><div id="361" class="line hit">  361     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(commitment));</div><div id="362" class="line hit">  362     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>));</div><div id="363" class="line none">  363 </div><div id="364" class="line hit">  364     if (commitment-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a> &lt; <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#109">commitment_len</a>) {</div><div id="365" class="line hit">  365         return AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="366" class="line none">  366     }</div><div id="367" class="line none">  367 </div><div id="368" class="line hit">  368     if (<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher.c.html#31">MSG_ID_LEN_V2</a>) {</div><div id="369" class="line hit">  369         return AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT;</div><div id="370" class="line none">  370     }</div><div id="371" class="line none">  371 </div><div id="372" class="line hit">  372     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> mysalt = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="373" class="line hit">  373     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> myikm  = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#70">data_key_len</a>);</div><div id="374" class="line none">  374 </div><div id="375" class="line hit">  375     memset(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, 0, sizeof(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>));</div><div id="376" class="line hit">  376     if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#109">commitment_len</a>) {</div><div id="377" class="line hit">  377         assert(commitment-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>);</div><div id="378" class="line hit">  378         memset(commitment-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, 0, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#109">commitment_len</a>);</div><div id="379" class="line none">  379     }</div><div id="380" class="line none">  380 </div><div id="381" class="line hit">  381     uint8_t derivekey_info_array[] = "\0\0DERIVEKEY";</div><div id="382" class="line hit">  382     derivekey_info_array[0]        = <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a> &gt;&gt; 8;</div><div id="383" class="line hit">  383     derivekey_info_array[1]        = <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a> &amp; 0xFF;</div><div id="384" class="line none">  384 </div><div id="385" class="line hit">  385     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> derivekey_info =</div><div id="386" class="line hit">  386         <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(derivekey_info_array, sizeof(derivekey_info_array) - 1);</div><div id="387" class="line none">  387 </div><div id="388" class="line none">  388     static const uint8_t commitkey_info_array[] = "COMMITKEY";</div><div id="389" class="line hit">  389     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> commitkey_info =</div><div id="390" class="line hit">  390         <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(commitkey_info_array, sizeof(commitkey_info_array) - 1);</div><div id="391" class="line none">  391 </div><div id="392" class="line hit">  392     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> myokm = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#75">content_key_len</a>);</div><div id="393" class="line none">  393 </div><div id="394" class="line hit">  394     enum <a href="../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> which_sha = <a href="cipher.c.html#239">aws_cryptosdk_which_sha</a>(<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>);</div><div id="395" class="line hit">  395     if (which_sha == <a href="../include/aws/cryptosdk/private/hkdf.h.html#22">AWS_CRYPTOSDK_NOSHA</a>) {</div><div id="396" class="line hit">  396         return AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT;</div><div id="397" class="line none">  397     }</div><div id="398" class="line none">  398 </div><div id="399" class="line hit">  399     commitment-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#109">commitment_len</a>;</div><div id="400" class="line hit">  400     int rv          = <a href="hkdf.c.html#148">aws_cryptosdk_hkdf</a>(commitment, which_sha, &amp;mysalt, &amp;myikm, &amp;commitkey_info);</div><div id="401" class="line hit">  401     if (rv != <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#144">AWS_ERROR_SUCCESS</a>) {</div><div id="402" class="line hit">  402         return rv;</div><div id="403" class="line none">  403     }</div><div id="404" class="line none">  404 </div><div id="405" class="line hit">  405     return <a href="hkdf.c.html#148">aws_cryptosdk_hkdf</a>(&amp;myokm, which_sha, &amp;mysalt, &amp;myikm, &amp;derivekey_info);</div><div id="406" class="line hit">  406 }</div><div id="407" class="line none">  407 </div><div id="408" class="line none">  408 int <a href="cipher.c.html#408">aws_cryptosdk_private_derive_key</a>(</div><div id="409" class="line none">  409     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="410" class="line none">  410     struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>,</div><div id="411" class="line none">  411     const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>,</div><div id="412" class="line none">  412     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *commitment,</div><div id="413" class="line none">  413     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>) {</div><div id="414" class="line none">  414     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="415" class="line none">  415     AWS_PRECONDITION(<a href="cipher.c.html#1060">aws_cryptosdk_content_key_is_valid</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>));</div><div id="416" class="line none">  416     AWS_PRECONDITION(<a href="cipher.c.html#1056">aws_cryptosdk_data_key_is_valid</a>(<a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>));</div><div id="417" class="line none">  417     if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a> == <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_2_0</a>) {</div><div id="418" class="line none">  418         AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(commitment));</div><div id="419" class="line none">  419     }</div><div id="420" class="line none">  420     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>));</div><div id="421" class="line none">  421 </div><div id="422" class="line none">  422     if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a> == <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>) {</div><div id="423" class="line none">  423         if (commitment-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != 0) {</div><div id="424" class="line none">  424             return AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="425" class="line none">  425         }</div><div id="426" class="line none">  426 </div><div id="427" class="line none">  427         return <a href="cipher.c.html#319">aws_cryptosdk_private_derive_key_v1</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>);</div><div id="428" class="line none">  428     } else if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a> == <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_2_0</a>) {</div><div id="429" class="line none">  429         return <a href="cipher.c.html#352">aws_cryptosdk_private_derive_key_v2</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>, commitment, <a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>);</div><div id="430" class="line none">  430     } else {</div><div id="431" class="line none">  431         return AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT;</div><div id="432" class="line none">  432     }</div><div id="433" class="line none">  433 }</div><div id="434" class="line none">  434 </div><div id="435" class="line none">  435 static <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher.c.html#435">evp_gcm_cipher_init</a>(</div><div id="436" class="line none">  436     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="437" class="line none">  437     const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>,</div><div id="438" class="line none">  438     const uint8_t *<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>,</div><div id="439" class="line none">  439     bool enc) {</div><div id="440" class="line none">  440     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a> = NULL;</div><div id="441" class="line none">  441 </div><div id="442" class="line none">  442     if (!(<a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#449">EVP_CIPHER_CTX_new</a>())) goto err;</div><div id="443" class="line none">  443     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#468">EVP_CipherInit_ex</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#28">cipher_ctor</a>(), NULL, NULL, NULL, (int)enc)) goto err;  // cast for CBMC</div><div id="444" class="line none">  444     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#494">EVP_CIPHER_CTX_ctrl</a>(<a href="cipher_openssl.c.html#78">ctx</a>, EVP_CTRL_GCM_SET_IVLEN, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a>, NULL)) goto err;</div><div id="445" class="line none">  445     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#468">EVP_CipherInit_ex</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, NULL, <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>, -1)) goto err;</div><div id="446" class="line none">  446 </div><div id="447" class="line none">  447     return <a href="cipher_openssl.c.html#78">ctx</a>;</div><div id="448" class="line none">  448 </div><div id="449" class="line none">  449 err:</div><div id="450" class="line none">  450     if (<a href="cipher_openssl.c.html#78">ctx</a>) {</div><div id="451" class="line none">  451         <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="452" class="line none">  452     }</div><div id="453" class="line none">  453     return NULL;</div><div id="454" class="line none">  454 }</div><div id="455" class="line none">  455 </div><div id="456" class="line none">  456 static int <a href="cipher.c.html#456">evp_gcm_encrypt_final</a>(const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>, <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a>, uint8_t *tag) {</div><div id="457" class="line none">  457     int outlen;</div><div id="458" class="line none">  458     uint8_t finalbuf;</div><div id="459" class="line none">  459 </div><div id="460" class="line none">  460     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#657">EVP_EncryptFinal_ex</a>(<a href="cipher_openssl.c.html#78">ctx</a>, &amp;finalbuf, &amp;outlen)) {</div><div id="461" class="line none">  461         return AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="462" class="line none">  462     }</div><div id="463" class="line none">  463 </div><div id="464" class="line none">  464     AWS_FATAL_POSTCONDITION(outlen == 0);  // wrong output size - potentially smashed stack</div><div id="465" class="line none">  465 </div><div id="466" class="line none">  466     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#494">EVP_CIPHER_CTX_ctrl</a>(<a href="cipher_openssl.c.html#78">ctx</a>, EVP_CTRL_GCM_GET_TAG, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>, (void *)tag)) {</div><div id="467" class="line none">  467         return AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="468" class="line none">  468     }</div><div id="469" class="line none">  469 </div><div id="470" class="line none">  470     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#144">AWS_ERROR_SUCCESS</a>;</div><div id="471" class="line none">  471 }</div><div id="472" class="line none">  472 </div><div id="473" class="line none">  473 static inline void <a href="cipher.c.html#473">flush_openssl_errors</a>() {</div><div id="474" class="line none">  474     while (<a href="../verification/cbmc/include/openssl/err.h.html#24">ERR_get_error</a>() != 0) {</div><div id="475" class="line none">  475     }</div><div id="476" class="line none">  476 }</div><div id="477" class="line none">  477 </div><div id="478" class="line none">  478 static int <a href="cipher.c.html#478">evp_gcm_decrypt_final</a>(</div><div id="479" class="line none">  479     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>, <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a>, const uint8_t *tag) {</div><div id="480" class="line none">  480     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#494">EVP_CIPHER_CTX_ctrl</a>(<a href="cipher_openssl.c.html#78">ctx</a>, EVP_CTRL_GCM_SET_TAG, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>, (void *)tag)) {</div><div id="481" class="line none">  481         return AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="482" class="line none">  482     }</div><div id="483" class="line none">  483 </div><div id="484" class="line none">  484     /*</div><div id="485" class="line none">  485      * Flush all error codes; if the GCM tag is invalid, openssl will fail without generating</div><div id="486" class="line none">  486      * an error code, so any leftover error codes will get in the way of detection.</div><div id="487" class="line none">  487      */</div><div id="488" class="line none">  488     <a href="cipher.c.html#473">flush_openssl_errors</a>();</div><div id="489" class="line none">  489 </div><div id="490" class="line none">  490     int outlen;</div><div id="491" class="line none">  491     uint8_t finalbuf;</div><div id="492" class="line none">  492 </div><div id="493" class="line none">  493     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#675">EVP_DecryptFinal_ex</a>(<a href="cipher_openssl.c.html#78">ctx</a>, &amp;finalbuf, &amp;outlen)) {</div><div id="494" class="line none">  494         if (<a href="../verification/cbmc/include/openssl/err.h.html#26">ERR_peek_last_error</a>() == 0) {</div><div id="495" class="line none">  495             return AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT;</div><div id="496" class="line none">  496         }</div><div id="497" class="line none">  497         return AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="498" class="line none">  498     }</div><div id="499" class="line none">  499     AWS_FATAL_POSTCONDITION(outlen == 0);  // wrong output size - potentially smashed stack</div><div id="500" class="line none">  500 </div><div id="501" class="line none">  501     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#144">AWS_ERROR_SUCCESS</a>;</div><div id="502" class="line none">  502 }</div><div id="503" class="line none">  503 </div><div id="504" class="line none">  504 int <a href="cipher.c.html#504">aws_cryptosdk_sign_header</a>(</div><div id="505" class="line none">  505     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="506" class="line none">  506     const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>,</div><div id="507" class="line none">  507     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *authtag,</div><div id="508" class="line none">  508     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *header) {</div><div id="509" class="line none">  509     const uint8_t *<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>;</div><div id="510" class="line none">  510     uint8_t *tag;</div><div id="511" class="line none">  511 </div><div id="512" class="line none">  512     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="513" class="line none">  513 </div><div id="514" class="line none">  514     if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a> == <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>) {</div><div id="515" class="line none">  515         if (authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a> + <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>) {</div><div id="516" class="line none">  516             return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT);</div><div id="517" class="line none">  517         }</div><div id="518" class="line none">  518         uint8_t *mut_iv = authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="519" class="line none">  519 </div><div id="520" class="line none">  520         /*</div><div id="521" class="line none">  521          * Currently, we use a deterministic IV generation algorithm;</div><div id="522" class="line none">  522          * the header IV is always all-zero.</div><div id="523" class="line none">  523          */</div><div id="524" class="line none">  524         <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(mut_iv, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a>);</div><div id="525" class="line none">  525         <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a> = mut_iv;</div><div id="526" class="line none">  526 </div><div id="527" class="line none">  527         tag = authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a>;</div><div id="528" class="line none">  528     } else if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a> == <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_2_0</a>) {</div><div id="529" class="line none">  529         static const uint8_t ZERO_IV[12] = { 0 };</div><div id="530" class="line none">  530 </div><div id="531" class="line none">  531         if (authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>) {</div><div id="532" class="line none">  532             return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT);</div><div id="533" class="line none">  533         }</div><div id="534" class="line none">  534 </div><div id="535" class="line none">  535         /*</div><div id="536" class="line none">  536          * In the V2 header format, the IV is defined to be zero for the header.</div><div id="537" class="line none">  537          */</div><div id="538" class="line none">  538         <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>  = ZERO_IV;</div><div id="539" class="line none">  539         tag = authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="540" class="line none">  540     } else {</div><div id="541" class="line none">  541         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="542" class="line none">  542     }</div><div id="543" class="line none">  543 </div><div id="544" class="line none">  544     int result          = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="545" class="line none">  545     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a> = <a href="cipher.c.html#435">evp_gcm_cipher_init</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>, true);</div><div id="546" class="line none">  546     if (!<a href="cipher_openssl.c.html#78">ctx</a>) goto out;</div><div id="547" class="line none">  547 </div><div id="548" class="line none">  548     int outlen;</div><div id="549" class="line none">  549     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#583">EVP_EncryptUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;outlen, header-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, header-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto out;</div><div id="550" class="line none">  550 </div><div id="551" class="line none">  551     result = <a href="cipher.c.html#456">evp_gcm_encrypt_final</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="cipher_openssl.c.html#78">ctx</a>, tag);</div><div id="552" class="line none">  552 </div><div id="553" class="line none">  553 out:</div><div id="554" class="line none">  554     if (<a href="cipher_openssl.c.html#78">ctx</a>) <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="555" class="line none">  555 </div><div id="556" class="line none">  556     if (result == <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#144">AWS_ERROR_SUCCESS</a>) {</div><div id="557" class="line none">  557         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="558" class="line none">  558     } else {</div><div id="559" class="line none">  559         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(result);</div><div id="560" class="line none">  560     }</div><div id="561" class="line none">  561 }</div><div id="562" class="line none">  562 </div><div id="563" class="line none">  563 int <a href="cipher.c.html#563">aws_cryptosdk_verify_header</a>(</div><div id="564" class="line none">  564     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="565" class="line none">  565     const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>,</div><div id="566" class="line none">  566     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *authtag,</div><div id="567" class="line none">  567     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *header) {</div><div id="568" class="line none">  568     /*</div><div id="569" class="line none">  569      * Note: We don't delegate to sign_header here, as we want to leave the</div><div id="570" class="line none">  570      * GCM tag comparison (which needs to be constant-time) to openssl.</div><div id="571" class="line none">  571      */</div><div id="572" class="line none">  572 </div><div id="573" class="line none">  573     const uint8_t *<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>, *tag;</div><div id="574" class="line none">  574 </div><div id="575" class="line none">  575     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="576" class="line none">  576 </div><div id="577" class="line none">  577     if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a> == <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_1_0</a>) {</div><div id="578" class="line none">  578         if (authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a> + <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>) {</div><div id="579" class="line none">  579             return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT);</div><div id="580" class="line none">  580         }</div><div id="581" class="line none">  581         <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>  = authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="582" class="line none">  582         tag = authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a>;</div><div id="583" class="line none">  583     } else if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#98">msg_format_version</a> == <a href="../include/aws/cryptosdk/header.h.html#40">AWS_CRYPTOSDK_HEADER_VERSION_2_0</a>) {</div><div id="584" class="line none">  584         static const uint8_t ZERO_IV[12] = { 0 };</div><div id="585" class="line none">  585 </div><div id="586" class="line none">  586         if (authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>) {</div><div id="587" class="line none">  587             return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT);</div><div id="588" class="line none">  588         }</div><div id="589" class="line none">  589 </div><div id="590" class="line none">  590         <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>  = ZERO_IV;</div><div id="591" class="line none">  591         tag = authtag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="592" class="line none">  592     } else {</div><div id="593" class="line none">  593         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="594" class="line none">  594     }</div><div id="595" class="line none">  595 </div><div id="596" class="line none">  596     int result = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="597" class="line none">  597 </div><div id="598" class="line none">  598     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a> = <a href="cipher.c.html#435">evp_gcm_cipher_init</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>, false);</div><div id="599" class="line none">  599     if (!<a href="cipher_openssl.c.html#78">ctx</a>) goto out;</div><div id="600" class="line none">  600 </div><div id="601" class="line none">  601     int outlen;</div><div id="602" class="line none">  602     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#619">EVP_DecryptUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;outlen, header-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, header-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto out;</div><div id="603" class="line none">  603 </div><div id="604" class="line none">  604     result = <a href="cipher.c.html#478">evp_gcm_decrypt_final</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="cipher_openssl.c.html#78">ctx</a>, tag);</div><div id="605" class="line none">  605 out:</div><div id="606" class="line none">  606     if (<a href="cipher_openssl.c.html#78">ctx</a>) <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="607" class="line none">  607 </div><div id="608" class="line none">  608     if (result == <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#144">AWS_ERROR_SUCCESS</a>) {</div><div id="609" class="line none">  609         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="610" class="line none">  610     } else {</div><div id="611" class="line none">  611         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(result);</div><div id="612" class="line none">  612     }</div><div id="613" class="line none">  613 }</div><div id="614" class="line none">  614 </div><div id="615" class="line none">  615 static int <a href="cipher.c.html#615">update_frame_aad</a>(</div><div id="616" class="line none">  616     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a>,</div><div id="617" class="line none">  617     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>,</div><div id="618" class="line none">  618     int body_frame_type,</div><div id="619" class="line none">  619     uint32_t seqno,</div><div id="620" class="line none">  620     uint64_t data_size) {</div><div id="621" class="line none">  621     const char *aad_string;</div><div id="622" class="line none">  622 </div><div id="623" class="line none">  623     switch (body_frame_type) {</div><div id="624" class="line none">  624         case <a href="../include/aws/cryptosdk/private/cipher.h.html#117">FRAME_TYPE_SINGLE</a>: aad_string = "AWSKMSEncryptionClient Single Block"; break;</div><div id="625" class="line none">  625         case <a href="../include/aws/cryptosdk/private/cipher.h.html#117">FRAME_TYPE_FRAME</a>: aad_string = "AWSKMSEncryptionClient Frame"; break;</div><div id="626" class="line none">  626         case <a href="../include/aws/cryptosdk/private/cipher.h.html#117">FRAME_TYPE_FINAL</a>: aad_string = "AWSKMSEncryptionClient Final Frame"; break;</div><div id="627" class="line none">  627         default: return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#146">AWS_ERROR_UNKNOWN</a>);</div><div id="628" class="line none">  628     }</div><div id="629" class="line none">  629 </div><div id="630" class="line none">  630     int ignored;</div><div id="631" class="line none">  631 </div><div id="632" class="line none">  632     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#568">EVP_CipherUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;ignored, <a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) return 0;</div><div id="633" class="line none">  633     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#568">EVP_CipherUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;ignored, (const uint8_t *)aad_string, strlen(aad_string))) return 0;</div><div id="634" class="line none">  634 </div><div id="635" class="line none">  635     seqno = <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_order.inl.html#61">aws_hton32</a>(seqno);</div><div id="636" class="line none">  636     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#568">EVP_CipherUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;ignored, (const uint8_t *)&amp;seqno, sizeof(seqno))) return 0;</div><div id="637" class="line none">  637 </div><div id="638" class="line none">  638     uint32_t <a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a>[2];</div><div id="639" class="line none">  639 </div><div id="640" class="line none">  640     <a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a>[0] = <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_order.inl.html#61">aws_hton32</a>(data_size &gt;&gt; 32);</div><div id="641" class="line none">  641     <a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a>[1] = <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_order.inl.html#61">aws_hton32</a>(data_size &amp; 0xFFFFFFFFUL);</div><div id="642" class="line none">  642 </div><div id="643" class="line none">  643     return <a href="../verification/cbmc/sources/openssl/evp_override.c.html#568">EVP_CipherUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;ignored, (const uint8_t *)<a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a>, sizeof(<a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a>));</div><div id="644" class="line none">  644 }</div><div id="645" class="line none">  645 </div><div id="646" class="line none">  646 int <a href="cipher.c.html#646">aws_cryptosdk_encrypt_body</a>(</div><div id="647" class="line none">  647     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="648" class="line none">  648     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *outp,</div><div id="649" class="line none">  649     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *inp,</div><div id="650" class="line none">  650     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>,</div><div id="651" class="line none">  651     uint32_t seqno,</div><div id="652" class="line none">  652     uint8_t *<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>,</div><div id="653" class="line none">  653     const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>,</div><div id="654" class="line none">  654     uint8_t *tag,</div><div id="655" class="line none">  655     int body_frame_type) {</div><div id="656" class="line none">  656     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="657" class="line none">  657     AWS_PRECONDITION(</div><div id="658" class="line none">  658         <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(outp) ||</div><div id="659" class="line none">  659         /* This happens when outp comes from a frame, which input plaintext_size was 0. */</div><div id="660" class="line none">  660         (outp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> == 0 &amp;&amp; outp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a> == 0 &amp;&amp; outp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>));</div><div id="661" class="line none">  661     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(inp));</div><div id="662" class="line none">  662     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>));</div><div id="663" class="line none">  663     AWS_PRECONDITION(<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a> != NULL);</div><div id="664" class="line none">  664     AWS_PRECONDITION(tag != NULL);</div><div id="665" class="line none">  665     AWS_PRECONDITION(AWS_MEM_IS_WRITABLE(tag, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>));</div><div id="666" class="line none">  666     if (inp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != outp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a>) {</div><div id="667" class="line none">  667         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#147">AWS_ERROR_SHORT_BUFFER</a>);</div><div id="668" class="line none">  668     }</div><div id="669" class="line none">  669 </div><div id="670" class="line none">  670     /*</div><div id="671" class="line none">  671      * We use a deterministic IV generation algorithm; the frame sequence number</div><div id="672" class="line none">  672      * is used for the IV. To avoid collisions with the header IV, seqno=0 is</div><div id="673" class="line none">  673      * forbidden.</div><div id="674" class="line none">  674      */</div><div id="675" class="line none">  675     if (seqno == 0) {</div><div id="676" class="line none">  676         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="677" class="line none">  677     }</div><div id="678" class="line none">  678 </div><div id="679" class="line none">  679     uint64_t iv_seq = <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_order.inl.html#34">aws_hton64</a>(seqno);</div><div id="680" class="line none">  680 </div><div id="681" class="line none">  681     /*</div><div id="682" class="line none">  682      * Paranoid check to make sure we're not going to walk off the end of the IV</div><div id="683" class="line none">  683      * buffer if someone in the future introduces an algorithm with a really small</div><div id="684" class="line none">  684      * IV for some reason.</div><div id="685" class="line none">  685      */</div><div id="686" class="line none">  686     if (<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a> &lt; sizeof(iv_seq)) {</div><div id="687" class="line none">  687         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="688" class="line none">  688     }</div><div id="689" class="line none">  689 </div><div id="690" class="line none">  690     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a>);</div><div id="691" class="line none">  691 </div><div id="692" class="line none">  692     uint8_t *iv_seq_p = <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a> + <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#77">iv_len</a> - sizeof(iv_seq);</div><div id="693" class="line none">  693     memcpy(iv_seq_p, &amp;iv_seq, sizeof(iv_seq));</div><div id="694" class="line none">  694 </div><div id="695" class="line none">  695     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a> = NULL;</div><div id="696" class="line none">  696 </div><div id="697" class="line none">  697     int result = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="698" class="line none">  698 </div><div id="699" class="line none">  699     if (!(<a href="cipher_openssl.c.html#78">ctx</a> = <a href="cipher.c.html#435">evp_gcm_cipher_init</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>, true))) goto out;</div><div id="700" class="line none">  700     if (!<a href="cipher.c.html#615">update_frame_aad</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>, body_frame_type, seqno, inp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto out;</div><div id="701" class="line none">  701 </div><div id="702" class="line none">  702     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> outbuf    = *outp;</div><div id="703" class="line none">  703     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> incurs = *inp;</div><div id="704" class="line none">  704 </div><div id="705" class="line none">  705     while (incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="706" class="line none">  706         if (incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != outbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a> - outbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="707" class="line none">  707             /*</div><div id="708" class="line none">  708              * None of the algorithms we currently support should break this invariant.</div><div id="709" class="line none">  709              * Bail out immediately with an unknown error.</div><div id="710" class="line none">  710              */</div><div id="711" class="line none">  711             goto out;</div><div id="712" class="line none">  712         }</div><div id="713" class="line none">  713 </div><div id="714" class="line none">  714         int in_len = incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> &gt; INT_MAX ? INT_MAX : incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>;</div><div id="715" class="line none">  715         int ct_len;</div><div id="716" class="line none">  716 </div><div id="717" class="line none">  717         if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#583">EVP_EncryptUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, outbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + outbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>, &amp;ct_len, incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, in_len)) goto out;</div><div id="718" class="line none">  718         /*</div><div id="719" class="line none">  719          * The next two advances should never fail ... but check the return values</div><div id="720" class="line none">  720          * just in case.</div><div id="721" class="line none">  721          */</div><div id="722" class="line none">  722         if (!<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#1069">aws_byte_cursor_advance_nospec</a>(&amp;incurs, in_len).<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>) goto out;</div><div id="723" class="line none">  723 </div><div id="724" class="line none">  724         if (<a href="../verification/cbmc/aws-c-common/include/aws/common/math.inl.html#126">aws_add_size_checked</a>(outbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>, ct_len, &amp;outbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto out;</div><div id="725" class="line none">  725 </div><div id="726" class="line none">  726         if (outbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a> &lt; outbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="727" class="line none">  727             /* Somehow we ran over the output buffer. abort() to limit the damage. */</div><div id="728" class="line none">  728             <a href="../verification/cbmc/aws-c-common/verification/cbmc/stubs/abort_override_assert_false.c.html#14">abort</a>();</div><div id="729" class="line none">  729         }</div><div id="730" class="line none">  730     }</div><div id="731" class="line none">  731 </div><div id="732" class="line none">  732     result = <a href="cipher.c.html#456">evp_gcm_encrypt_final</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="cipher_openssl.c.html#78">ctx</a>, tag);</div><div id="733" class="line none">  733 </div><div id="734" class="line none">  734 out:</div><div id="735" class="line none">  735     if (<a href="cipher_openssl.c.html#78">ctx</a>) <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="736" class="line none">  736 </div><div id="737" class="line none">  737     if (result == <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#144">AWS_ERROR_SUCCESS</a>) {</div><div id="738" class="line none">  738         *outp = outbuf;</div><div id="739" class="line none">  739         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="740" class="line none">  740     } else {</div><div id="741" class="line none">  741         <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#87">aws_byte_buf_secure_zero</a>(outp);</div><div id="742" class="line none">  742         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(result);</div><div id="743" class="line none">  743     }</div><div id="744" class="line none">  744 }</div><div id="745" class="line none">  745 </div><div id="746" class="line none">  746 int <a href="cipher.c.html#746">aws_cryptosdk_decrypt_body</a>(</div><div id="747" class="line none">  747     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="748" class="line none">  748     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *outp,</div><div id="749" class="line none">  749     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *inp,</div><div id="750" class="line none">  750     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>,</div><div id="751" class="line none">  751     uint32_t seqno,</div><div id="752" class="line none">  752     const uint8_t *<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>,</div><div id="753" class="line none">  753     const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>,</div><div id="754" class="line none">  754     const uint8_t *tag,</div><div id="755" class="line none">  755     int body_frame_type) {</div><div id="756" class="line none">  756     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="757" class="line none">  757     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(outp));</div><div id="758" class="line none">  758     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(inp));</div><div id="759" class="line none">  759     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>));</div><div id="760" class="line none">  760     AWS_PRECONDITION(<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a> != NULL);</div><div id="761" class="line none">  761     AWS_PRECONDITION(tag != NULL);</div><div id="762" class="line none">  762     AWS_PRECONDITION(AWS_MEM_IS_WRITABLE(tag, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#83">tag_len</a>));</div><div id="763" class="line none">  763     if (inp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != outp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a> - outp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="764" class="line none">  764         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#147">AWS_ERROR_SHORT_BUFFER</a>);</div><div id="765" class="line none">  765     }</div><div id="766" class="line none">  766 </div><div id="767" class="line none">  767     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a>           = NULL;</div><div id="768" class="line none">  768     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> outcurs   = *outp;</div><div id="769" class="line none">  769     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> incurs = *inp;</div><div id="770" class="line none">  770     int result                    = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="771" class="line none">  771 </div><div id="772" class="line none">  772     if (!(<a href="cipher_openssl.c.html#78">ctx</a> = <a href="cipher.c.html#435">evp_gcm_cipher_init</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>, false))) goto out;</div><div id="773" class="line none">  773 </div><div id="774" class="line none">  774     if (!<a href="cipher.c.html#615">update_frame_aad</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../include/aws/cryptosdk/private/header.h.html#31">message_id</a>, body_frame_type, seqno, inp-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto out;</div><div id="775" class="line none">  775 </div><div id="776" class="line none">  776     while (incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="777" class="line none">  777         int in_len = incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> &gt; INT_MAX ? INT_MAX : incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>;</div><div id="778" class="line none">  778         int pt_len;</div><div id="779" class="line none">  779 </div><div id="780" class="line none">  780         if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#619">EVP_DecryptUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, outcurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + outcurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>, &amp;pt_len, incurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, in_len)) goto out;</div><div id="781" class="line none">  781         /*</div><div id="782" class="line none">  782          * The next two advances should never fail ... but check the return values</div><div id="783" class="line none">  783          * just in case.</div><div id="784" class="line none">  784          */</div><div id="785" class="line none">  785         if (!<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#1069">aws_byte_cursor_advance_nospec</a>(&amp;incurs, in_len).<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>) goto out;</div><div id="786" class="line none">  786 </div><div id="787" class="line none">  787         if (<a href="../verification/cbmc/aws-c-common/include/aws/common/math.inl.html#126">aws_add_size_checked</a>(outcurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>, pt_len, &amp;outcurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto out;</div><div id="788" class="line none">  788 </div><div id="789" class="line none">  789         if (outcurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> &gt; outcurs.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a>) {</div><div id="790" class="line none">  790             /* Somehow we ran over the output buffer. abort() to limit the damage. */</div><div id="791" class="line none">  791             <a href="../verification/cbmc/aws-c-common/verification/cbmc/stubs/abort_override_assert_false.c.html#14">abort</a>();</div><div id="792" class="line none">  792         }</div><div id="793" class="line none">  793     }</div><div id="794" class="line none">  794 </div><div id="795" class="line none">  795     result = <a href="cipher.c.html#478">evp_gcm_decrypt_final</a>(<a href="cipher_openssl.c.html#75">props</a>, <a href="cipher_openssl.c.html#78">ctx</a>, tag);</div><div id="796" class="line none">  796 out:</div><div id="797" class="line none">  797     if (<a href="cipher_openssl.c.html#78">ctx</a>) <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="798" class="line none">  798 </div><div id="799" class="line none">  799     if (result == <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#144">AWS_ERROR_SUCCESS</a>) {</div><div id="800" class="line none">  800         *outp = outcurs;</div><div id="801" class="line none">  801         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="802" class="line none">  802     } else {</div><div id="803" class="line none">  803         <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#87">aws_byte_buf_secure_zero</a>(outp);</div><div id="804" class="line none">  804         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(result);</div><div id="805" class="line none">  805     }</div><div id="806" class="line none">  806 }</div><div id="807" class="line none">  807 </div><div id="808" class="line none">  808 int <a href="cipher.c.html#808">aws_cryptosdk_genrandom</a>(uint8_t *buf, size_t <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="809" class="line none">  809     AWS_FATAL_PRECONDITION(AWS_MEM_IS_WRITABLE(buf, <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>));</div><div id="810" class="line none">  810 </div><div id="811" class="line none">  811     if (<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> == 0) {</div><div id="812" class="line none">  812         return 0;</div><div id="813" class="line none">  813     }</div><div id="814" class="line none">  814     int rc = <a href="cipher.c.html#814">RAND_bytes</a>(buf, <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="815" class="line none">  815 </div><div id="816" class="line none">  816     if (rc != 1) {</div><div id="817" class="line none">  817         <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(buf, <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="818" class="line none">  818         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="819" class="line none">  819     }</div><div id="820" class="line none">  820 </div><div id="821" class="line none">  821     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="822" class="line none">  822 }</div><div id="823" class="line none">  823 </div><div id="824" class="line none">  824 static const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#38">EVP_CIPHER</a> *<a href="cipher.c.html#824">get_alg_from_key_size</a>(size_t key_len) {</div><div id="825" class="line none">  825     switch (key_len) {</div><div id="826" class="line none">  826         case <a href="../include/aws/cryptosdk/cipher.h.html#36">AWS_CRYPTOSDK_AES128</a>: return <a href="../verification/cbmc/sources/openssl/evp_override.c.html#421">EVP_aes_128_gcm</a>();</div><div id="827" class="line none">  827         case <a href="../include/aws/cryptosdk/cipher.h.html#37">AWS_CRYPTOSDK_AES192</a>: return <a href="../verification/cbmc/sources/openssl/evp_override.c.html#425">EVP_aes_192_gcm</a>();</div><div id="828" class="line none">  828         case <a href="../include/aws/cryptosdk/cipher.h.html#38">AWS_CRYPTOSDK_AES256</a>: return <a href="../verification/cbmc/sources/openssl/evp_override.c.html#429">EVP_aes_256_gcm</a>();</div><div id="829" class="line none">  829         default: return NULL;</div><div id="830" class="line none">  830     }</div><div id="831" class="line none">  831 }</div><div id="832" class="line none">  832 </div><div id="833" class="line none">  833 // These implementations of AES-GCM encryption/decryption only support these tag/IV lengths</div><div id="834" class="line none">  834 static const size_t <a href="cipher.c.html#834">aes_gcm_tag_len</a> = 16;</div><div id="835" class="line none">  835 static const size_t <a href="cipher.c.html#835">aes_gcm_iv_len</a>  = 12;</div><div id="836" class="line none">  836 </div><div id="837" class="line none">  837 int <a href="cipher.c.html#837">aws_cryptosdk_aes_gcm_encrypt</a>(</div><div id="838" class="line none">  838     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>,</div><div id="839" class="line none">  839     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *tag,</div><div id="840" class="line none">  840     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> plain,</div><div id="841" class="line none">  841     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>,</div><div id="842" class="line none">  842     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> aad,</div><div id="843" class="line none">  843     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>) {</div><div id="844" class="line none">  844     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>));</div><div id="845" class="line none">  845     AWS_PRECONDITION(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> != NULL);</div><div id="846" class="line none">  846     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(tag));</div><div id="847" class="line none">  847     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;plain));</div><div id="848" class="line none">  848     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>));</div><div id="849" class="line none">  849     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;aad));</div><div id="850" class="line none">  850     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>));</div><div id="851" class="line none">  851     const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#38">EVP_CIPHER</a> *<a href="../include/aws/cryptosdk/materials.h.html#182">alg</a> = <a href="cipher.c.html#824">get_alg_from_key_size</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="852" class="line none">  852     if (!<a href="../include/aws/cryptosdk/materials.h.html#182">alg</a> || <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher.c.html#835">aes_gcm_iv_len</a> || tag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a> &lt; <a href="cipher.c.html#834">aes_gcm_tag_len</a> || <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a> &lt; plain.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)</div><div id="853" class="line none">  853         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#150">AWS_ERROR_INVALID_BUFFER_SIZE</a>);</div><div id="854" class="line none">  854 </div><div id="855" class="line none">  855     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#449">EVP_CIPHER_CTX_new</a>();</div><div id="856" class="line none">  856     if (!<a href="cipher_openssl.c.html#78">ctx</a>) goto openssl_err;</div><div id="857" class="line none">  857 </div><div id="858" class="line none">  858     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#537">EVP_EncryptInit_ex</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../include/aws/cryptosdk/materials.h.html#182">alg</a>, NULL, <a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#15">aws_string_bytes</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>), <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>)) goto openssl_err;</div><div id="859" class="line none">  859 </div><div id="860" class="line none">  860     int out_len;</div><div id="861" class="line none">  861     if (aad.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="862" class="line none">  862         if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#583">EVP_EncryptUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;out_len, aad.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, aad.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto openssl_err;</div><div id="863" class="line none">  863     }</div><div id="864" class="line none">  864     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#583">EVP_EncryptUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, &amp;out_len, plain.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, plain.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto openssl_err;</div><div id="865" class="line none">  865     int prev_len = out_len;</div><div id="866" class="line none">  866 </div><div id="867" class="line none">  867     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#657">EVP_EncryptFinal_ex</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + out_len, &amp;out_len)) goto openssl_err;</div><div id="868" class="line none">  868     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#494">EVP_CIPHER_CTX_ctrl</a>(<a href="cipher_openssl.c.html#78">ctx</a>, EVP_CTRL_GCM_GET_TAG, <a href="cipher.c.html#834">aes_gcm_tag_len</a>, tag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>)) goto openssl_err;</div><div id="869" class="line none">  869 </div><div id="870" class="line none">  870     tag-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>    = <a href="cipher.c.html#834">aes_gcm_tag_len</a>;</div><div id="871" class="line none">  871     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = prev_len + out_len;</div><div id="872" class="line none">  872     assert(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> == plain.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="873" class="line none">  873     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="874" class="line none">  874     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="875" class="line none">  875 </div><div id="876" class="line none">  876 openssl_err:</div><div id="877" class="line none">  877     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="878" class="line none">  878     <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#87">aws_byte_buf_secure_zero</a>(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>);</div><div id="879" class="line none">  879     <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#87">aws_byte_buf_secure_zero</a>(tag);</div><div id="880" class="line none">  880     <a href="cipher.c.html#473">flush_openssl_errors</a>();</div><div id="881" class="line none">  881     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="882" class="line none">  882 }</div><div id="883" class="line none">  883 </div><div id="884" class="line none">  884 int <a href="cipher.c.html#884">aws_cryptosdk_aes_gcm_decrypt</a>(</div><div id="885" class="line none">  885     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *plain,</div><div id="886" class="line none">  886     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>,</div><div id="887" class="line none">  887     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> tag,</div><div id="888" class="line none">  888     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>,</div><div id="889" class="line none">  889     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> aad,</div><div id="890" class="line none">  890     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>) {</div><div id="891" class="line none">  891     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(plain));</div><div id="892" class="line none">  892     AWS_PRECONDITION(plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> != NULL);</div><div id="893" class="line none">  893     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>));</div><div id="894" class="line none">  894     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;tag));</div><div id="895" class="line none">  895     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;<a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>));</div><div id="896" class="line none">  896     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;aad));</div><div id="897" class="line none">  897     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>));</div><div id="898" class="line none">  898     bool openssl_err      = true;</div><div id="899" class="line none">  899     const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#38">EVP_CIPHER</a> *<a href="../include/aws/cryptosdk/materials.h.html#182">alg</a> = <a href="cipher.c.html#824">get_alg_from_key_size</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="900" class="line none">  900     if (!<a href="../include/aws/cryptosdk/materials.h.html#182">alg</a> || <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher.c.html#835">aes_gcm_iv_len</a> || tag.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher.c.html#834">aes_gcm_tag_len</a> || plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a> &lt; <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)</div><div id="901" class="line none">  901         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#150">AWS_ERROR_INVALID_BUFFER_SIZE</a>);</div><div id="902" class="line none">  902 </div><div id="903" class="line none">  903     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#39">EVP_CIPHER_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#449">EVP_CIPHER_CTX_new</a>();</div><div id="904" class="line none">  904     if (!<a href="cipher_openssl.c.html#78">ctx</a>) goto decrypt_err;</div><div id="905" class="line none">  905 </div><div id="906" class="line none">  906     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#550">EVP_DecryptInit_ex</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../include/aws/cryptosdk/materials.h.html#182">alg</a>, NULL, <a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#15">aws_string_bytes</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>), <a href="../include/aws/cryptosdk/private/header.h.html#31">iv</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>)) goto decrypt_err;</div><div id="907" class="line none">  907 </div><div id="908" class="line none">  908     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#494">EVP_CIPHER_CTX_ctrl</a>(<a href="cipher_openssl.c.html#78">ctx</a>, EVP_CTRL_GCM_SET_TAG, tag.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>, tag.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>)) goto decrypt_err;</div><div id="909" class="line none">  909 </div><div id="910" class="line none">  910     /* Setting the AAD. out_len here is a throwaway. Might be able to make that argument NULL, but</div><div id="911" class="line none">  911      * openssl wiki example does the same as this, giving it a pointer to an int and disregarding value.</div><div id="912" class="line none">  912      */</div><div id="913" class="line none">  913     int out_len;</div><div id="914" class="line none">  914     if (aad.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="915" class="line none">  915         if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#619">EVP_DecryptUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;out_len, aad.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, aad.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto decrypt_err;</div><div id="916" class="line none">  916     }</div><div id="917" class="line none">  917     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#619">EVP_DecryptUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>, plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, &amp;out_len, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) goto decrypt_err;</div><div id="918" class="line none">  918     int prev_len = out_len;</div><div id="919" class="line none">  919 </div><div id="920" class="line none">  920     /* Possible for EVP_DecryptFinal_ex to fail without generating an OpenSSL error code (e.g., tag</div><div id="921" class="line none">  921      * mismatch) so flush the errors first to distinguish this case.</div><div id="922" class="line none">  922      */</div><div id="923" class="line none">  923     <a href="cipher.c.html#473">flush_openssl_errors</a>();</div><div id="924" class="line none">  924     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#675">EVP_DecryptFinal_ex</a>(<a href="cipher_openssl.c.html#78">ctx</a>, plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a> + out_len, &amp;out_len)) {</div><div id="925" class="line none">  925         if (!<a href="../verification/cbmc/include/openssl/err.h.html#26">ERR_peek_last_error</a>()) openssl_err = false;</div><div id="926" class="line none">  926         goto decrypt_err;</div><div id="927" class="line none">  927     }</div><div id="928" class="line none">  928     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="929" class="line none">  929     plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = prev_len + out_len;</div><div id="930" class="line none">  930     assert(plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> == <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="931" class="line none">  931     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="932" class="line none">  932 </div><div id="933" class="line none">  933 decrypt_err:</div><div id="934" class="line none">  934     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#523">EVP_CIPHER_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="935" class="line none">  935     <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#87">aws_byte_buf_secure_zero</a>(plain);  // sets plain-&gt;len to zero</div><div id="936" class="line none">  936     if (openssl_err) {</div><div id="937" class="line none">  937         <a href="cipher.c.html#473">flush_openssl_errors</a>();</div><div id="938" class="line none">  938         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="939" class="line none">  939     }</div><div id="940" class="line none">  940     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT);</div><div id="941" class="line none">  941 }</div><div id="942" class="line none">  942 </div><div id="943" class="line none">  943 static int <a href="cipher.c.html#943">get_openssl_rsa_padding_mode</a>(enum <a href="../include/aws/cryptosdk/cipher.h.html#42">aws_cryptosdk_rsa_padding_mode</a> rsa_padding_mode) {</div><div id="944" class="line none">  944     switch (rsa_padding_mode) {</div><div id="945" class="line none">  945         case <a href="../include/aws/cryptosdk/cipher.h.html#43">AWS_CRYPTOSDK_RSA_PKCS1</a>: return RSA_PKCS1_PADDING;</div><div id="946" class="line none">  946         case <a href="../include/aws/cryptosdk/cipher.h.html#44">AWS_CRYPTOSDK_RSA_OAEP_SHA1_MGF1</a>: return RSA_PKCS1_OAEP_PADDING;</div><div id="947" class="line none">  947         case <a href="../include/aws/cryptosdk/cipher.h.html#45">AWS_CRYPTOSDK_RSA_OAEP_SHA256_MGF1</a>: return RSA_PKCS1_OAEP_PADDING;</div><div id="948" class="line none">  948         default: return -1;</div><div id="949" class="line none">  949     }</div><div id="950" class="line none">  950 }</div><div id="951" class="line none">  951 </div><div id="952" class="line none">  952 int <a href="cipher.c.html#952">aws_cryptosdk_rsa_encrypt</a>(</div><div id="953" class="line none">  953     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>,</div><div id="954" class="line none">  954     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>,</div><div id="955" class="line none">  955     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> plain,</div><div id="956" class="line none">  956     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *rsa_public_key_pem,</div><div id="957" class="line none">  957     enum <a href="../include/aws/cryptosdk/cipher.h.html#42">aws_cryptosdk_rsa_padding_mode</a> rsa_padding_mode) {</div><div id="958" class="line none">  958     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>));</div><div id="959" class="line none">  959     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;plain));</div><div id="960" class="line none">  960     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(rsa_public_key_pem));</div><div id="961" class="line none">  961     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>) return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_STATE);</div><div id="962" class="line none">  962     int <a href="../verification/cbmc/sources/openssl/evp_override.c.html#441">padding</a> = <a href="cipher.c.html#943">get_openssl_rsa_padding_mode</a>(rsa_padding_mode);</div><div id="963" class="line none">  963     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#441">padding</a> &lt; 0) return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT);</div><div id="964" class="line none">  964     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#30">BIO</a> *bio          = NULL;</div><div id="965" class="line none">  965     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#35">EVP_PKEY_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a> = NULL;</div><div id="966" class="line none">  966     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#42">EVP_PKEY</a> *<a href="cipher_openssl.c.html#77">pkey</a>    = NULL;</div><div id="967" class="line none">  967     bool error        = true;</div><div id="968" class="line none">  968     int err_code      = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="969" class="line none">  969     <a href="cipher_openssl.c.html#77">pkey</a>              = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#32">EVP_PKEY_new</a>();</div><div id="970" class="line none">  970     if (!<a href="cipher_openssl.c.html#77">pkey</a>) goto cleanup;</div><div id="971" class="line none">  971     bio = <a href="../verification/cbmc/include/openssl/bio.h.html#25">BIO_new_mem_buf</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#15">aws_string_bytes</a>(rsa_public_key_pem), rsa_public_key_pem-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="972" class="line none">  972     if (!bio) goto cleanup;</div><div id="973" class="line none">  973     if (!<a href="../verification/cbmc/include/openssl/bio.h.html#27">PEM_read_bio_PUBKEY</a>(bio, &amp;<a href="cipher_openssl.c.html#77">pkey</a>, NULL, NULL)) goto cleanup;</div><div id="974" class="line none">  974     <a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#99">EVP_PKEY_CTX_new</a>(<a href="cipher_openssl.c.html#77">pkey</a>, NULL);</div><div id="975" class="line none">  975     if (!<a href="cipher_openssl.c.html#78">ctx</a>) goto cleanup;</div><div id="976" class="line none">  976     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#268">EVP_PKEY_encrypt_init</a>(<a href="cipher_openssl.c.html#78">ctx</a>) &lt;= 0) goto cleanup;</div><div id="977" class="line none">  977     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#304">EVP_PKEY_CTX_set_rsa_padding</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#441">padding</a>) &lt;= 0) goto cleanup;</div><div id="978" class="line none">  978     if (rsa_padding_mode == <a href="../include/aws/cryptosdk/cipher.h.html#45">AWS_CRYPTOSDK_RSA_OAEP_SHA256_MGF1</a>) {</div><div id="979" class="line none">  979         if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#319">EVP_PKEY_CTX_set_rsa_oaep_md</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#700">EVP_sha256</a>()) &lt;= 0) goto cleanup;</div><div id="980" class="line none">  980         if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#332">EVP_PKEY_CTX_set_rsa_mgf1_md</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#700">EVP_sha256</a>()) &lt;= 0) goto cleanup;</div><div id="981" class="line none">  981     }</div><div id="982" class="line none">  982     size_t outlen;</div><div id="983" class="line none">  983     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#347">EVP_PKEY_encrypt</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;outlen, plain.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, plain.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) &lt;= 0) goto cleanup;</div><div id="984" class="line none">  984     if (<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#17">aws_byte_buf_init</a>(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>, <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, outlen)) goto cleanup;</div><div id="985" class="line none">  985     if (1 == <a href="../verification/cbmc/sources/openssl/evp_override.c.html#347">EVP_PKEY_encrypt</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, &amp;outlen, plain.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, plain.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) {</div><div id="986" class="line none">  986         <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = outlen;</div><div id="987" class="line none">  987         error       = false;</div><div id="988" class="line none">  988     }</div><div id="989" class="line none">  989 </div><div id="990" class="line none">  990 cleanup:</div><div id="991" class="line none">  991     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#402">EVP_PKEY_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="992" class="line none">  992     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#74">EVP_PKEY_free</a>(<a href="cipher_openssl.c.html#77">pkey</a>);</div><div id="993" class="line none">  993     <a href="../verification/cbmc/include/openssl/bio.h.html#31">BIO_free</a>(bio);</div><div id="994" class="line none">  994     <a href="cipher.c.html#473">flush_openssl_errors</a>();</div><div id="995" class="line none">  995     if (error) {</div><div id="996" class="line none">  996         <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#96">aws_byte_buf_clean_up_secure</a>(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>);</div><div id="997" class="line none">  997         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(err_code);</div><div id="998" class="line none">  998     } else {</div><div id="999" class="line none">  999         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="1000" class="line none"> 1000     }</div><div id="1001" class="line none"> 1001 }</div><div id="1002" class="line none"> 1002 </div><div id="1003" class="line none"> 1003 int <a href="cipher.c.html#1003">aws_cryptosdk_rsa_decrypt</a>(</div><div id="1004" class="line none"> 1004     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *plain,</div><div id="1005" class="line none"> 1005     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>,</div><div id="1006" class="line none"> 1006     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>,</div><div id="1007" class="line none"> 1007     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *rsa_private_key_pem,</div><div id="1008" class="line none"> 1008     enum <a href="../include/aws/cryptosdk/cipher.h.html#42">aws_cryptosdk_rsa_padding_mode</a> rsa_padding_mode) {</div><div id="1009" class="line none"> 1009     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(plain));</div><div id="1010" class="line none"> 1010     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>));</div><div id="1011" class="line none"> 1011     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(rsa_private_key_pem));</div><div id="1012" class="line none"> 1012     if (plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>) return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_STATE);</div><div id="1013" class="line none"> 1013     int <a href="../verification/cbmc/sources/openssl/evp_override.c.html#441">padding</a> = <a href="cipher.c.html#943">get_openssl_rsa_padding_mode</a>(rsa_padding_mode);</div><div id="1014" class="line none"> 1014     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#441">padding</a> &lt; 0) return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT);</div><div id="1015" class="line none"> 1015     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#30">BIO</a> *bio          = NULL;</div><div id="1016" class="line none"> 1016     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#35">EVP_PKEY_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a> = NULL;</div><div id="1017" class="line none"> 1017     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#42">EVP_PKEY</a> *<a href="cipher_openssl.c.html#77">pkey</a>    = NULL;</div><div id="1018" class="line none"> 1018     bool error        = true;</div><div id="1019" class="line none"> 1019     int err_code      = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="1020" class="line none"> 1020     <a href="cipher_openssl.c.html#77">pkey</a>              = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#32">EVP_PKEY_new</a>();</div><div id="1021" class="line none"> 1021     if (!<a href="cipher_openssl.c.html#77">pkey</a>) goto cleanup;</div><div id="1022" class="line none"> 1022     bio = <a href="../verification/cbmc/include/openssl/bio.h.html#25">BIO_new_mem_buf</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#15">aws_string_bytes</a>(rsa_private_key_pem), rsa_private_key_pem-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="1023" class="line none"> 1023     if (!bio) goto cleanup;</div><div id="1024" class="line none"> 1024     if (!<a href="../verification/cbmc/include/openssl/bio.h.html#29">PEM_read_bio_PrivateKey</a>(bio, &amp;<a href="cipher_openssl.c.html#77">pkey</a>, NULL, NULL)) goto cleanup;</div><div id="1025" class="line none"> 1025     <a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#99">EVP_PKEY_CTX_new</a>(<a href="cipher_openssl.c.html#77">pkey</a>, NULL);</div><div id="1026" class="line none"> 1026     if (!<a href="cipher_openssl.c.html#78">ctx</a>) goto cleanup;</div><div id="1027" class="line none"> 1027     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#285">EVP_PKEY_decrypt_init</a>(<a href="cipher_openssl.c.html#78">ctx</a>) &lt;= 0) goto cleanup;</div><div id="1028" class="line none"> 1028     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#304">EVP_PKEY_CTX_set_rsa_padding</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#441">padding</a>) &lt;= 0) goto cleanup;</div><div id="1029" class="line none"> 1029     if (rsa_padding_mode == <a href="../include/aws/cryptosdk/cipher.h.html#45">AWS_CRYPTOSDK_RSA_OAEP_SHA256_MGF1</a>) {</div><div id="1030" class="line none"> 1030         if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#319">EVP_PKEY_CTX_set_rsa_oaep_md</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#700">EVP_sha256</a>()) &lt;= 0) goto cleanup;</div><div id="1031" class="line none"> 1031         if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#332">EVP_PKEY_CTX_set_rsa_mgf1_md</a>(<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#700">EVP_sha256</a>()) &lt;= 0) goto cleanup;</div><div id="1032" class="line none"> 1032     }</div><div id="1033" class="line none"> 1033     size_t outlen;</div><div id="1034" class="line none"> 1034     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#376">EVP_PKEY_decrypt</a>(<a href="cipher_openssl.c.html#78">ctx</a>, NULL, &amp;outlen, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) &lt;= 0) goto cleanup;</div><div id="1035" class="line none"> 1035     if (<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#17">aws_byte_buf_init</a>(plain, <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, outlen)) goto cleanup;</div><div id="1036" class="line none"> 1036     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#376">EVP_PKEY_decrypt</a>(<a href="cipher_openssl.c.html#78">ctx</a>, plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, &amp;outlen, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, <a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) &lt;= 0) {</div><div id="1037" class="line none"> 1037         err_code = AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT;</div><div id="1038" class="line none"> 1038     } else {</div><div id="1039" class="line none"> 1039         plain-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = outlen;</div><div id="1040" class="line none"> 1040         error      = false;</div><div id="1041" class="line none"> 1041     }</div><div id="1042" class="line none"> 1042 </div><div id="1043" class="line none"> 1043 cleanup:</div><div id="1044" class="line none"> 1044     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#402">EVP_PKEY_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="1045" class="line none"> 1045     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#74">EVP_PKEY_free</a>(<a href="cipher_openssl.c.html#77">pkey</a>);</div><div id="1046" class="line none"> 1046     <a href="../verification/cbmc/include/openssl/bio.h.html#31">BIO_free</a>(bio);</div><div id="1047" class="line none"> 1047     <a href="cipher.c.html#473">flush_openssl_errors</a>();</div><div id="1048" class="line none"> 1048     if (error) {</div><div id="1049" class="line none"> 1049         <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#96">aws_byte_buf_clean_up_secure</a>(plain);</div><div id="1050" class="line none"> 1050         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(err_code);</div><div id="1051" class="line none"> 1051     } else {</div><div id="1052" class="line none"> 1052         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="1053" class="line none"> 1053     }</div><div id="1054" class="line none"> 1054 }</div><div id="1055" class="line none"> 1055 </div><div id="1056" class="line none"> 1056 bool <a href="cipher.c.html#1056">aws_cryptosdk_data_key_is_valid</a>(const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>) {</div><div id="1057" class="line both"> 1057     return AWS_MEM_IS_WRITABLE(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#37">MAX_DATA_KEY_SIZE</a>);</div><div id="1058" class="line hit"> 1058 }</div><div id="1059" class="line none"> 1059 </div><div id="1060" class="line none"> 1060 bool <a href="cipher.c.html#1060">aws_cryptosdk_content_key_is_valid</a>(const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>) {</div><div id="1061" class="line both"> 1061     return AWS_MEM_IS_WRITABLE(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#40">keybuf</a>, <a href="../include/aws/cryptosdk/private/cipher.h.html#37">MAX_DATA_KEY_SIZE</a>);</div><div id="1062" class="line hit"> 1062 }</div>
</div>
</body>
</html>
