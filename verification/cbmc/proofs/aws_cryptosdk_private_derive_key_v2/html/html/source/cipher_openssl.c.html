
<html>
<head>
<title>source/cipher_openssl.c</title>
<link rel="stylesheet" type="text/css" href="../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * Licensed under the Apache License, Version 2.0 (the "License"). You may not use</div><div id="5" class="line none">    5  * this file except in compliance with the License. A copy of the License is</div><div id="6" class="line none">    6  * located at</div><div id="7" class="line none">    7  *</div><div id="8" class="line none">    8  *     http://aws.amazon.com/apache2.0/</div><div id="9" class="line none">    9  *</div><div id="10" class="line none">   10  * or in the "license" file accompanying this file. This file is distributed on an</div><div id="11" class="line none">   11  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</div><div id="12" class="line none">   12  * implied. See the License for the specific language governing permissions and</div><div id="13" class="line none">   13  * limitations under the License.</div><div id="14" class="line none">   14  */</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 #include &lt;assert.h&gt;</div><div id="17" class="line none">   17 #include &lt;stdlib.h&gt;</div><div id="18" class="line none">   18 </div><div id="19" class="line none">   19 #include &lt;openssl/crypto.h&gt;</div><div id="20" class="line none">   20 #include &lt;openssl/opensslv.h&gt;</div><div id="21" class="line none">   21 </div><div id="22" class="line none">   22 #include &lt;openssl/ec.h&gt;</div><div id="23" class="line none">   23 #include &lt;openssl/ecdsa.h&gt;</div><div id="24" class="line none">   24 #include &lt;openssl/err.h&gt;</div><div id="25" class="line none">   25 #include &lt;openssl/evp.h&gt;</div><div id="26" class="line none">   26 </div><div id="27" class="line none">   27 #include &lt;aws/common/encoding.h&gt;</div><div id="28" class="line none">   28 </div><div id="29" class="line none">   29 #include &lt;aws/cryptosdk/<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.h&gt;</div><div id="30" class="line none">   30 #include &lt;aws/cryptosdk/error.h&gt;</div><div id="31" class="line none">   31 #include &lt;aws/cryptosdk/private/<a href="../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.h&gt;</div><div id="32" class="line none">   32 </div><div id="33" class="line none">   33 #include &lt;ctype.h&gt;</div><div id="34" class="line none">   34 #include &lt;stdio.h&gt;</div><div id="35" class="line none">   35 </div><div id="36" class="line none">   36 /* This is large enough to hold an encoded public key for all currently supported curves */</div><div id="37" class="line none">   37 #define <a href="cipher_openssl.c.html#37">MAX_PUBKEY_SIZE</a> 64</div><div id="38" class="line none">   38 #define <a href="cipher_openssl.c.html#38">MAX_PUBKEY_SIZE_B64</a> (((<a href="cipher_openssl.c.html#37">MAX_PUBKEY_SIZE</a> + 2) * 4) / 3)</div><div id="39" class="line none">   39 </div><div id="40" class="line none">   40 /*</div><div id="41" class="line none">   41  * This is larger than the sizes defined in cipher.c to account for certain versions of the Encryption SDK</div><div id="42" class="line none">   42  * for other languages which generated signatures of nondeterministic size.</div><div id="43" class="line none">   43  */</div><div id="44" class="line none">   44 </div><div id="45" class="line none">   45 #define <a href="cipher_openssl.c.html#45">MAX_SIGNATURE_SIZE</a> 128</div><div id="46" class="line none">   46 #define <a href="cipher_openssl.c.html#46">MAX_SIGNATURE_SIZE_B64</a> (((<a href="cipher_openssl.c.html#45">MAX_SIGNATURE_SIZE</a> + 2) * 4) / 3)</div><div id="47" class="line none">   47 </div><div id="48" class="line none">   48 // Compatibility hacks for openssl API changes between major versions</div><div id="49" class="line none">   49 #if OPENSSL_VERSION_NUMBER &lt; 0x10100000</div><div id="50" class="line none">   50 #    define <a href="cipher_openssl.c.html#50">OSSL_100</a></div><div id="51" class="line none">   51 #endif</div><div id="52" class="line none">   52 </div><div id="53" class="line none">   53 #ifdef <a href="cipher_openssl.c.html#50">OSSL_100</a></div><div id="54" class="line none">   54 </div><div id="55" class="line none">   55 #    define <a href="../verification/cbmc/sources/openssl/evp_override.c.html#729">EVP_MD_CTX_new</a> EVP_MD_CTX_create</div><div id="56" class="line none">   56 #    define <a href="../verification/cbmc/sources/openssl/evp_override.c.html#753">EVP_MD_CTX_free</a> EVP_MD_CTX_destroy</div><div id="57" class="line none">   57 </div><div id="58" class="line none">   58 static void <a href="../verification/cbmc/sources/openssl/ec_override.c.html#290">ECDSA_SIG_get0</a>(const <a href="../verification/cbmc/include/openssl/ec.h.html#45">ECDSA_SIG</a> *sig, const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> **<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a>, const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> **<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>) {</div><div id="59" class="line none">   59     *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a> = sig-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a>;</div><div id="60" class="line none">   60     *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a> = sig-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>;</div><div id="61" class="line none">   61 }</div><div id="62" class="line none">   62 </div><div id="63" class="line none">   63 static void <a href="../verification/cbmc/sources/openssl/ec_override.c.html#305">ECDSA_SIG_set0</a>(<a href="../verification/cbmc/include/openssl/ec.h.html#45">ECDSA_SIG</a> *sig, <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a>, <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>) {</div><div id="64" class="line none">   64     if (sig-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a>) <a href="../verification/cbmc/sources/openssl/bn_override.c.html#77">BN_free</a>(sig-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a>);</div><div id="65" class="line none">   65     if (sig-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>) <a href="../verification/cbmc/sources/openssl/bn_override.c.html#77">BN_free</a>(sig-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>);</div><div id="66" class="line none">   66 </div><div id="67" class="line none">   67     sig-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a>;</div><div id="68" class="line none">   68     sig-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>;</div><div id="69" class="line none">   69 }</div><div id="70" class="line none">   70 </div><div id="71" class="line none">   71 #endif</div><div id="72" class="line none">   72 </div><div id="73" class="line none">   73 struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> {</div><div id="74" class="line none">   74     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="75" class="line none">   75     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>;</div><div id="76" class="line none">   76     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#33">EC_KEY</a> *<a href="cipher_openssl.c.html#76">keypair</a>;</div><div id="77" class="line none">   77     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#42">EVP_PKEY</a> *<a href="cipher_openssl.c.html#77">pkey</a>;</div><div id="78" class="line none">   78     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#41">EVP_MD_CTX</a> *<a href="cipher_openssl.c.html#78">ctx</a>;</div><div id="79" class="line none">   79     bool <a href="cipher_openssl.c.html#79">is_sign</a>;</div><div id="80" class="line none">   80 };</div><div id="81" class="line none">   81 </div><div id="82" class="line none">   82 bool <a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(const struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *sig_ctx) {</div><div id="83" class="line none">   83     return sig_ctx &amp;&amp; AWS_OBJECT_PTR_IS_READABLE(sig_ctx-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>) &amp;&amp; AWS_OBJECT_PTR_IS_READABLE(sig_ctx-&gt;<a href="cipher_openssl.c.html#75">props</a>) &amp;&amp;</div><div id="84" class="line none">   84            sig_ctx-&gt;<a href="cipher_openssl.c.html#76">keypair</a> &amp;&amp; sig_ctx-&gt;<a href="cipher_openssl.c.html#77">pkey</a> &amp;&amp; sig_ctx-&gt;<a href="cipher_openssl.c.html#78">ctx</a> &amp;&amp;</div><div id="85" class="line none">   85 #if OPENSSL_VERSION_NUMBER &gt;= 0x10100000</div><div id="86" class="line none">   86            (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#48">EVP_PKEY_get0_EC_KEY</a>(sig_ctx-&gt;<a href="cipher_openssl.c.html#77">pkey</a>) == sig_ctx-&gt;<a href="cipher_openssl.c.html#76">keypair</a>) &amp;&amp;</div><div id="87" class="line none">   87 #endif</div><div id="88" class="line none">   88            (sig_ctx-&gt;<a href="cipher_openssl.c.html#79">is_sign</a> == (<a href="../verification/cbmc/sources/openssl/ec_override.c.html#171">EC_KEY_get0_private_key</a>(sig_ctx-&gt;<a href="cipher_openssl.c.html#76">keypair</a>) != NULL));</div><div id="89" class="line none">   89 }</div><div id="90" class="line none">   90 </div><div id="91" class="line none">   91 struct <a href="../include/aws/cryptosdk/private/cipher.h.html#47">aws_cryptosdk_md_context</a> {</div><div id="92" class="line none">   92     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="93" class="line none">   93     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#41">EVP_MD_CTX</a> *<a href="cipher_openssl.c.html#93">evp_md_ctx</a>;</div><div id="94" class="line none">   94 };</div><div id="95" class="line none">   95 </div><div id="96" class="line none">   96 bool <a href="cipher_openssl.c.html#96">aws_cryptosdk_md_context_is_valid</a>(const struct <a href="../include/aws/cryptosdk/private/cipher.h.html#47">aws_cryptosdk_md_context</a> *md_context) {</div><div id="97" class="line none">   97     return md_context &amp;&amp; AWS_OBJECT_PTR_IS_READABLE(md_context-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>) &amp;&amp; md_context-&gt;<a href="cipher_openssl.c.html#93">evp_md_ctx</a>;</div><div id="98" class="line none">   98 }</div><div id="99" class="line none">   99 </div><div id="100" class="line none">  100 int <a href="cipher_openssl.c.html#100">aws_cryptosdk_md_init</a>(</div><div id="101" class="line none">  101     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, struct <a href="../include/aws/cryptosdk/private/cipher.h.html#47">aws_cryptosdk_md_context</a> **md_context, enum <a href="../include/aws/cryptosdk/private/cipher.h.html#51">aws_cryptosdk_md_alg</a> md_alg) {</div><div id="102" class="line none">  102     const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#40">EVP_MD</a> *evp_md_alg;</div><div id="103" class="line none">  103     *md_context = NULL;</div><div id="104" class="line none">  104 </div><div id="105" class="line none">  105     switch (md_alg) {</div><div id="106" class="line none">  106         case <a href="../include/aws/cryptosdk/private/cipher.h.html#51">AWS_CRYPTOSDK_MD_SHA512</a>: evp_md_alg = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#708">EVP_sha512</a>(); break;</div><div id="107" class="line none">  107         default: return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="108" class="line none">  108     }</div><div id="109" class="line none">  109 </div><div id="110" class="line none">  110     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#41">EVP_MD_CTX</a> *<a href="cipher_openssl.c.html#93">evp_md_ctx</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#729">EVP_MD_CTX_new</a>();</div><div id="111" class="line none">  111     if (!<a href="cipher_openssl.c.html#93">evp_md_ctx</a>) {</div><div id="112" class="line none">  112         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="113" class="line none">  113         goto err;</div><div id="114" class="line none">  114     }</div><div id="115" class="line none">  115 </div><div id="116" class="line none">  116     if (1 != <a href="../verification/cbmc/sources/openssl/evp_override.c.html#765">EVP_DigestInit_ex</a>(<a href="cipher_openssl.c.html#93">evp_md_ctx</a>, evp_md_alg, NULL)) {</div><div id="117" class="line none">  117         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="118" class="line none">  118         goto err;</div><div id="119" class="line none">  119     }</div><div id="120" class="line none">  120 </div><div id="121" class="line none">  121     *md_context = <a href="../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#116">aws_mem_acquire</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, sizeof(**md_context));</div><div id="122" class="line none">  122     if (!*md_context) {</div><div id="123" class="line none">  123         goto err;</div><div id="124" class="line none">  124     }</div><div id="125" class="line none">  125 </div><div id="126" class="line none">  126     (*md_context)-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>      = <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="127" class="line none">  127     (*md_context)-&gt;<a href="cipher_openssl.c.html#93">evp_md_ctx</a> = <a href="cipher_openssl.c.html#93">evp_md_ctx</a>;</div><div id="128" class="line none">  128 </div><div id="129" class="line none">  129     AWS_POSTCONDITION(<a href="cipher_openssl.c.html#96">aws_cryptosdk_md_context_is_valid</a>(*md_context));</div><div id="130" class="line none">  130     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="131" class="line none">  131 err:</div><div id="132" class="line none">  132     EVP_MD_CTX_destroy(<a href="cipher_openssl.c.html#93">evp_md_ctx</a>);</div><div id="133" class="line none">  133     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a>;</div><div id="134" class="line none">  134 }</div><div id="135" class="line none">  135 </div><div id="136" class="line none">  136 size_t <a href="cipher_openssl.c.html#136">aws_cryptosdk_md_size</a>(enum <a href="../include/aws/cryptosdk/private/cipher.h.html#51">aws_cryptosdk_md_alg</a> md_alg) {</div><div id="137" class="line none">  137     switch (md_alg) {</div><div id="138" class="line none">  138         case <a href="../include/aws/cryptosdk/private/cipher.h.html#51">AWS_CRYPTOSDK_MD_SHA512</a>: return 512 / 8;</div><div id="139" class="line none">  139         default: return 0;</div><div id="140" class="line none">  140     }</div><div id="141" class="line none">  141 }</div><div id="142" class="line none">  142 </div><div id="143" class="line none">  143 int <a href="cipher_openssl.c.html#143">aws_cryptosdk_md_update</a>(struct <a href="../include/aws/cryptosdk/private/cipher.h.html#47">aws_cryptosdk_md_context</a> *md_context, const void *buf, size_t <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>) {</div><div id="144" class="line none">  144     AWS_PRECONDITION(<a href="cipher_openssl.c.html#96">aws_cryptosdk_md_context_is_valid</a>(md_context));</div><div id="145" class="line none">  145     AWS_PRECONDITION(AWS_MEM_IS_READABLE(buf, <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>));</div><div id="146" class="line none">  146 </div><div id="147" class="line none">  147     if (1 != <a href="../verification/cbmc/sources/openssl/evp_override.c.html#791">EVP_DigestUpdate</a>(md_context-&gt;<a href="cipher_openssl.c.html#93">evp_md_ctx</a>, buf, <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>)) {</div><div id="148" class="line none">  148         AWS_POSTCONDITION(<a href="cipher_openssl.c.html#96">aws_cryptosdk_md_context_is_valid</a>(md_context));</div><div id="149" class="line none">  149         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="150" class="line none">  150     }</div><div id="151" class="line none">  151 </div><div id="152" class="line none">  152     AWS_POSTCONDITION(<a href="cipher_openssl.c.html#96">aws_cryptosdk_md_context_is_valid</a>(md_context));</div><div id="153" class="line none">  153     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="154" class="line none">  154 }</div><div id="155" class="line none">  155 </div><div id="156" class="line none">  156 int <a href="cipher_openssl.c.html#156">aws_cryptosdk_md_finish</a>(struct <a href="../include/aws/cryptosdk/private/cipher.h.html#47">aws_cryptosdk_md_context</a> *md_context, void *output_buf, size_t *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>) {</div><div id="157" class="line none">  157     AWS_PRECONDITION(<a href="cipher_openssl.c.html#96">aws_cryptosdk_md_context_is_valid</a>(md_context));</div><div id="158" class="line none">  158     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_READABLE(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>));</div><div id="159" class="line none">  159     AWS_PRECONDITION(AWS_MEM_IS_WRITABLE(output_buf, *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>));</div><div id="160" class="line none">  160 </div><div id="161" class="line none">  161     int rv            = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="162" class="line none">  162     unsigned int <a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a> = 0;</div><div id="163" class="line none">  163 </div><div id="164" class="line none">  164     AWS_FATAL_PRECONDITION(output_buf != NULL);</div><div id="165" class="line none">  165 </div><div id="166" class="line none">  166     if (1 != <a href="../verification/cbmc/sources/openssl/evp_override.c.html#811">EVP_DigestFinal_ex</a>(md_context-&gt;<a href="cipher_openssl.c.html#93">evp_md_ctx</a>, output_buf, &amp;<a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a>)) {</div><div id="167" class="line none">  167         rv   = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="168" class="line none">  168         <a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a> = 0;</div><div id="169" class="line none">  169     }</div><div id="170" class="line none">  170 </div><div id="171" class="line none">  171     *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a> = <a href="../verification/cbmc/aws-c-common/include/aws/common/private/hash_table_impl.h.html#35">size</a>;</div><div id="172" class="line none">  172 </div><div id="173" class="line none">  173     <a href="cipher_openssl.c.html#178">aws_cryptosdk_md_abort</a>(md_context);</div><div id="174" class="line none">  174 </div><div id="175" class="line none">  175     return rv;</div><div id="176" class="line none">  176 }</div><div id="177" class="line none">  177 </div><div id="178" class="line none">  178 void <a href="cipher_openssl.c.html#178">aws_cryptosdk_md_abort</a>(struct <a href="../include/aws/cryptosdk/private/cipher.h.html#47">aws_cryptosdk_md_context</a> *md_context) {</div><div id="179" class="line none">  179     AWS_PRECONDITION(!md_context || <a href="cipher_openssl.c.html#96">aws_cryptosdk_md_context_is_valid</a>(md_context));</div><div id="180" class="line none">  180     if (!md_context) {</div><div id="181" class="line none">  181         return;</div><div id="182" class="line none">  182     }</div><div id="183" class="line none">  183 </div><div id="184" class="line none">  184     EVP_MD_CTX_destroy(md_context-&gt;<a href="cipher_openssl.c.html#93">evp_md_ctx</a>);</div><div id="185" class="line none">  185     <a href="../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#201">aws_mem_release</a>(md_context-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, md_context);</div><div id="186" class="line none">  186 }</div><div id="187" class="line none">  187 </div><div id="188" class="line none">  188 static <a href="../verification/cbmc/include/openssl/ec.h.html#38">EC_GROUP</a> *<a href="cipher_openssl.c.html#188">group_for_props</a>(const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>) {</div><div id="189" class="line none">  189     // TODO: Cache? Are EC_GROUPs threadsafe?</div><div id="190" class="line none">  190 </div><div id="191" class="line none">  191     int nid = <a href="../verification/cbmc/include/openssl/objects.h.html#24">OBJ_txt2nid</a>(<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#28">curve_name</a>);</div><div id="192" class="line none">  192     if (nid == <a href="../verification/cbmc/include/openssl/objects.h.html#20">NID_undef</a>) {</div><div id="193" class="line none">  193         fprintf(stderr, "Unknown curve %s\n", <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#28">curve_name</a>);</div><div id="194" class="line none">  194         // unknown curve</div><div id="195" class="line none">  195         return NULL;</div><div id="196" class="line none">  196     }</div><div id="197" class="line none">  197 </div><div id="198" class="line none">  198     <a href="../verification/cbmc/include/openssl/ec.h.html#38">EC_GROUP</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#38">EC_GROUP_new_by_curve_name</a>(nid);</div><div id="199" class="line none">  199     if (<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>) {</div><div id="200" class="line none">  200         <a href="../verification/cbmc/sources/openssl/ec_override.c.html#57">EC_GROUP_set_point_conversion_form</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>, <a href="../verification/cbmc/include/openssl/ec.h.html#30">POINT_CONVERSION_COMPRESSED</a>);</div><div id="201" class="line none">  201     }</div><div id="202" class="line none">  202 </div><div id="203" class="line none">  203     return <a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>;</div><div id="204" class="line none">  204 }</div><div id="205" class="line none">  205 </div><div id="206" class="line none">  206 /**</div><div id="207" class="line none">  207  * Set up a signing context using a previously prepared EC_KEY. This will take a reference on keypair, so the caller</div><div id="208" class="line none">  208  * should dispose of its own reference on keypair.</div><div id="209" class="line none">  209  */</div><div id="210" class="line none">  210 static struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#210">sign_start</a>(</div><div id="211" class="line none">  211     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#33">EC_KEY</a> *<a href="cipher_openssl.c.html#76">keypair</a>, const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>) {</div><div id="212" class="line none">  212     struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#116">aws_mem_acquire</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, sizeof(*<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="213" class="line none">  213 </div><div id="214" class="line none">  214     if (!<a href="cipher_openssl.c.html#78">ctx</a>) {</div><div id="215" class="line none">  215         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="216" class="line none">  216         return NULL;</div><div id="217" class="line none">  217     }</div><div id="218" class="line none">  218 </div><div id="219" class="line none">  219     memset(<a href="cipher_openssl.c.html#78">ctx</a>, 0, sizeof(*<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="220" class="line none">  220     <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>   = <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="221" class="line none">  221     <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#75">props</a>   = <a href="cipher_openssl.c.html#75">props</a>;</div><div id="222" class="line none">  222     <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a> = <a href="cipher_openssl.c.html#76">keypair</a>;</div><div id="223" class="line none">  223     // The caller will unconditionally clean up the EC_KEY, so up the refcount first</div><div id="224" class="line none">  224     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#199">EC_KEY_up_ref</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>);</div><div id="225" class="line none">  225 </div><div id="226" class="line none">  226     if (!(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#77">pkey</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#32">EVP_PKEY_new</a>())) {</div><div id="227" class="line none">  227         goto oom;</div><div id="228" class="line none">  228     }</div><div id="229" class="line none">  229 </div><div id="230" class="line none">  230     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#59">EVP_PKEY_set1_EC_KEY</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#77">pkey</a>, <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>)) {</div><div id="231" class="line none">  231         goto oom;</div><div id="232" class="line none">  232     }</div><div id="233" class="line none">  233 </div><div id="234" class="line none">  234     if (!(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#729">EVP_MD_CTX_new</a>())) {</div><div id="235" class="line none">  235         goto oom;</div><div id="236" class="line none">  236     }</div><div id="237" class="line none">  237 </div><div id="238" class="line none">  238     /*</div><div id="239" class="line none">  239      * We perform the digest and signature separately, as we might need to re-sign to get the right</div><div id="240" class="line none">  240      * signature size.</div><div id="241" class="line none">  241      */</div><div id="242" class="line none">  242     if (!(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#783">EVP_DigestInit</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a>, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#27">sig_md_ctor</a>()))) {</div><div id="243" class="line none">  243         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="244" class="line none">  244         goto rethrow;</div><div id="245" class="line none">  245     }</div><div id="246" class="line none">  246 </div><div id="247" class="line none">  247     <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#79">is_sign</a> = true;</div><div id="248" class="line none">  248 </div><div id="249" class="line none">  249     return <a href="cipher_openssl.c.html#78">ctx</a>;</div><div id="250" class="line none">  250 </div><div id="251" class="line none">  251 oom:</div><div id="252" class="line none">  252     <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="253" class="line none">  253 rethrow:</div><div id="254" class="line none">  254     <a href="cipher_openssl.c.html#510">aws_cryptosdk_sig_abort</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="255" class="line none">  255 </div><div id="256" class="line none">  256     return NULL;</div><div id="257" class="line none">  257 }</div><div id="258" class="line none">  258 </div><div id="259" class="line none">  259 static int <a href="cipher_openssl.c.html#259">serialize_pubkey</a>(struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#33">EC_KEY</a> *<a href="cipher_openssl.c.html#76">keypair</a>, struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> **pub_key) {</div><div id="260" class="line none">  260     unsigned char *buf = NULL;</div><div id="261" class="line none">  261     int <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>;</div><div id="262" class="line none">  262     size_t b64_len;</div><div id="263" class="line none">  263     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> binary;</div><div id="264" class="line none">  264     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> b64;</div><div id="265" class="line none">  265     uint8_t tmp[<a href="cipher_openssl.c.html#38">MAX_PUBKEY_SIZE_B64</a>];</div><div id="266" class="line none">  266 </div><div id="267" class="line none">  267     // TODO: We currently _only_ accept compressed points. Should we accept uncompressed points as well?</div><div id="268" class="line none">  268     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#144">EC_KEY_set_conv_form</a>(<a href="cipher_openssl.c.html#76">keypair</a>, <a href="../verification/cbmc/include/openssl/ec.h.html#30">POINT_CONVERSION_COMPRESSED</a>);</div><div id="269" class="line none">  269 </div><div id="270" class="line none">  270     <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#258">i2o_ECPublicKey</a>(<a href="cipher_openssl.c.html#76">keypair</a>, &amp;buf);</div><div id="271" class="line none">  271     if (<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a> &lt;= 0) {</div><div id="272" class="line none">  272         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="273" class="line none">  273         goto err;</div><div id="274" class="line none">  274     }</div><div id="275" class="line none">  275 </div><div id="276" class="line none">  276     binary = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#950">aws_byte_cursor_from_array</a>(buf, <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>);</div><div id="277" class="line none">  277     b64    = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#921">aws_byte_buf_from_empty_array</a>(tmp, sizeof(tmp));</div><div id="278" class="line none">  278 </div><div id="279" class="line none">  279     if (<a href="../verification/cbmc/aws-c-common/include/aws/common/encoding.h.html#63">aws_base64_compute_encoded_len</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#18">length</a>, &amp;b64_len)) {</div><div id="280" class="line none">  280         goto err;</div><div id="281" class="line none">  281     }</div><div id="282" class="line none">  282 </div><div id="283" class="line none">  283     /* This performs an implicit bounds check on MAX_PUBKEY_SIZE */</div><div id="284" class="line none">  284     if (<a href="../verification/cbmc/aws-c-common/include/aws/common/encoding.h.html#69">aws_base64_encode</a>(&amp;binary, &amp;b64)) {</div><div id="285" class="line none">  285         goto err;</div><div id="286" class="line none">  286     }</div><div id="287" class="line none">  287 </div><div id="288" class="line none">  288     // base64_encode adds a NUL terminator; strip it off</div><div id="289" class="line none">  289     // TODO: When aws-c-common removes the NUL terminator fix this</div><div id="290" class="line none">  290     if (b64.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> &amp;&amp; b64.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>[b64.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> - 1] == 0) {</div><div id="291" class="line none">  291         b64.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>--;</div><div id="292" class="line none">  292     }</div><div id="293" class="line none">  293 </div><div id="294" class="line none">  294     *pub_key = <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#108">aws_string_new_from_array</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, b64.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, b64.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="295" class="line none">  295     if (!*pub_key) {</div><div id="296" class="line none">  296         goto err;</div><div id="297" class="line none">  297     }</div><div id="298" class="line none">  298 </div><div id="299" class="line none">  299     free(buf);</div><div id="300" class="line none">  300     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="301" class="line none">  301 </div><div id="302" class="line none">  302 err:</div><div id="303" class="line none">  303     // buf (and tmp) hold a public key, so we don't need to zeroize them.</div><div id="304" class="line none">  304     free(buf);</div><div id="305" class="line none">  305 </div><div id="306" class="line none">  306     *pub_key = NULL;</div><div id="307" class="line none">  307 </div><div id="308" class="line none">  308     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a>;</div><div id="309" class="line none">  309 }</div><div id="310" class="line none">  310 </div><div id="311" class="line none">  311 int <a href="cipher_openssl.c.html#311">aws_cryptosdk_sig_get_pubkey</a>(</div><div id="312" class="line none">  312     const struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#78">ctx</a>, struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> **pub_key_buf) {</div><div id="313" class="line none">  313     AWS_PRECONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="314" class="line none">  314     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_READABLE(pub_key_buf));</div><div id="315" class="line none">  315     int rv = <a href="cipher_openssl.c.html#259">serialize_pubkey</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>, pub_key_buf);</div><div id="316" class="line none">  316     AWS_POSTCONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="317" class="line none">  317     AWS_POSTCONDITION((rv == <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>) ? <a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(*pub_key_buf) : !*pub_key_buf);</div><div id="318" class="line none">  318     return rv;</div><div id="319" class="line none">  319 }</div><div id="320" class="line none">  320 </div><div id="321" class="line none">  321 int <a href="cipher_openssl.c.html#321">aws_cryptosdk_sig_get_privkey</a>(</div><div id="322" class="line none">  322     const struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#78">ctx</a>, struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> **<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>) {</div><div id="323" class="line none">  323     AWS_PRECONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="324" class="line none">  324     AWS_PRECONDITION(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#79">is_sign</a>);</div><div id="325" class="line none">  325     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_READABLE(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>));</div><div id="326" class="line none">  326     /*</div><div id="327" class="line none">  327      * When serializing private keys we use this ad-hoc format:</div><div id="328" class="line none">  328      *</div><div id="329" class="line none">  329      * 1. CryptoSDK algorithm ID (16-bit, big endian)</div><div id="330" class="line none">  330      * 2. Public key length (8-bit)</div><div id="331" class="line none">  331      * 3. Private key length (8-bit)</div><div id="332" class="line none">  332      * 4. Public key (DER, compressed point format)</div><div id="333" class="line none">  333      * 5. Private key (as an ASN.1 integer)</div><div id="334" class="line none">  334      *</div><div id="335" class="line none">  335      * We avoid the use of the d2i_ECPrivateKey format because it serializes the group,</div><div id="336" class="line none">  336      * and we have no reliable way of checking whether the deserialized group was correct.</div><div id="337" class="line none">  337      * In particular, EC_GROUP_cmp returns a non-equal result if the "method" of the group</div><div id="338" class="line none">  338      * differs (i.e. if one uses a generic EC backend, and the other uses an optimized backend</div><div id="339" class="line none">  339      * for the specific group). This can happen if i2d_ECPrivateKey chose an explicit curve</div><div id="340" class="line none">  340      * representation, which got loaded as a generic curve, while internally we choose a named</div><div id="341" class="line none">  341      * curve for the curve to compare against.</div><div id="342" class="line none">  342      */</div><div id="343" class="line none">  343     unsigned char *privkey_buf = NULL, *pubkey_buf = NULL;</div><div id="344" class="line none">  344     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#23">ASN1_INTEGER</a> *privkey_int = NULL;</div><div id="345" class="line none">  345     /* Should be long enough to encode the private + compressed public key + alg id */</div><div id="346" class="line none">  346     unsigned char tmparr[<a href="cipher_openssl.c.html#37">MAX_PUBKEY_SIZE</a> * 2 + 2];</div><div id="347" class="line none">  347 </div><div id="348" class="line none">  348     int privkey_len = 0, pubkey_len = 0;</div><div id="349" class="line none">  349     int rv                       = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a>;</div><div id="350" class="line none">  350     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> tmpbuf   = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(tmparr, sizeof(tmparr));</div><div id="351" class="line none">  351     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> input = { 0 };</div><div id="352" class="line none">  352 </div><div id="353" class="line none">  353     const uint16_t <a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a> = <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_order.inl.html#143">aws_hton16</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>);</div><div id="354" class="line none">  354 </div><div id="355" class="line none">  355     *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a> = NULL;</div><div id="356" class="line none">  356 </div><div id="357" class="line none">  357     privkey_int = <a href="../verification/cbmc/include/openssl/asn1.h.html#24">BN_to_ASN1_INTEGER</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#171">EC_KEY_get0_private_key</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>), NULL);</div><div id="358" class="line none">  358     if (!privkey_int) {</div><div id="359" class="line none">  359         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="360" class="line none">  360         goto err;</div><div id="361" class="line none">  361     }</div><div id="362" class="line none">  362 </div><div id="363" class="line none">  363     privkey_len = <a href="../verification/cbmc/include/openssl/asn1.h.html#26">i2d_ASN1_INTEGER</a>(privkey_int, &amp;privkey_buf);</div><div id="364" class="line none">  364 </div><div id="365" class="line none">  365     /*</div><div id="366" class="line none">  366      * Clear and free the private key ASN1 string immediately, regardless of the success</div><div id="367" class="line none">  367      * or failure of serialization, to simplify error handling.</div><div id="368" class="line none">  368      */</div><div id="369" class="line none">  369     <a href="../verification/cbmc/include/openssl/asn1.h.html#22">ASN1_STRING_clear_free</a>(privkey_int);</div><div id="370" class="line none">  370     privkey_int = NULL;</div><div id="371" class="line none">  371 </div><div id="372" class="line none">  372     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#144">EC_KEY_set_conv_form</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>, <a href="../verification/cbmc/include/openssl/ec.h.html#30">POINT_CONVERSION_COMPRESSED</a>);</div><div id="373" class="line none">  373     pubkey_len = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#258">i2o_ECPublicKey</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>, &amp;pubkey_buf);</div><div id="374" class="line none">  374 </div><div id="375" class="line none">  375     if (!privkey_buf || !pubkey_buf) {</div><div id="376" class="line none">  376         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="377" class="line none">  377         goto err;</div><div id="378" class="line none">  378     }</div><div id="379" class="line none">  379 </div><div id="380" class="line none">  380     if (privkey_len &gt; 0xFF || pubkey_len &gt; 0xFF) {</div><div id="381" class="line none">  381         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="382" class="line none">  382         goto err;</div><div id="383" class="line none">  383     }</div><div id="384" class="line none">  384 </div><div id="385" class="line none">  385     tmpbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = 0;</div><div id="386" class="line none">  386     /* TODO: Refactor once writing routines are moved to aws_byte_bufs */</div><div id="387" class="line none">  387     input = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#950">aws_byte_cursor_from_array</a>((const uint8_t *)&amp;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>, sizeof(<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>));</div><div id="388" class="line none">  388     if (<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#561">aws_byte_buf_append</a>(&amp;tmpbuf, &amp;input)) {</div><div id="389" class="line none">  389         goto err;</div><div id="390" class="line none">  390     }</div><div id="391" class="line none">  391     tmpbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>[tmpbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>++] = pubkey_len;</div><div id="392" class="line none">  392     tmpbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>[tmpbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>++] = privkey_len;</div><div id="393" class="line none">  393 </div><div id="394" class="line none">  394     input = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#950">aws_byte_cursor_from_array</a>(pubkey_buf, pubkey_len);</div><div id="395" class="line none">  395     if (<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#561">aws_byte_buf_append</a>(&amp;tmpbuf, &amp;input)) {</div><div id="396" class="line none">  396         goto err;</div><div id="397" class="line none">  397     }</div><div id="398" class="line none">  398 </div><div id="399" class="line none">  399     input = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#950">aws_byte_cursor_from_array</a>(privkey_buf, privkey_len);</div><div id="400" class="line none">  400     if (<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#561">aws_byte_buf_append</a>(&amp;tmpbuf, &amp;input)) {</div><div id="401" class="line none">  401         goto err;</div><div id="402" class="line none">  402     }</div><div id="403" class="line none">  403 </div><div id="404" class="line none">  404     // Since this is an internal-only value, we don't bother with base64-encoding.</div><div id="405" class="line none">  405     *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a> = <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#108">aws_string_new_from_array</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, tmpbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, tmpbuf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="406" class="line none">  406     if (!*<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>) {</div><div id="407" class="line none">  407         // OOM</div><div id="408" class="line none">  408         goto err;</div><div id="409" class="line none">  409     }</div><div id="410" class="line none">  410 </div><div id="411" class="line none">  411     rv = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="412" class="line none">  412 err:</div><div id="413" class="line none">  413     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(tmparr, sizeof(tmparr));</div><div id="414" class="line none">  414     if (privkey_buf) {</div><div id="415" class="line none">  415         <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(privkey_buf, privkey_len);</div><div id="416" class="line none">  416         free(privkey_buf);</div><div id="417" class="line none">  417     }</div><div id="418" class="line none">  418     if (pubkey_buf) {</div><div id="419" class="line none">  419         <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(pubkey_buf, pubkey_len);</div><div id="420" class="line none">  420         free(pubkey_buf);</div><div id="421" class="line none">  421     }</div><div id="422" class="line none">  422 </div><div id="423" class="line none">  423     // There is no error path that results in a non-NULL priv_key, so we don't need to</div><div id="424" class="line none">  424     // clean that up.</div><div id="425" class="line none">  425 </div><div id="426" class="line none">  426     AWS_POSTCONDITION(AWS_OBJECT_PTR_IS_READABLE(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>));</div><div id="427" class="line none">  427     AWS_POSTCONDITION(rv == <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a> ? <a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(*<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>) : !*<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>);</div><div id="428" class="line none">  428     return rv;</div><div id="429" class="line none">  429 }</div><div id="430" class="line none">  430 </div><div id="431" class="line none">  431 int <a href="cipher_openssl.c.html#431">aws_cryptosdk_sig_sign_start_keygen</a>(</div><div id="432" class="line none">  432     struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> **pctx,</div><div id="433" class="line none">  433     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>,</div><div id="434" class="line none">  434     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> **pub_key,</div><div id="435" class="line none">  435     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>) {</div><div id="436" class="line none">  436     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_WRITABLE(pctx));</div><div id="437" class="line none">  437     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_READABLE(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>));</div><div id="438" class="line none">  438     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_READABLE(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="439" class="line none">  439     <a href="../verification/cbmc/include/openssl/ec.h.html#38">EC_GROUP</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a> = NULL;</div><div id="440" class="line none">  440     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#33">EC_KEY</a> *<a href="cipher_openssl.c.html#76">keypair</a> = NULL;</div><div id="441" class="line none">  441 </div><div id="442" class="line none">  442     *pctx = NULL;</div><div id="443" class="line none">  443     if (pub_key) {</div><div id="444" class="line none">  444         *pub_key = NULL;</div><div id="445" class="line none">  445     }</div><div id="446" class="line none">  446 </div><div id="447" class="line none">  447     if (!<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#28">curve_name</a>) {</div><div id="448" class="line none">  448         AWS_POSTCONDITION(!*pctx);</div><div id="449" class="line none">  449         AWS_POSTCONDITION(!pub_key || !*pub_key);</div><div id="450" class="line none">  450         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="451" class="line none">  451     }</div><div id="452" class="line none">  452 </div><div id="453" class="line none">  453     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a> = <a href="cipher_openssl.c.html#188">group_for_props</a>(<a href="cipher_openssl.c.html#75">props</a>);</div><div id="454" class="line none">  454     if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>) {</div><div id="455" class="line none">  455         goto err;</div><div id="456" class="line none">  456     }</div><div id="457" class="line none">  457 </div><div id="458" class="line none">  458     if (!(<a href="cipher_openssl.c.html#76">keypair</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#94">EC_KEY_new</a>())) {</div><div id="459" class="line none">  459         goto err;</div><div id="460" class="line none">  460     }</div><div id="461" class="line none">  461 </div><div id="462" class="line none">  462     if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#122">EC_KEY_set_group</a>(<a href="cipher_openssl.c.html#76">keypair</a>, <a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>)) {</div><div id="463" class="line none">  463         goto err;</div><div id="464" class="line none">  464     }</div><div id="465" class="line none">  465 </div><div id="466" class="line none">  466     if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#183">EC_KEY_generate_key</a>(<a href="cipher_openssl.c.html#76">keypair</a>)) {</div><div id="467" class="line none">  467         goto err;</div><div id="468" class="line none">  468     }</div><div id="469" class="line none">  469 </div><div id="470" class="line none">  470     if (pub_key &amp;&amp; <a href="cipher_openssl.c.html#259">serialize_pubkey</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, <a href="cipher_openssl.c.html#76">keypair</a>, pub_key)) {</div><div id="471" class="line none">  471         goto rethrow;</div><div id="472" class="line none">  472     }</div><div id="473" class="line none">  473 </div><div id="474" class="line none">  474     // If pub_key is NULL the conversion form is never set, and so it differs between the EC_KEY and EC_GROUP objects.</div><div id="475" class="line none">  475     // If this is not a problem this line can be removed, but ec_key_is_valid needs to be changed in the CBMC model.</div><div id="476" class="line none">  476     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#144">EC_KEY_set_conv_form</a>(<a href="cipher_openssl.c.html#76">keypair</a>, <a href="../verification/cbmc/include/openssl/ec.h.html#30">POINT_CONVERSION_COMPRESSED</a>);</div><div id="477" class="line none">  477 </div><div id="478" class="line none">  478     *pctx = <a href="cipher_openssl.c.html#210">sign_start</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, <a href="cipher_openssl.c.html#76">keypair</a>, <a href="cipher_openssl.c.html#75">props</a>);</div><div id="479" class="line none">  479     if (!*pctx) {</div><div id="480" class="line none">  480         goto rethrow;</div><div id="481" class="line none">  481     }</div><div id="482" class="line none">  482 </div><div id="483" class="line none">  483     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#210">EC_KEY_free</a>(<a href="cipher_openssl.c.html#76">keypair</a>);</div><div id="484" class="line none">  484     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#73">EC_GROUP_free</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>);</div><div id="485" class="line none">  485 </div><div id="486" class="line none">  486     AWS_POSTCONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(*pctx) &amp;&amp; (*pctx)-&gt;<a href="cipher_openssl.c.html#79">is_sign</a>);</div><div id="487" class="line none">  487     AWS_POSTCONDITION(!pub_key || <a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(*pub_key));</div><div id="488" class="line none">  488     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="489" class="line none">  489 </div><div id="490" class="line none">  490 err:</div><div id="491" class="line none">  491     <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="492" class="line none">  492 rethrow:</div><div id="493" class="line none">  493     <a href="cipher_openssl.c.html#510">aws_cryptosdk_sig_abort</a>(*pctx);</div><div id="494" class="line none">  494     *pctx = NULL;</div><div id="495" class="line none">  495 </div><div id="496" class="line none">  496     if (pub_key) {</div><div id="497" class="line none">  497         <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#132">aws_string_destroy</a>(*pub_key);</div><div id="498" class="line none">  498         *pub_key = NULL;</div><div id="499" class="line none">  499     }</div><div id="500" class="line none">  500 </div><div id="501" class="line none">  501     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#210">EC_KEY_free</a>(<a href="cipher_openssl.c.html#76">keypair</a>);</div><div id="502" class="line none">  502     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#73">EC_GROUP_free</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>);</div><div id="503" class="line none">  503 </div><div id="504" class="line none">  504     AWS_POSTCONDITION(!*pctx);</div><div id="505" class="line none">  505     AWS_POSTCONDITION(!pub_key || !*pub_key);</div><div id="506" class="line none">  506     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a>;</div><div id="507" class="line none">  507 }</div><div id="508" class="line none">  508 </div><div id="509" class="line none">  509 // TODO: add preconditions that if the ctx/pkey/keypair exist, they are valid.</div><div id="510" class="line none">  510 void <a href="cipher_openssl.c.html#510">aws_cryptosdk_sig_abort</a>(struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#78">ctx</a>) {</div><div id="511" class="line none">  511     AWS_PRECONDITION(<a href="cipher_openssl.c.html#78">ctx</a> == NULL || <a href="../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#112">aws_allocator_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>));</div><div id="512" class="line none">  512 </div><div id="513" class="line none">  513     if (!<a href="cipher_openssl.c.html#78">ctx</a>) {</div><div id="514" class="line none">  514         return;</div><div id="515" class="line none">  515     }</div><div id="516" class="line none">  516 </div><div id="517" class="line none">  517     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#753">EVP_MD_CTX_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="518" class="line none">  518     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#74">EVP_PKEY_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#77">pkey</a>);</div><div id="519" class="line none">  519     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#210">EC_KEY_free</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>);</div><div id="520" class="line none">  520 </div><div id="521" class="line none">  521     <a href="../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#201">aws_mem_release</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, <a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="522" class="line none">  522 }</div><div id="523" class="line none">  523 </div><div id="524" class="line none">  524 int <a href="cipher_openssl.c.html#524">aws_cryptosdk_sig_sign_start</a>(</div><div id="525" class="line none">  525     struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> **<a href="cipher_openssl.c.html#78">ctx</a>,</div><div id="526" class="line none">  526     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>,</div><div id="527" class="line none">  527     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> **pub_key_str,</div><div id="528" class="line none">  528     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>,</div><div id="529" class="line none">  529     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>) {</div><div id="530" class="line none">  530     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_WRITABLE(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="531" class="line none">  531     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_READABLE(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>));</div><div id="532" class="line none">  532     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_READABLE(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="533" class="line none">  533     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="534" class="line none">  534     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>));</div><div id="535" class="line none">  535     /* See comments in aws_cryptosdk_sig_get_privkey re the serialized format */</div><div id="536" class="line none">  536 </div><div id="537" class="line none">  537     *<a href="cipher_openssl.c.html#78">ctx</a> = NULL;</div><div id="538" class="line none">  538     if (pub_key_str) {</div><div id="539" class="line none">  539         *pub_key_str = NULL;</div><div id="540" class="line none">  540     }</div><div id="541" class="line none">  541 </div><div id="542" class="line none">  542     if (!<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#28">curve_name</a>) {</div><div id="543" class="line none">  543         AWS_POSTCONDITION(!*<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="544" class="line none">  544         AWS_POSTCONDITION(!pub_key_str || !*pub_key_str);</div><div id="545" class="line none">  545         AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>));</div><div id="546" class="line none">  546         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="547" class="line none">  547     }</div><div id="548" class="line none">  548 </div><div id="549" class="line none">  549     if (<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> &lt; 5) {</div><div id="550" class="line none">  550         // We don't have room for the algorithm ID plus the serialized private key.</div><div id="551" class="line none">  551         // Someone has apparently handed us a truncated private key?</div><div id="552" class="line none">  552         AWS_POSTCONDITION(!*<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="553" class="line none">  553         AWS_POSTCONDITION(!pub_key_str || !*pub_key_str);</div><div id="554" class="line none">  554         AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>));</div><div id="555" class="line none">  555         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="556" class="line none">  556     }</div><div id="557" class="line none">  557 </div><div id="558" class="line none">  558     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#33">EC_KEY</a> *<a href="cipher_openssl.c.html#76">keypair</a>             = NULL;</div><div id="559" class="line none">  559     <a href="../verification/cbmc/include/openssl/ec.h.html#38">EC_GROUP</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>             = NULL;</div><div id="560" class="line none">  560     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#23">ASN1_INTEGER</a> *priv_key_asn1 = NULL;</div><div id="561" class="line none">  561     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> *priv_key_bn         = NULL;</div><div id="562" class="line none">  562 </div><div id="563" class="line none">  563     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> cursor = <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#206">aws_byte_cursor_from_string</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>);</div><div id="564" class="line none">  564     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> field;</div><div id="565" class="line none">  565     uint16_t serialized_alg_id;</div><div id="566" class="line none">  566     uint8_t privkey_len, pubkey_len;</div><div id="567" class="line none">  567     const uint8_t *bufp;</div><div id="568" class="line none">  568     int rv;</div><div id="569" class="line none">  569 </div><div id="570" class="line none">  570     if (!<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#1176">aws_byte_cursor_read_be16</a>(&amp;cursor, &amp;serialized_alg_id) || !<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#1160">aws_byte_cursor_read_u8</a>(&amp;cursor, &amp;pubkey_len) ||</div><div id="571" class="line none">  571         !<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#1160">aws_byte_cursor_read_u8</a>(&amp;cursor, &amp;privkey_len)) {</div><div id="572" class="line none">  572         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="573" class="line none">  573         goto out;</div><div id="574" class="line none">  574     }</div><div id="575" class="line none">  575 </div><div id="576" class="line none">  576     if (serialized_alg_id != <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>) {</div><div id="577" class="line none">  577         // Algorithm mismatch</div><div id="578" class="line none">  578         AWS_POSTCONDITION(!*<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="579" class="line none">  579         AWS_POSTCONDITION(!pub_key_str || !*pub_key_str);</div><div id="580" class="line none">  580         AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>));</div><div id="581" class="line none">  581         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="582" class="line none">  582     }</div><div id="583" class="line none">  583 </div><div id="584" class="line none">  584     if (!(<a href="cipher_openssl.c.html#76">keypair</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#94">EC_KEY_new</a>())) {</div><div id="585" class="line none">  585         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="586" class="line none">  586         goto out;</div><div id="587" class="line none">  587     }</div><div id="588" class="line none">  588 </div><div id="589" class="line none">  589     if (!(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a> = <a href="cipher_openssl.c.html#188">group_for_props</a>(<a href="cipher_openssl.c.html#75">props</a>))) {</div><div id="590" class="line none">  590         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="591" class="line none">  591         goto out;</div><div id="592" class="line none">  592     }</div><div id="593" class="line none">  593 </div><div id="594" class="line none">  594     if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#122">EC_KEY_set_group</a>(<a href="cipher_openssl.c.html#76">keypair</a>, <a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>)) {</div><div id="595" class="line none">  595         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="596" class="line none">  596         <a href="../verification/cbmc/sources/openssl/ec_override.c.html#73">EC_GROUP_free</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>);</div><div id="597" class="line none">  597         goto out;</div><div id="598" class="line none">  598     }</div><div id="599" class="line none">  599     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#73">EC_GROUP_free</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>);</div><div id="600" class="line none">  600     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#144">EC_KEY_set_conv_form</a>(<a href="cipher_openssl.c.html#76">keypair</a>, <a href="../verification/cbmc/include/openssl/ec.h.html#30">POINT_CONVERSION_COMPRESSED</a>);</div><div id="601" class="line none">  601 </div><div id="602" class="line none">  602     field = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#1041">aws_byte_cursor_advance</a>(&amp;cursor, pubkey_len);</div><div id="603" class="line none">  603     bufp  = field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>;</div><div id="604" class="line none">  604 </div><div id="605" class="line none">  605     if (!field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a> || !<a href="../verification/cbmc/sources/openssl/ec_override.c.html#229">o2i_ECPublicKey</a>(&amp;<a href="cipher_openssl.c.html#76">keypair</a>, &amp;bufp, field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) || bufp != field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a> + field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="606" class="line none">  606         <a href="../verification/cbmc/include/openssl/err.h.html#22">ERR_print_errors_fp</a>(stderr);</div><div id="607" class="line none">  607         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="608" class="line none">  608         goto out;</div><div id="609" class="line none">  609     }</div><div id="610" class="line none">  610 </div><div id="611" class="line none">  611     field = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#1041">aws_byte_cursor_advance</a>(&amp;cursor, privkey_len);</div><div id="612" class="line none">  612     bufp  = field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>;</div><div id="613" class="line none">  613 </div><div id="614" class="line none">  614     if (!field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a> || !<a href="../verification/cbmc/include/openssl/asn1.h.html#25">d2i_ASN1_INTEGER</a>(&amp;priv_key_asn1, &amp;bufp, field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) || bufp != field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a> + field.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="615" class="line none">  615         <a href="../verification/cbmc/include/openssl/asn1.h.html#22">ASN1_STRING_clear_free</a>(priv_key_asn1);</div><div id="616" class="line none">  616         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="617" class="line none">  617         goto out;</div><div id="618" class="line none">  618     }</div><div id="619" class="line none">  619 </div><div id="620" class="line none">  620     priv_key_bn = <a href="../verification/cbmc/include/openssl/asn1.h.html#23">ASN1_INTEGER_to_BN</a>(priv_key_asn1, NULL);</div><div id="621" class="line none">  621     // ASN1_INTEGERS are really ASN1_STRINGS; since there's no ASN1_INTEGER_clear_free, we'll use</div><div id="622" class="line none">  622     // ASN1_STRING_clear_free instead.</div><div id="623" class="line none">  623     <a href="../verification/cbmc/include/openssl/asn1.h.html#22">ASN1_STRING_clear_free</a>(priv_key_asn1);</div><div id="624" class="line none">  624     if (!priv_key_bn) {</div><div id="625" class="line none">  625         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="626" class="line none">  626         goto out;</div><div id="627" class="line none">  627     }</div><div id="628" class="line none">  628 </div><div id="629" class="line none">  629     rv = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#154">EC_KEY_set_private_key</a>(<a href="cipher_openssl.c.html#76">keypair</a>, priv_key_bn);</div><div id="630" class="line none">  630     <a href="../verification/cbmc/sources/openssl/bn_override.c.html#85">BN_clear_free</a>(priv_key_bn);</div><div id="631" class="line none">  631     if (!rv) {</div><div id="632" class="line none">  632         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="633" class="line none">  633         goto out;</div><div id="634" class="line none">  634     }</div><div id="635" class="line none">  635 </div><div id="636" class="line none">  636     if (cursor.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) {</div><div id="637" class="line none">  637         // Trailing garbage in the serialized private key</div><div id="638" class="line none">  638         // This should never happen, as this is an internal (trusted) datapath, but</div><div id="639" class="line none">  639         // check anyway</div><div id="640" class="line none">  640         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="641" class="line none">  641         goto out;</div><div id="642" class="line none">  642     }</div><div id="643" class="line none">  643 </div><div id="644" class="line none">  644     if (pub_key_str &amp;&amp; <a href="cipher_openssl.c.html#259">serialize_pubkey</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, <a href="cipher_openssl.c.html#76">keypair</a>, pub_key_str)) {</div><div id="645" class="line none">  645         <a href="../verification/cbmc/sources/openssl/ec_override.c.html#210">EC_KEY_free</a>(<a href="cipher_openssl.c.html#76">keypair</a>);</div><div id="646" class="line none">  646         AWS_POSTCONDITION(!*<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="647" class="line none">  647         AWS_POSTCONDITION(!*pub_key_str);</div><div id="648" class="line none">  648         AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>));</div><div id="649" class="line none">  649         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a>;</div><div id="650" class="line none">  650     }</div><div id="651" class="line none">  651 </div><div id="652" class="line none">  652     *<a href="cipher_openssl.c.html#78">ctx</a> = <a href="cipher_openssl.c.html#210">sign_start</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, <a href="cipher_openssl.c.html#76">keypair</a>, <a href="cipher_openssl.c.html#75">props</a>);</div><div id="653" class="line none">  653     if (!*<a href="cipher_openssl.c.html#78">ctx</a> &amp;&amp; pub_key_str) {</div><div id="654" class="line none">  654         <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#132">aws_string_destroy</a>(*pub_key_str);</div><div id="655" class="line none">  655         *pub_key_str = NULL;</div><div id="656" class="line none">  656     }</div><div id="657" class="line none">  657 </div><div id="658" class="line none">  658 out:</div><div id="659" class="line none">  659     // EC_KEYs are reference counted</div><div id="660" class="line none">  660     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#210">EC_KEY_free</a>(<a href="cipher_openssl.c.html#76">keypair</a>);</div><div id="661" class="line none">  661     AWS_POSTCONDITION(!*<a href="cipher_openssl.c.html#78">ctx</a> || (<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(*<a href="cipher_openssl.c.html#78">ctx</a>) &amp;&amp; (*<a href="cipher_openssl.c.html#78">ctx</a>)-&gt;<a href="cipher_openssl.c.html#79">is_sign</a>));</div><div id="662" class="line none">  662     AWS_POSTCONDITION(!pub_key_str || (!*<a href="cipher_openssl.c.html#78">ctx</a> &amp;&amp; !*pub_key_str) || <a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(*pub_key_str));</div><div id="663" class="line none">  663     AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#85">priv_key</a>));</div><div id="664" class="line none">  664     return *<a href="cipher_openssl.c.html#78">ctx</a> ? <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a> : <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a>;</div><div id="665" class="line none">  665 }</div><div id="666" class="line none">  666 </div><div id="667" class="line none">  667 static int <a href="cipher_openssl.c.html#667">load_pubkey</a>(</div><div id="668" class="line none">  668     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#33">EC_KEY</a> **<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>, const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>, const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *pub_key_s) {</div><div id="669" class="line none">  669     int result                              = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="670" class="line none">  670     <a href="../verification/cbmc/include/openssl/ec.h.html#38">EC_GROUP</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>                         = NULL;</div><div id="671" class="line none">  671     uint8_t b64_decode_arr[<a href="cipher_openssl.c.html#37">MAX_PUBKEY_SIZE</a>] = { 0 };</div><div id="672" class="line none">  672     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> b64_decode_buf      = <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#910">aws_byte_buf_from_array</a>(b64_decode_arr, sizeof(b64_decode_arr));</div><div id="673" class="line none">  673     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> pub_key          = <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#206">aws_byte_cursor_from_string</a>(pub_key_s);</div><div id="674" class="line none">  674 </div><div id="675" class="line none">  675     *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a> = NULL;</div><div id="676" class="line none">  676 </div><div id="677" class="line none">  677     if (<a href="../verification/cbmc/aws-c-common/include/aws/common/encoding.h.html#82">aws_base64_decode</a>(&amp;pub_key, &amp;b64_decode_buf)) {</div><div id="678" class="line none">  678         /*</div><div id="679" class="line none">  679          * This'll happen if e.g. the public key is too large (aws_base64_decode checks the output buffer capacity),</div><div id="680" class="line none">  680          * or if it's just bad base64.</div><div id="681" class="line none">  681          */</div><div id="682" class="line none">  682         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT);</div><div id="683" class="line none">  683     }</div><div id="684" class="line none">  684 </div><div id="685" class="line none">  685     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a> = <a href="cipher_openssl.c.html#188">group_for_props</a>(<a href="cipher_openssl.c.html#75">props</a>);</div><div id="686" class="line none">  686     if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>) {</div><div id="687" class="line none">  687         goto out;</div><div id="688" class="line none">  688     }</div><div id="689" class="line none">  689 </div><div id="690" class="line none">  690     *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#94">EC_KEY_new</a>();</div><div id="691" class="line none">  691     if (*<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a> == NULL) {</div><div id="692" class="line none">  692         result = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>;</div><div id="693" class="line none">  693         goto out;</div><div id="694" class="line none">  694     }</div><div id="695" class="line none">  695     // We must set the group before decoding, to allow openssl to decompress the point</div><div id="696" class="line none">  696     if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#122">EC_KEY_set_group</a>(*<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>, <a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>)) {</div><div id="697" class="line none">  697         result = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="698" class="line none">  698         goto out;</div><div id="699" class="line none">  699     }</div><div id="700" class="line none">  700     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#144">EC_KEY_set_conv_form</a>(*<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>, <a href="../verification/cbmc/include/openssl/ec.h.html#30">POINT_CONVERSION_COMPRESSED</a>);</div><div id="701" class="line none">  701 </div><div id="702" class="line none">  702     const unsigned char *pBuf = b64_decode_buf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="703" class="line none">  703 </div><div id="704" class="line none">  704     if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#229">o2i_ECPublicKey</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>, &amp;pBuf, b64_decode_buf.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) {</div><div id="705" class="line none">  705         result = AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT;</div><div id="706" class="line none">  706         goto out;</div><div id="707" class="line none">  707     }</div><div id="708" class="line none">  708 </div><div id="709" class="line none">  709     result = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="710" class="line none">  710 out:</div><div id="711" class="line none">  711     // The EC_KEY_set_group method copies the provided group.</div><div id="712" class="line none">  712 </div><div id="713" class="line none">  713     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#73">EC_GROUP_free</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>);</div><div id="714" class="line none">  714     if (result) {</div><div id="715" class="line none">  715         <a href="../verification/cbmc/sources/openssl/ec_override.c.html#210">EC_KEY_free</a>(*<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a>);</div><div id="716" class="line none">  716         *<a href="../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#64">key</a> = NULL;</div><div id="717" class="line none">  717     }</div><div id="718" class="line none">  718     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(b64_decode_arr, sizeof(b64_decode_arr));</div><div id="719" class="line none">  719 </div><div id="720" class="line none">  720     return result ? <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(result) : <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="721" class="line none">  721 }</div><div id="722" class="line none">  722 </div><div id="723" class="line none">  723 int <a href="cipher_openssl.c.html#723">aws_cryptosdk_sig_verify_start</a>(</div><div id="724" class="line none">  724     struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> **pctx,</div><div id="725" class="line none">  725     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>,</div><div id="726" class="line none">  726     const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *pub_key,</div><div id="727" class="line none">  727     const struct <a href="../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="cipher_openssl.c.html#75">props</a>) {</div><div id="728" class="line none">  728     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(pub_key));</div><div id="729" class="line none">  729     AWS_PRECONDITION(<a href="cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="cipher_openssl.c.html#75">props</a>));</div><div id="730" class="line none">  730 </div><div id="731" class="line none">  731     *pctx = NULL;</div><div id="732" class="line none">  732 </div><div id="733" class="line none">  733     if (!<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../verification/cbmc/sources/openssl/ec_override.c.html#28">curve_name</a>) {</div><div id="734" class="line none">  734         AWS_POSTCONDITION(!*pctx);</div><div id="735" class="line none">  735         AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(pub_key));</div><div id="736" class="line none">  736         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="737" class="line none">  737     }</div><div id="738" class="line none">  738 </div><div id="739" class="line none">  739     struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#116">aws_mem_acquire</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, sizeof(*<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="740" class="line none">  740 </div><div id="741" class="line none">  741     if (!<a href="cipher_openssl.c.html#78">ctx</a>) {</div><div id="742" class="line none">  742         goto oom;</div><div id="743" class="line none">  743     }</div><div id="744" class="line none">  744 </div><div id="745" class="line none">  745     *<a href="cipher_openssl.c.html#78">ctx</a> = (struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a>){</div><div id="746" class="line none">  746         .<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a> = <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, .<a href="cipher_openssl.c.html#75">props</a> = <a href="cipher_openssl.c.html#75">props</a>, .<a href="cipher_openssl.c.html#76">keypair</a> = NULL, .<a href="cipher_openssl.c.html#77">pkey</a> = NULL, .<a href="cipher_openssl.c.html#79">is_sign</a> = false</div><div id="747" class="line none">  747     };</div><div id="748" class="line none">  748 </div><div id="749" class="line none">  749     if (<a href="cipher_openssl.c.html#667">load_pubkey</a>(&amp;<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>, <a href="cipher_openssl.c.html#75">props</a>, pub_key)) {</div><div id="750" class="line none">  750         goto rethrow;</div><div id="751" class="line none">  751     }</div><div id="752" class="line none">  752 </div><div id="753" class="line none">  753     if (!(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#77">pkey</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#32">EVP_PKEY_new</a>())) {</div><div id="754" class="line none">  754         goto oom;</div><div id="755" class="line none">  755     }</div><div id="756" class="line none">  756 </div><div id="757" class="line none">  757     if (!<a href="../verification/cbmc/sources/openssl/evp_override.c.html#59">EVP_PKEY_set1_EC_KEY</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#77">pkey</a>, <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>)) {</div><div id="758" class="line none">  758         goto oom;</div><div id="759" class="line none">  759     }</div><div id="760" class="line none">  760 </div><div id="761" class="line none">  761     if (!(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a> = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#729">EVP_MD_CTX_new</a>())) {</div><div id="762" class="line none">  762         goto oom;</div><div id="763" class="line none">  763     }</div><div id="764" class="line none">  764 </div><div id="765" class="line none">  765     if (!(<a href="../verification/cbmc/sources/openssl/evp_override.c.html#855">EVP_DigestVerifyInit</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a>, NULL, <a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../include/aws/cryptosdk/private/cipher.h.html#27">sig_md_ctor</a>(), NULL, <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#77">pkey</a>))) {</div><div id="766" class="line none">  766         <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="767" class="line none">  767         goto rethrow;</div><div id="768" class="line none">  768     }</div><div id="769" class="line none">  769 </div><div id="770" class="line none">  770     *pctx = <a href="cipher_openssl.c.html#78">ctx</a>;</div><div id="771" class="line none">  771 </div><div id="772" class="line none">  772     AWS_POSTCONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(*pctx));</div><div id="773" class="line none">  773     AWS_POSTCONDITION(!(*pctx)-&gt;<a href="cipher_openssl.c.html#79">is_sign</a>);</div><div id="774" class="line none">  774     AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(pub_key));</div><div id="775" class="line none">  775     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="776" class="line none">  776 </div><div id="777" class="line none">  777 oom:</div><div id="778" class="line none">  778     <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>);</div><div id="779" class="line none">  779 rethrow:</div><div id="780" class="line none">  780     if (<a href="cipher_openssl.c.html#78">ctx</a>) {</div><div id="781" class="line none">  781         <a href="cipher_openssl.c.html#510">aws_cryptosdk_sig_abort</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="782" class="line none">  782     }</div><div id="783" class="line none">  783 </div><div id="784" class="line none">  784     AWS_POSTCONDITION(!*pctx);</div><div id="785" class="line none">  785     AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(pub_key));</div><div id="786" class="line none">  786     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a>;</div><div id="787" class="line none">  787 }</div><div id="788" class="line none">  788 </div><div id="789" class="line none">  789 int <a href="cipher_openssl.c.html#789">aws_cryptosdk_sig_update</a>(struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#78">ctx</a>, const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> cursor) {</div><div id="790" class="line none">  790     AWS_PRECONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="791" class="line none">  791     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;cursor));</div><div id="792" class="line none">  792 </div><div id="793" class="line none">  793     if (cursor.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> == 0) {</div><div id="794" class="line none">  794         /* Nothing to do */</div><div id="795" class="line none">  795         AWS_POSTCONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="796" class="line none">  796         AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;cursor));</div><div id="797" class="line none">  797         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="798" class="line none">  798     }</div><div id="799" class="line none">  799 </div><div id="800" class="line none">  800     if (<a href="../verification/cbmc/sources/openssl/evp_override.c.html#791">EVP_DigestUpdate</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a>, cursor.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#41">ptr</a>, cursor.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) != 1) {</div><div id="801" class="line none">  801         return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN);</div><div id="802" class="line none">  802     }</div><div id="803" class="line none">  803 </div><div id="804" class="line none">  804     AWS_POSTCONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="805" class="line none">  805     AWS_POSTCONDITION(<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#64">aws_byte_cursor_is_valid</a>(&amp;cursor));</div><div id="806" class="line none">  806     return <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="807" class="line none">  807 }</div><div id="808" class="line none">  808 </div><div id="809" class="line none">  809 int <a href="cipher_openssl.c.html#809">aws_cryptosdk_sig_verify_finish</a>(struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#78">ctx</a>, const struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *signature) {</div><div id="810" class="line none">  810     AWS_PRECONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="811" class="line none">  811     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(signature));</div><div id="812" class="line none">  812     bool ok = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#880">EVP_DigestVerifyFinal</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a>, <a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#15">aws_string_bytes</a>(signature), signature-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>) == 1;</div><div id="813" class="line none">  813 </div><div id="814" class="line none">  814     <a href="cipher_openssl.c.html#510">aws_cryptosdk_sig_abort</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="815" class="line none">  815 </div><div id="816" class="line none">  816     return ok ? <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a> : <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT);</div><div id="817" class="line none">  817 }</div><div id="818" class="line none">  818 </div><div id="819" class="line none">  819 int <a href="cipher_openssl.c.html#819">aws_cryptosdk_sig_sign_finish</a>(</div><div id="820" class="line none">  820     struct <a href="../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="cipher_openssl.c.html#78">ctx</a>, struct <a href="../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, struct <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> **signature) {</div><div id="821" class="line none">  821     AWS_PRECONDITION(<a href="cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(<a href="cipher_openssl.c.html#78">ctx</a>));</div><div id="822" class="line none">  822     AWS_PRECONDITION(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>);</div><div id="823" class="line none">  823     AWS_PRECONDITION(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#79">is_sign</a>);</div><div id="824" class="line none">  824     AWS_PRECONDITION(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>);</div><div id="825" class="line none">  825     AWS_PRECONDITION(signature);</div><div id="826" class="line none">  826     int result = AWS_CRYPTOSDK_ERR_CRYPTO_UNKNOWN;</div><div id="827" class="line none">  827     /* This needs to be big enough for all digest algorithms in use */</div><div id="828" class="line none">  828     uint8_t digestbuf[64];</div><div id="829" class="line none">  829 </div><div id="830" class="line none">  830     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#35">EVP_PKEY_CTX</a> *sign_ctx     = NULL;</div><div id="831" class="line none">  831     <a href="../verification/cbmc/include/openssl/ec.h.html#45">ECDSA_SIG</a> *sig             = NULL;</div><div id="832" class="line none">  832     struct <a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> sigtmp = { 0 };</div><div id="833" class="line none">  833 </div><div id="834" class="line none">  834     size_t digestlen, siglen;</div><div id="835" class="line none">  835 </div><div id="836" class="line none">  836     digestlen = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#745">EVP_MD_CTX_size</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="837" class="line none">  837 </div><div id="838" class="line none">  838     const <a href="../verification/cbmc/include/openssl/ec.h.html#38">EC_GROUP</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#113">EC_KEY_get0_group</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#76">keypair</a>);</div><div id="839" class="line none">  839 #ifndef <a href="cipher_openssl.c.html#50">OSSL_100</a></div><div id="840" class="line none">  840     const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#30">order</a> = <a href="../verification/cbmc/sources/openssl/ec_override.c.html#65">EC_GROUP_get0_order</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>);</div><div id="841" class="line none">  841 #else</div><div id="842" class="line none">  842     <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#30">order</a> = <a href="../verification/cbmc/sources/openssl/bn_override.c.html#34">BN_new</a>();</div><div id="843" class="line none">  843 </div><div id="844" class="line none">  844     if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#30">order</a> || !EC_GROUP_get_order(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#83">group</a>, <a href="../verification/cbmc/sources/openssl/ec_override.c.html#30">order</a>, NULL)) {</div><div id="845" class="line none">  845         result = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>;</div><div id="846" class="line none">  846         goto out;</div><div id="847" class="line none">  847     }</div><div id="848" class="line none">  848 #endif</div><div id="849" class="line none">  849 </div><div id="850" class="line none">  850     if (digestlen &gt; sizeof(digestbuf)) {</div><div id="851" class="line none">  851         /* Should never happen */</div><div id="852" class="line none">  852         goto out;</div><div id="853" class="line none">  853     }</div><div id="854" class="line none">  854 </div><div id="855" class="line none">  855     if (1 != <a href="../verification/cbmc/sources/openssl/evp_override.c.html#836">EVP_DigestFinal</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#78">ctx</a>, digestbuf, NULL)) {</div><div id="856" class="line none">  856         goto out;</div><div id="857" class="line none">  857     }</div><div id="858" class="line none">  858 </div><div id="859" class="line none">  859     sign_ctx = <a href="../verification/cbmc/sources/openssl/evp_override.c.html#99">EVP_PKEY_CTX_new</a>(<a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#77">pkey</a>, NULL);</div><div id="860" class="line none">  860     if (!sign_ctx) {</div><div id="861" class="line none">  861         result = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>;</div><div id="862" class="line none">  862         goto out;</div><div id="863" class="line none">  863     }</div><div id="864" class="line none">  864 </div><div id="865" class="line none">  865     if (1 != <a href="../verification/cbmc/sources/openssl/evp_override.c.html#162">EVP_PKEY_sign_init</a>(sign_ctx)) {</div><div id="866" class="line none">  866         goto out;</div><div id="867" class="line none">  867     }</div><div id="868" class="line none">  868 </div><div id="869" class="line none">  869     if (1 != <a href="../verification/cbmc/sources/openssl/evp_override.c.html#184">EVP_PKEY_sign</a>(sign_ctx, NULL, &amp;siglen, digestbuf, digestlen)) {</div><div id="870" class="line none">  870         goto out;</div><div id="871" class="line none">  871     }</div><div id="872" class="line none">  872 </div><div id="873" class="line none">  873     /*</div><div id="874" class="line none">  874      * Note that siglen is the maximum possible size of a EC signature,</div><div id="875" class="line none">  875      * which may differ from the size we have set for AWSES signatures.</div><div id="876" class="line none">  876      * We'll allocate that much for the buffer capacity, and use a combination</div><div id="877" class="line none">  877      * of EC math and re-signing to hit the target size.</div><div id="878" class="line none">  878      *</div><div id="879" class="line none">  879      * It's important to hit the target precisely, as the caller might have</div><div id="880" class="line none">  880      * relied on a precise calculation of the ciphertext size in order to</div><div id="881" class="line none">  881      * e.g. set the S3 content-length on a PutObject, or otherwise preallocate</div><div id="882" class="line none">  882      * the destination space.</div><div id="883" class="line none">  883      */</div><div id="884" class="line none">  884     if (<a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#17">aws_byte_buf_init</a>(&amp;sigtmp, <a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, siglen)) {</div><div id="885" class="line none">  885         goto rethrow;</div><div id="886" class="line none">  886     }</div><div id="887" class="line none">  887 </div><div id="888" class="line none">  888     sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = 0;</div><div id="889" class="line none">  889 </div><div id="890" class="line none">  890     while (sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#88">signature_len</a>) {</div><div id="891" class="line none">  891         sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#29">capacity</a>;</div><div id="892" class="line none">  892         if (1 != <a href="../verification/cbmc/sources/openssl/evp_override.c.html#184">EVP_PKEY_sign</a>(sign_ctx, sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, &amp;sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>, digestbuf, digestlen)) {</div><div id="893" class="line none">  893             goto out;</div><div id="894" class="line none">  894         }</div><div id="895" class="line none">  895 </div><div id="896" class="line none">  896         if (sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> == <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#88">signature_len</a>) {</div><div id="897" class="line none">  897             break;</div><div id="898" class="line none">  898         }</div><div id="899" class="line none">  899 </div><div id="900" class="line none">  900         /*</div><div id="901" class="line none">  901          * The unpredictability of the signature length arises from DER encoding</div><div id="902" class="line none">  902          * requiring an extra byte to represent integers where the high bit is</div><div id="903" class="line none">  903          * aligned with the high bit of a byte, and is set - this would result</div><div id="904" class="line none">  904          * in an encoding which appears to be negative.</div><div id="905" class="line none">  905          *</div><div id="906" class="line none">  906          * In the vast majority of cases, we can resolve this by negating s in the</div><div id="907" class="line none">  907          * signature relative to the group order (which does not invalidate the</div><div id="908" class="line none">  908          * signature). If this fails, we'll just generate a brand new signature;</div><div id="909" class="line none">  909          * since ECDSA signatures contain a random component, this will usually either</div><div id="910" class="line none">  910          * get us to the desired size directly, or at least make it so the negation</div><div id="911" class="line none">  911          * trick works.</div><div id="912" class="line none">  912          */</div><div id="913" class="line none">  913         const unsigned char *psig = sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="914" class="line none">  914         if (<a href="../verification/cbmc/sources/openssl/ec_override.c.html#332">d2i_ECDSA_SIG</a>(&amp;sig, &amp;psig, sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>)) {</div><div id="915" class="line none">  915             const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> *orig_r, *orig_s;</div><div id="916" class="line none">  916             <a href="../verification/cbmc/sources/openssl/ec_override.c.html#290">ECDSA_SIG_get0</a>(sig, (const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> **)&amp;orig_r, (const <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> **)&amp;orig_s);</div><div id="917" class="line none">  917 </div><div id="918" class="line none">  918             <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a> = <a href="../verification/cbmc/sources/openssl/bn_override.c.html#49">BN_dup</a>(orig_r);</div><div id="919" class="line none">  919             <a href="../verification/cbmc/include/openssl/ossl_typ.h.html#31">BIGNUM</a> *<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a> = <a href="../verification/cbmc/sources/openssl/bn_override.c.html#49">BN_dup</a>(orig_s);</div><div id="920" class="line none">  920 </div><div id="921" class="line none">  921             if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a> || !<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>) {</div><div id="922" class="line none">  922                 result = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#145">AWS_ERROR_OOM</a>;</div><div id="923" class="line none">  923                 goto out;</div><div id="924" class="line none">  924             }</div><div id="925" class="line none">  925 </div><div id="926" class="line none">  926             if (!<a href="../verification/cbmc/sources/openssl/bn_override.c.html#63">BN_sub</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>, <a href="../verification/cbmc/sources/openssl/ec_override.c.html#30">order</a>, <a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>)) {</div><div id="927" class="line none">  927                 /* Signature values are not secret, so we just use BN_free here */</div><div id="928" class="line none">  928                 <a href="../verification/cbmc/sources/openssl/bn_override.c.html#77">BN_free</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a>);</div><div id="929" class="line none">  929                 <a href="../verification/cbmc/sources/openssl/bn_override.c.html#77">BN_free</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>);</div><div id="930" class="line none">  930                 goto out;</div><div id="931" class="line none">  931             }</div><div id="932" class="line none">  932 </div><div id="933" class="line none">  933             /*</div><div id="934" class="line none">  934              * This unconditionally frees the old r/s values, so it's important that</div><div id="935" class="line none">  935              * we BN_dup them above.</div><div id="936" class="line none">  936              */</div><div id="937" class="line none">  937             <a href="../verification/cbmc/sources/openssl/ec_override.c.html#305">ECDSA_SIG_set0</a>(sig, <a href="../verification/cbmc/sources/openssl/ec_override.c.html#282">r</a>, <a href="../verification/cbmc/sources/openssl/ec_override.c.html#283">s</a>);</div><div id="938" class="line none">  938 </div><div id="939" class="line none">  939             unsigned char *poutsig = sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="940" class="line none">  940             if (!<a href="../verification/cbmc/sources/openssl/ec_override.c.html#356">i2d_ECDSA_SIG</a>(sig, &amp;poutsig)) {</div><div id="941" class="line none">  941                 goto out;</div><div id="942" class="line none">  942             }</div><div id="943" class="line none">  943 </div><div id="944" class="line none">  944             sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> = poutsig - sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>;</div><div id="945" class="line none">  945         }</div><div id="946" class="line none">  946 </div><div id="947" class="line none">  947         <a href="../verification/cbmc/sources/openssl/ec_override.c.html#320">ECDSA_SIG_free</a>(sig);</div><div id="948" class="line none">  948         sig = NULL;</div><div id="949" class="line none">  949 </div><div id="950" class="line none">  950 #ifdef CBMC</div><div id="951" class="line none">  951         /* Loop is potentially unbounded but has a high probability of terminating after one or two iterations. This</div><div id="952" class="line none">  952          * assume forces the loop to terminate after one iteration during verification with CBMC. Since each iteration</div><div id="953" class="line none">  953          * of the loop is independent of the others, we assume that every memory-safety error that could occur can occur</div><div id="954" class="line none">  954          * in one iteration, and therefore would be caught by CBMC before reaching this assume. */</div><div id="955" class="line none">  955         __CPROVER_assume(sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> == <a href="cipher_openssl.c.html#78">ctx</a>-&gt;<a href="cipher_openssl.c.html#75">props</a>-&gt;<a href="../include/aws/cryptosdk/cipher.h.html#88">signature_len</a>);</div><div id="956" class="line none">  956 #endif</div><div id="957" class="line none">  957     }</div><div id="958" class="line none">  958 </div><div id="959" class="line none">  959     *signature = <a href="../verification/cbmc/aws-c-common/include/aws/common/string.h.html#108">aws_string_new_from_array</a>(<a href="../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, sigtmp.<a href="../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>);</div><div id="960" class="line none">  960     if (!*signature) {</div><div id="961" class="line none">  961         goto rethrow;</div><div id="962" class="line none">  962     }</div><div id="963" class="line none">  963 </div><div id="964" class="line none">  964     result = <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="965" class="line none">  965 out:</div><div id="966" class="line none">  966     if (result != <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>) <a href="../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(result);</div><div id="967" class="line none">  967 rethrow:</div><div id="968" class="line none">  968 #ifdef <a href="cipher_openssl.c.html#50">OSSL_100</a></div><div id="969" class="line none">  969     <a href="../verification/cbmc/sources/openssl/bn_override.c.html#77">BN_free</a>(<a href="../verification/cbmc/sources/openssl/ec_override.c.html#30">order</a>);</div><div id="970" class="line none">  970 #endif</div><div id="971" class="line none">  971     <a href="../verification/cbmc/sources/openssl/evp_override.c.html#402">EVP_PKEY_CTX_free</a>(sign_ctx);</div><div id="972" class="line none">  972     <a href="cipher_openssl.c.html#510">aws_cryptosdk_sig_abort</a>(<a href="cipher_openssl.c.html#78">ctx</a>);</div><div id="973" class="line none">  973     <a href="../verification/cbmc/aws-c-common/source/common.c.html#27">aws_secure_zero</a>(digestbuf, sizeof(digestbuf));</div><div id="974" class="line none">  974     <a href="../verification/cbmc/aws-c-common/source/byte_buf.c.html#76">aws_byte_buf_clean_up</a>(&amp;sigtmp);</div><div id="975" class="line none">  975     <a href="../verification/cbmc/sources/openssl/ec_override.c.html#320">ECDSA_SIG_free</a>(sig);</div><div id="976" class="line none">  976 </div><div id="977" class="line none">  977     if (result) {</div><div id="978" class="line none">  978         // We shouldn't have actually allocated signature, so just make sure it's NULL on an error path</div><div id="979" class="line none">  979         *signature = NULL;</div><div id="980" class="line none">  980     }</div><div id="981" class="line none">  981 </div><div id="982" class="line none">  982     AWS_POSTCONDITION(result == <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a> ? <a href="../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#34">aws_string_is_valid</a>(*signature) : !*signature);</div><div id="983" class="line none">  983     return result ? <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#16">AWS_OP_ERR</a> : <a href="../verification/cbmc/aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="984" class="line none">  984 }</div>
</div>
</body>
</html>
