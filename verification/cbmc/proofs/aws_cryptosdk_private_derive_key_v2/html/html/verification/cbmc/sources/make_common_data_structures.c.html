
<html>
<head>
<title>verification/cbmc/sources/make_common_data_structures.c</title>
<link rel="stylesheet" type="text/css" href="../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * Licensed under the Apache License, Version 2.0 (the "License"). You may not use</div><div id="5" class="line none">    5  * this file except in compliance with the License. A copy of the License is</div><div id="6" class="line none">    6  * located at</div><div id="7" class="line none">    7  *</div><div id="8" class="line none">    8  *     http://aws.amazon.com/apache2.0/</div><div id="9" class="line none">    9  *</div><div id="10" class="line none">   10  * or in the "license" file accompanying this file. This file is distributed on an</div><div id="11" class="line none">   11  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</div><div id="12" class="line none">   12  * implied. See the License for the specific language governing permissions and</div><div id="13" class="line none">   13  * limitations under the License.</div><div id="14" class="line none">   14  */</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 #include &lt;aws/cryptosdk/<a href="openssl/evp_override.c.html#437">cipher</a>.h&gt;</div><div id="17" class="line none">   17 #include &lt;aws/cryptosdk/<a href="../../../include/aws/cryptosdk/materials.h.html#177">keyring_trace</a>.h&gt;</div><div id="18" class="line none">   18 #include &lt;aws/cryptosdk/materials.h&gt;</div><div id="19" class="line none">   19 #include &lt;aws/cryptosdk/private/header.h&gt;</div><div id="20" class="line none">   20 #include &lt;aws/cryptosdk/private/hkdf.h&gt;</div><div id="21" class="line none">   21 #include &lt;aws/cryptosdk/private/<a href="../../../include/aws/cryptosdk/materials.h.html#177">keyring_trace</a>.h&gt;</div><div id="22" class="line none">   22 #include &lt;aws/cryptosdk/private/multi_keyring.h&gt;</div><div id="23" class="line none">   23 #include &lt;cipher_openssl.h&gt;</div><div id="24" class="line none">   24 #include &lt;ec_utils.h&gt;</div><div id="25" class="line none">   25 #include &lt;evp_utils.h&gt;</div><div id="26" class="line none">   26 </div><div id="27" class="line none">   27 #include &lt;openssl/ec.h&gt;</div><div id="28" class="line none">   28 #include &lt;openssl/evp.h&gt;</div><div id="29" class="line none">   29 </div><div id="30" class="line none">   30 #include &lt;proof_helpers/make_common_data_structures.h&gt;</div><div id="31" class="line none">   31 #include &lt;proof_helpers/proof_allocators.h&gt;</div><div id="32" class="line none">   32 </div><div id="33" class="line none">   33 const <a href="../include/openssl/ossl_typ.h.html#40">EVP_MD</a> *<a href="make_common_data_structures.c.html#33">nondet_EVP_MD_ptr</a>(void);</div><div id="34" class="line none">   34 const <a href="../include/openssl/ossl_typ.h.html#38">EVP_CIPHER</a> *<a href="make_common_data_structures.c.html#34">nondet_EVP_CIPHER_ptr</a>(void);</div><div id="35" class="line none">   35 </div><div id="36" class="line none">   36 struct <a href="../../../include/aws/cryptosdk/cipher.h.html#67">aws_cryptosdk_alg_impl</a> *<a href="make_common_data_structures.c.html#36">ensure_impl_attempt_allocation</a>(const size_t max_len) {</div><div id="37" class="line none">   37     struct <a href="../../../include/aws/cryptosdk/cipher.h.html#67">aws_cryptosdk_alg_impl</a> *<a href="../aws-c-common/include/aws/common/allocator.h.html#22">impl</a> = malloc(sizeof(struct <a href="../../../include/aws/cryptosdk/cipher.h.html#67">aws_cryptosdk_alg_impl</a>));</div><div id="38" class="line none">   38     if (<a href="../aws-c-common/include/aws/common/allocator.h.html#22">impl</a>) {</div><div id="39" class="line none">   39         *(const <a href="../include/openssl/ossl_typ.h.html#40">EVP_MD</a> **)(&amp;<a href="../aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../../../include/aws/cryptosdk/private/cipher.h.html#26">md_ctor</a>)         = (<a href="../aws-c-common/verification/cbmc/include/proof_helpers/nondet.h.html#15">nondet_bool</a>()) ? NULL : &amp;<a href="make_common_data_structures.c.html#33">nondet_EVP_MD_ptr</a>;</div><div id="40" class="line none">   40         *(const <a href="../include/openssl/ossl_typ.h.html#40">EVP_MD</a> **)(&amp;<a href="../aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../../../include/aws/cryptosdk/private/cipher.h.html#27">sig_md_ctor</a>)     = (<a href="../aws-c-common/verification/cbmc/include/proof_helpers/nondet.h.html#15">nondet_bool</a>()) ? NULL : &amp;<a href="make_common_data_structures.c.html#33">nondet_EVP_MD_ptr</a>;</div><div id="41" class="line none">   41         *(const <a href="../include/openssl/ossl_typ.h.html#38">EVP_CIPHER</a> **)(&amp;<a href="../aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="../../../include/aws/cryptosdk/private/cipher.h.html#28">cipher_ctor</a>) = (<a href="../aws-c-common/verification/cbmc/include/proof_helpers/nondet.h.html#15">nondet_bool</a>()) ? NULL : &amp;<a href="make_common_data_structures.c.html#34">nondet_EVP_CIPHER_ptr</a>;</div><div id="42" class="line none">   42         *(const char **)(&amp;<a href="../aws-c-common/include/aws/common/allocator.h.html#22">impl</a>-&gt;<a href="openssl/ec_override.c.html#28">curve_name</a>)        = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#213">ensure_c_str_is_allocated</a>(max_len);</div><div id="43" class="line none">   43     }</div><div id="44" class="line none">   44     return <a href="../aws-c-common/include/aws/common/allocator.h.html#22">impl</a>;</div><div id="45" class="line none">   45 }</div><div id="46" class="line none">   46 struct <a href="../../../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="make_common_data_structures.c.html#46">ensure_alg_properties_attempt_allocation</a>(const size_t max_len) {</div><div id="47" class="line hit">   47     struct <a href="../../../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *alg_props = malloc(sizeof(struct <a href="../../../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a>));</div><div id="48" class="line hit">   48     if (alg_props) {</div><div id="49" class="line hit">   49         alg_props-&gt;<a href="../../../include/aws/cryptosdk/cipher.h.html#56">md_name</a>     = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#213">ensure_c_str_is_allocated</a>(max_len);</div><div id="50" class="line hit">   50         alg_props-&gt;<a href="../../../include/aws/cryptosdk/cipher.h.html#58">cipher_name</a> = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#213">ensure_c_str_is_allocated</a>(max_len);</div><div id="51" class="line hit">   51         alg_props-&gt;<a href="../../../include/aws/cryptosdk/cipher.h.html#60">alg_name</a>    = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#213">ensure_c_str_is_allocated</a>(max_len);</div><div id="52" class="line hit">   52         alg_props-&gt;<a href="../../../include/aws/cryptosdk/cipher.h.html#112">sig_md_name</a> = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#213">ensure_c_str_is_allocated</a>(max_len);</div><div id="53" class="line hit">   53         alg_props-&gt;<a href="../aws-c-common/include/aws/common/allocator.h.html#22">impl</a>        = malloc(sizeof(struct <a href="../../../include/aws/cryptosdk/cipher.h.html#67">aws_cryptosdk_alg_impl</a>));</div><div id="54" class="line hit">   54     }</div><div id="55" class="line hit">   55     return alg_props;</div><div id="56" class="line hit">   56 }</div><div id="57" class="line none">   57 </div><div id="58" class="line none">   58 struct <a href="../../../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="make_common_data_structures.c.html#58">ensure_content_key_attempt_allocation</a>() {</div><div id="59" class="line hit">   59     struct <a href="../../../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../aws-c-common/include/aws/common/hash_table.h.html#64">key</a> = malloc(sizeof(uint8_t) * <a href="../../../include/aws/cryptosdk/private/cipher.h.html#37">MAX_DATA_KEY_SIZE</a>);</div><div id="60" class="line hit">   60     return <a href="../aws-c-common/include/aws/common/hash_table.h.html#64">key</a>;</div><div id="61" class="line hit">   61 }</div><div id="62" class="line none">   62 </div><div id="63" class="line none">   63 struct <a href="../../../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a> *<a href="make_common_data_structures.c.html#63">ensure_data_key_attempt_allocation</a>() {</div><div id="64" class="line hit">   64     struct <a href="../../../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a> *<a href="../aws-c-common/include/aws/common/hash_table.h.html#64">key</a> = malloc(sizeof(uint8_t) * <a href="../../../include/aws/cryptosdk/private/cipher.h.html#37">MAX_DATA_KEY_SIZE</a>);</div><div id="65" class="line hit">   65     return <a href="../aws-c-common/include/aws/common/hash_table.h.html#64">key</a>;</div><div id="66" class="line hit">   66 }</div><div id="67" class="line none">   67 </div><div id="68" class="line none">   68 void <a href="make_common_data_structures.c.html#68">ensure_record_has_allocated_members</a>(struct <a href="../../../include/aws/cryptosdk/keyring_trace.h.html#50">aws_cryptosdk_keyring_trace_record</a> *record, size_t max_len) {</div><div id="69" class="line none">   69     record-&gt;<a href="../../../include/aws/cryptosdk/keyring_trace.h.html#51">wrapping_key_namespace</a> = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#187">ensure_string_is_allocated_nondet_length</a>();</div><div id="70" class="line none">   70     if (record-&gt;<a href="../../../include/aws/cryptosdk/keyring_trace.h.html#51">wrapping_key_namespace</a>) {</div><div id="71" class="line none">   71         __CPROVER_assume(record-&gt;<a href="../../../include/aws/cryptosdk/keyring_trace.h.html#51">wrapping_key_namespace</a>-&gt;<a href="../aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> &lt;= max_len);</div><div id="72" class="line none">   72     }</div><div id="73" class="line none">   73     record-&gt;<a href="../../../include/aws/cryptosdk/keyring_trace.h.html#52">wrapping_key_name</a> = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#187">ensure_string_is_allocated_nondet_length</a>();</div><div id="74" class="line none">   74     if (record-&gt;<a href="../../../include/aws/cryptosdk/keyring_trace.h.html#52">wrapping_key_name</a>) {</div><div id="75" class="line none">   75         __CPROVER_assume(record-&gt;<a href="../../../include/aws/cryptosdk/keyring_trace.h.html#52">wrapping_key_name</a>-&gt;<a href="../aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> &lt;= max_len);</div><div id="76" class="line none">   76     }</div><div id="77" class="line none">   77     record-&gt;<a href="../../../include/aws/cryptosdk/keyring_trace.h.html#53">flags</a> = malloc(sizeof(uint32_t));</div><div id="78" class="line none">   78 }</div><div id="79" class="line none">   79 </div><div id="80" class="line none">   80 void <a href="make_common_data_structures.c.html#80">ensure_trace_has_allocated_records</a>(struct <a href="../aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *trace, size_t max_len) {</div><div id="81" class="line none">   81     /* iterate over each record in the keyring trace */</div><div id="82" class="line none">   82     size_t num_records = <a href="../aws-c-common/include/aws/common/array_list.inl.html#307">aws_array_list_length</a>(trace);</div><div id="83" class="line none">   83     for (size_t idx = 0; idx &lt; num_records; ++idx) {</div><div id="84" class="line none">   84         struct <a href="../../../include/aws/cryptosdk/keyring_trace.h.html#50">aws_cryptosdk_keyring_trace_record</a> *record;</div><div id="85" class="line none">   85         if (!<a href="../aws-c-common/include/aws/common/array_list.inl.html#335">aws_array_list_get_at_ptr</a>(trace, (void **)&amp;record, idx)) {</div><div id="86" class="line none">   86             /* make sure each record is valid */</div><div id="87" class="line none">   87             <a href="make_common_data_structures.c.html#68">ensure_record_has_allocated_members</a>(record, max_len);</div><div id="88" class="line none">   88         }</div><div id="89" class="line none">   89     }</div><div id="90" class="line none">   90 }</div><div id="91" class="line none">   91 </div><div id="92" class="line none">   92 void <a href="make_common_data_structures.c.html#92">ensure_md_context_has_allocated_members</a>(struct <a href="../../../include/aws/cryptosdk/private/cipher.h.html#47">aws_cryptosdk_md_context</a> *<a href="../../../source/cipher_openssl.c.html#78">ctx</a>) {</div><div id="93" class="line none">   93     <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>      = <a href="../aws-c-common/verification/cbmc/include/proof_helpers/nondet.h.html#15">nondet_bool</a>() ? NULL : <a href="../aws-c-common/verification/cbmc/sources/proof_allocators.c.html#68">can_fail_allocator</a>();</div><div id="94" class="line none">   94     <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#93">evp_md_ctx</a> = <a href="openssl/evp_override.c.html#1041">evp_md_ctx_nondet_alloc</a>();</div><div id="95" class="line none">   95 }</div><div id="96" class="line none">   96 </div><div id="97" class="line none">   97 struct <a href="../../../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="make_common_data_structures.c.html#97">ensure_nondet_sig_ctx_has_allocated_members</a>() {</div><div id="98" class="line none">   98     struct <a href="../../../include/aws/cryptosdk/cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="../../../source/cipher_openssl.c.html#78">ctx</a> = malloc(sizeof(*<a href="../../../source/cipher_openssl.c.html#78">ctx</a>));</div><div id="99" class="line none">   99     if (<a href="../../../source/cipher_openssl.c.html#78">ctx</a> == NULL) {</div><div id="100" class="line none">  100         return NULL;</div><div id="101" class="line none">  101     }</div><div id="102" class="line none">  102     <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#16">alloc</a> = <a href="../aws-c-common/verification/cbmc/include/proof_helpers/nondet.h.html#15">nondet_bool</a>() ? NULL : <a href="../aws-c-common/verification/cbmc/sources/proof_allocators.c.html#68">can_fail_allocator</a>();</div><div id="103" class="line none">  103     enum <a href="../../../include/aws/cryptosdk/header.h.html#26">aws_cryptosdk_alg_id</a> <a href="../../../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>;</div><div id="104" class="line none">  104     <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#75">props</a>   = <a href="../../../source/cipher.c.html#33">aws_cryptosdk_alg_props</a>(<a href="../../../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>);</div><div id="105" class="line none">  105     <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#76">keypair</a> = <a href="openssl/ec_override.c.html#402">ec_key_nondet_alloc</a>();</div><div id="106" class="line none">  106     <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#77">pkey</a>    = <a href="openssl/evp_override.c.html#999">evp_pkey_nondet_alloc</a>();</div><div id="107" class="line none">  107     <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#78">ctx</a>     = <a href="openssl/evp_override.c.html#1041">evp_md_ctx_nondet_alloc</a>();</div><div id="108" class="line none">  108 </div><div id="109" class="line none">  109     // Need to ensure consistency of reference count later by assuming ctx is valid</div><div id="110" class="line none">  110     <a href="openssl/evp_override.c.html#1010">evp_pkey_set0_ec_key</a>(<a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#77">pkey</a>, <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#76">keypair</a>);</div><div id="111" class="line none">  111 </div><div id="112" class="line none">  112     if (<a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#79">is_sign</a>) {</div><div id="113" class="line none">  113         <a href="openssl/evp_override.c.html#1061">evp_md_ctx_set0_evp_pkey</a>(<a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#78">ctx</a>, NULL);</div><div id="114" class="line none">  114     } else {</div><div id="115" class="line none">  115         // Need to ensure consistency of reference count later by assuming ctx is valid</div><div id="116" class="line none">  116         <a href="openssl/evp_override.c.html#1061">evp_md_ctx_set0_evp_pkey</a>(<a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#78">ctx</a>, <a href="../../../source/cipher_openssl.c.html#78">ctx</a>-&gt;<a href="../../../source/cipher_openssl.c.html#77">pkey</a>);</div><div id="117" class="line none">  117     }</div><div id="118" class="line none">  118     return <a href="../../../source/cipher_openssl.c.html#78">ctx</a>;</div><div id="119" class="line none">  119 }</div><div id="120" class="line none">  120 </div><div id="121" class="line none">  121 bool <a href="make_common_data_structures.c.html#121">aws_cryptosdk_edk_is_bounded</a>(const struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a> *edk, const size_t max_size) {</div><div id="122" class="line none">  122     return <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#13">aws_byte_buf_is_bounded</a>(&amp;edk-&gt;<a href="../../../include/aws/cryptosdk/edk.h.html#40">provider_id</a>, max_size) &amp;&amp;</div><div id="123" class="line none">  123            <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#13">aws_byte_buf_is_bounded</a>(&amp;edk-&gt;<a href="../../../include/aws/cryptosdk/edk.h.html#41">provider_info</a>, max_size) &amp;&amp;</div><div id="124" class="line none">  124            <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#13">aws_byte_buf_is_bounded</a>(&amp;edk-&gt;<a href="../../../include/aws/cryptosdk/edk.h.html#42">ciphertext</a>, max_size);</div><div id="125" class="line none">  125 }</div><div id="126" class="line none">  126 </div><div id="127" class="line none">  127 void <a href="make_common_data_structures.c.html#127">ensure_cryptosdk_edk_has_allocated_members</a>(struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a> *edk) {</div><div id="128" class="line none">  128     <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#21">ensure_byte_buf_has_allocated_buffer_member</a>(&amp;edk-&gt;<a href="../../../include/aws/cryptosdk/edk.h.html#40">provider_id</a>);</div><div id="129" class="line none">  129     <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#21">ensure_byte_buf_has_allocated_buffer_member</a>(&amp;edk-&gt;<a href="../../../include/aws/cryptosdk/edk.h.html#41">provider_info</a>);</div><div id="130" class="line none">  130     <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#21">ensure_byte_buf_has_allocated_buffer_member</a>(&amp;edk-&gt;<a href="../../../include/aws/cryptosdk/edk.h.html#42">ciphertext</a>);</div><div id="131" class="line none">  131 }</div><div id="132" class="line none">  132 </div><div id="133" class="line none">  133 bool <a href="make_common_data_structures.c.html#133">aws_cryptosdk_edk_list_is_bounded</a>(</div><div id="134" class="line none">  134     const struct <a href="../aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *const list, const size_t max_initial_item_allocation) {</div><div id="135" class="line none">  135     if (list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#19">item_size</a> != sizeof(struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a>)) {</div><div id="136" class="line none">  136         return false;</div><div id="137" class="line none">  137     }</div><div id="138" class="line none">  138     if (list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#18">length</a> &gt; max_initial_item_allocation) {</div><div id="139" class="line none">  139         return false;</div><div id="140" class="line none">  140     }</div><div id="141" class="line none">  141 </div><div id="142" class="line none">  142     return true;</div><div id="143" class="line none">  143 }</div><div id="144" class="line none">  144 </div><div id="145" class="line none">  145 bool <a href="make_common_data_structures.c.html#145">aws_cryptosdk_edk_list_elements_are_bounded</a>(const struct <a href="../aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *const list, const size_t max_item_size) {</div><div id="146" class="line none">  146     for (size_t i = 0; i &lt; list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#18">length</a>; ++i) {</div><div id="147" class="line none">  147         struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a> *<a href="../aws-c-common/include/aws/common/array_list.h.html#20">data</a> = (struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a> *)list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#20">data</a>;</div><div id="148" class="line none">  148         if (!<a href="make_common_data_structures.c.html#121">aws_cryptosdk_edk_is_bounded</a>(&amp;(<a href="../aws-c-common/include/aws/common/array_list.h.html#20">data</a>[i]), max_item_size)) {</div><div id="149" class="line none">  149             return false;</div><div id="150" class="line none">  150         }</div><div id="151" class="line none">  151     }</div><div id="152" class="line none">  152     return true;</div><div id="153" class="line none">  153 }</div><div id="154" class="line none">  154 </div><div id="155" class="line none">  155 void <a href="make_common_data_structures.c.html#155">ensure_cryptosdk_edk_list_has_allocated_list</a>(struct <a href="../aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *list) {</div><div id="156" class="line none">  156     if (list != NULL) {</div><div id="157" class="line none">  157         if (list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#17">current_size</a> == 0) {</div><div id="158" class="line none">  158             __CPROVER_assume(list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#20">data</a> == NULL);</div><div id="159" class="line none">  159             list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#16">alloc</a> = <a href="../aws-c-common/verification/cbmc/sources/proof_allocators.c.html#68">can_fail_allocator</a>();</div><div id="160" class="line none">  160         } else {</div><div id="161" class="line none">  161             size_t max_length = list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#17">current_size</a> / sizeof(struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a>);</div><div id="162" class="line none">  162             list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#20">data</a>        = <a href="../aws-c-common/verification/cbmc/sources/proof_allocators.c.html#62">bounded_malloc</a>(sizeof(struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a>) * max_length);</div><div id="163" class="line none">  163             list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>       = <a href="../aws-c-common/verification/cbmc/include/proof_helpers/nondet.h.html#15">nondet_bool</a>() ? NULL : <a href="../aws-c-common/verification/cbmc/sources/proof_allocators.c.html#68">can_fail_allocator</a>();</div><div id="164" class="line none">  164         }</div><div id="165" class="line none">  165     }</div><div id="166" class="line none">  166 }</div><div id="167" class="line none">  167 </div><div id="168" class="line none">  168 void <a href="make_common_data_structures.c.html#168">ensure_cryptosdk_edk_list_has_allocated_list_elements</a>(struct <a href="../aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *list) {</div><div id="169" class="line none">  169     if (<a href="../../../include/aws/cryptosdk/edk.h.html#62">aws_cryptosdk_edk_list_is_valid</a>(list)) {</div><div id="170" class="line none">  170         for (size_t i = 0; i &lt; list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#18">length</a>; ++i) {</div><div id="171" class="line none">  171             struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a> *<a href="../aws-c-common/include/aws/common/array_list.h.html#20">data</a> = (struct <a href="../../../include/aws/cryptosdk/edk.h.html#39">aws_cryptosdk_edk</a> *)list-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#20">data</a>;</div><div id="172" class="line none">  172             <a href="make_common_data_structures.c.html#127">ensure_cryptosdk_edk_has_allocated_members</a>(&amp;(<a href="../aws-c-common/include/aws/common/array_list.h.html#20">data</a>[i]));</div><div id="173" class="line none">  173         }</div><div id="174" class="line none">  174     }</div><div id="175" class="line none">  175 }</div><div id="176" class="line none">  176 </div><div id="177" class="line none">  177 struct <a href="../../../include/aws/cryptosdk/private/header.h.html#24">aws_cryptosdk_hdr</a> *<a href="make_common_data_structures.c.html#177">ensure_nondet_hdr_has_allocated_members</a>(const size_t max_table_size) {</div><div id="178" class="line none">  178     struct <a href="../../../include/aws/cryptosdk/private/header.h.html#24">aws_cryptosdk_hdr</a> *hdr = malloc(sizeof(*hdr));</div><div id="179" class="line none">  179     if (hdr != NULL) {</div><div id="180" class="line none">  180         hdr-&gt;<a href="../aws-c-common/include/aws/common/array_list.h.html#16">alloc</a> = <a href="../aws-c-common/verification/cbmc/include/proof_helpers/nondet.h.html#15">nondet_bool</a>() ? NULL : <a href="../aws-c-common/verification/cbmc/sources/proof_allocators.c.html#68">can_fail_allocator</a>();</div><div id="181" class="line none">  181         <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#21">ensure_byte_buf_has_allocated_buffer_member</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#31">iv</a>);</div><div id="182" class="line none">  182         <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#21">ensure_byte_buf_has_allocated_buffer_member</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#31">auth_tag</a>);</div><div id="183" class="line none">  183         <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#21">ensure_byte_buf_has_allocated_buffer_member</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>);</div><div id="184" class="line none">  184         <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#21">ensure_byte_buf_has_allocated_buffer_member</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#31">alg_suite_data</a>);</div><div id="185" class="line none">  185         <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#143">ensure_allocated_hash_table</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#34">enc_ctx</a>, max_table_size);</div><div id="186" class="line none">  186         <a href="make_common_data_structures.c.html#155">ensure_cryptosdk_edk_list_has_allocated_list</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#35">edk_list</a>);</div><div id="187" class="line none">  187     }</div><div id="188" class="line none">  188     return hdr;</div><div id="189" class="line none">  189 }</div><div id="190" class="line none">  190 </div><div id="191" class="line none">  191 bool <a href="make_common_data_structures.c.html#191">aws_cryptosdk_hdr_members_are_bounded</a>(</div><div id="192" class="line none">  192     const struct <a href="../../../include/aws/cryptosdk/private/header.h.html#24">aws_cryptosdk_hdr</a> *hdr, const size_t max_edk_item_size, const size_t max_item_size) {</div><div id="193" class="line none">  193     if (hdr != NULL) {</div><div id="194" class="line none">  194         /*IV buffer length might need further constraints, this is done in the harness when necessary */</div><div id="195" class="line none">  195         return <a href="make_common_data_structures.c.html#133">aws_cryptosdk_edk_list_is_bounded</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#35">edk_list</a>, max_edk_item_size) &amp;&amp;</div><div id="196" class="line none">  196                (!<a href="../../../include/aws/cryptosdk/edk.h.html#62">aws_cryptosdk_edk_list_is_valid</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#35">edk_list</a>) ||</div><div id="197" class="line none">  197                 <a href="make_common_data_structures.c.html#145">aws_cryptosdk_edk_list_elements_are_bounded</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#35">edk_list</a>, max_item_size)) &amp;&amp;</div><div id="198" class="line none">  198                <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#13">aws_byte_buf_is_bounded</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#31">iv</a>, max_item_size) &amp;&amp;</div><div id="199" class="line none">  199                <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#13">aws_byte_buf_is_bounded</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#31">auth_tag</a>, max_item_size) &amp;&amp;</div><div id="200" class="line none">  200                <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#13">aws_byte_buf_is_bounded</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>, max_item_size) &amp;&amp;</div><div id="201" class="line none">  201                <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#13">aws_byte_buf_is_bounded</a>(&amp;hdr-&gt;<a href="../../../include/aws/cryptosdk/private/header.h.html#31">alg_suite_data</a>, max_item_size);</div><div id="202" class="line none">  202     }</div><div id="203" class="line none">  203     return true; /* If hdr is NULL, true by default */</div><div id="204" class="line none">  204 }</div><div id="205" class="line none">  205 </div><div id="206" class="line none">  206 enum <a href="../../../include/aws/cryptosdk/private/hkdf.h.html#21">aws_cryptosdk_sha_version</a> <a href="../../../source/cipher.c.html#239">aws_cryptosdk_which_sha</a>(enum <a href="../../../include/aws/cryptosdk/header.h.html#26">aws_cryptosdk_alg_id</a> <a href="../../../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>) {</div><div id="207" class="line hit">  207     switch (<a href="../../../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>) {</div><div id="208" class="line none">  208         case <a href="../../../include/aws/cryptosdk/header.h.html#27">ALG_AES256_GCM_HKDF_SHA512_COMMIT_KEY_ECDSA_P384</a>:</div><div id="209" class="line both">  209         case <a href="../../../include/aws/cryptosdk/header.h.html#28">ALG_AES256_GCM_HKDF_SHA512_COMMIT_KEY</a>: return <a href="../../../include/aws/cryptosdk/private/hkdf.h.html#25">AWS_CRYPTOSDK_SHA512</a>;</div><div id="210" class="line none">  210         case <a href="../../../include/aws/cryptosdk/header.h.html#29">ALG_AES256_GCM_IV12_TAG16_HKDF_SHA384_ECDSA_P384</a>:</div><div id="211" class="line both">  211         case <a href="../../../include/aws/cryptosdk/header.h.html#30">ALG_AES192_GCM_IV12_TAG16_HKDF_SHA384_ECDSA_P384</a>: return <a href="../../../include/aws/cryptosdk/private/hkdf.h.html#24">AWS_CRYPTOSDK_SHA384</a>;</div><div id="212" class="line none">  212         case <a href="../../../include/aws/cryptosdk/header.h.html#31">ALG_AES128_GCM_IV12_TAG16_HKDF_SHA256_ECDSA_P256</a>:</div><div id="213" class="line none">  213         case <a href="../../../include/aws/cryptosdk/header.h.html#32">ALG_AES256_GCM_IV12_TAG16_HKDF_SHA256</a>:</div><div id="214" class="line none">  214         case <a href="../../../include/aws/cryptosdk/header.h.html#33">ALG_AES192_GCM_IV12_TAG16_HKDF_SHA256</a>:</div><div id="215" class="line both">  215         case <a href="../../../include/aws/cryptosdk/header.h.html#34">ALG_AES128_GCM_IV12_TAG16_HKDF_SHA256</a>: return <a href="../../../include/aws/cryptosdk/private/hkdf.h.html#23">AWS_CRYPTOSDK_SHA256</a>;</div><div id="216" class="line none">  216         case <a href="../../../include/aws/cryptosdk/header.h.html#35">ALG_AES256_GCM_IV12_TAG16_NO_KDF</a>:</div><div id="217" class="line none">  217         case <a href="../../../include/aws/cryptosdk/header.h.html#36">ALG_AES192_GCM_IV12_TAG16_NO_KDF</a>:</div><div id="218" class="line hit">  218         case <a href="../../../include/aws/cryptosdk/header.h.html#37">ALG_AES128_GCM_IV12_TAG16_NO_KDF</a>:</div><div id="219" class="line both">  219         default: return <a href="../../../include/aws/cryptosdk/private/hkdf.h.html#22">AWS_CRYPTOSDK_NOSHA</a>;</div><div id="220" class="line none">  220     }</div><div id="221" class="line both">  221 }</div><div id="222" class="line none">  222 </div><div id="223" class="line none">  223 void <a href="make_common_data_structures.c.html#223">ensure_cryptosdk_keyring_has_allocated_members</a>(</div><div id="224" class="line none">  224     struct <a href="../../../include/aws/cryptosdk/materials.h.html#96">aws_cryptosdk_keyring</a> *keyring, const struct <a href="../../../include/aws/cryptosdk/materials.h.html#98">aws_cryptosdk_keyring_vt</a> *<a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>) {</div><div id="225" class="line none">  225     if (keyring) {</div><div id="226" class="line none">  226         keyring-&gt;<a href="../../../include/aws/cryptosdk/materials.h.html#84">refcount</a>.<a href="../aws-c-common/include/aws/common/atomics.h.html#17">value</a> = malloc(sizeof(size_t));</div><div id="227" class="line none">  227         keyring-&gt;<a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>         = <a href="../aws-c-common/verification/cbmc/include/proof_helpers/nondet.h.html#15">nondet_bool</a>() ? NULL : <a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>;</div><div id="228" class="line none">  228     }</div><div id="229" class="line none">  229 }</div><div id="230" class="line none">  230 </div><div id="231" class="line none">  231 void <a href="make_common_data_structures.c.html#231">ensure_nondet_allocate_keyring_vtable_members</a>(struct <a href="../../../include/aws/cryptosdk/materials.h.html#98">aws_cryptosdk_keyring_vt</a> *<a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>, size_t max_len) {</div><div id="232" class="line none">  232     if (<a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>) {</div><div id="233" class="line none">  233         <a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>-&gt;<a href="../../../include/aws/cryptosdk/materials.h.html#377">name</a> = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#213">ensure_c_str_is_allocated</a>(max_len);</div><div id="234" class="line none">  234     }</div><div id="235" class="line none">  235 }</div><div id="236" class="line none">  236 </div><div id="237" class="line none">  237 void <a href="make_common_data_structures.c.html#237">ensure_nondet_allocate_cmm_vtable_members</a>(struct <a href="../../../include/aws/cryptosdk/materials.h.html#85">aws_cryptosdk_cmm_vt</a> *<a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>, size_t max_len) {</div><div id="238" class="line none">  238     if (<a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>) {</div><div id="239" class="line none">  239         <a href="../../../include/aws/cryptosdk/materials.h.html#85">vtable</a>-&gt;<a href="../../../include/aws/cryptosdk/materials.h.html#377">name</a> = <a href="../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#213">ensure_c_str_is_allocated</a>(max_len);</div><div id="240" class="line none">  240     }</div><div id="241" class="line none">  241 }</div>
</div>
</body>
</html>
