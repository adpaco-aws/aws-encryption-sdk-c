
<html>
<head>
<title>verification/cbmc/aws-c-common/include/aws/common/atomics_gnu.inl</title>
<link rel="stylesheet" type="text/css" href="../../../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 #ifndef AWS_COMMON_ATOMICS_GNU_INL</div><div id="2" class="line none">    2 #define AWS_COMMON_ATOMICS_GNU_INL</div><div id="3" class="line none">    3 </div><div id="4" class="line none">    4 /**</div><div id="5" class="line none">    5  * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="6" class="line none">    6  * SPDX-License-Identifier: Apache-2.0.</div><div id="7" class="line none">    7  */</div><div id="8" class="line none">    8 </div><div id="9" class="line none">    9 /* These are implicitly included, but help with editor highlighting */</div><div id="10" class="line none">   10 #include &lt;aws/common/atomics.h&gt;</div><div id="11" class="line none">   11 #include &lt;aws/common/common.h&gt;</div><div id="12" class="line none">   12 </div><div id="13" class="line none">   13 #include &lt;stdint.h&gt;</div><div id="14" class="line none">   14 #include &lt;stdlib.h&gt;</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 AWS_EXTERN_C_BEGIN</div><div id="17" class="line none">   17 </div><div id="18" class="line none">   18 #ifdef __clang__</div><div id="19" class="line none">   19 #    pragma clang diagnostic push</div><div id="20" class="line none">   20 #    pragma clang diagnostic ignored "-Wc11-extensions"</div><div id="21" class="line none">   21 #else</div><div id="22" class="line none">   22 #    pragma GCC diagnostic push</div><div id="23" class="line none">   23 #    pragma GCC diagnostic ignored "-Wpedantic"</div><div id="24" class="line none">   24 #endif</div><div id="25" class="line none">   25 </div><div id="26" class="line none">   26 typedef size_t <a href="atomics_gnu.inl.html#26">aws_atomic_impl_int_t</a>;</div><div id="27" class="line none">   27 </div><div id="28" class="line none">   28 static inline int <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(enum <a href="atomics.h.html#34">aws_memory_order</a> <a href="../../../../sources/openssl/ec_override.c.html#30">order</a>) {</div><div id="29" class="line none">   29     switch (<a href="../../../../sources/openssl/ec_override.c.html#30">order</a>) {</div><div id="30" class="line none">   30         case <a href="atomics.h.html#39">aws_memory_order_relaxed</a>:</div><div id="31" class="line none">   31             return __ATOMIC_RELAXED;</div><div id="32" class="line none">   32         case <a href="atomics.h.html#50">aws_memory_order_acquire</a>:</div><div id="33" class="line none">   33             return __ATOMIC_ACQUIRE;</div><div id="34" class="line none">   34         case <a href="atomics.h.html#58">aws_memory_order_release</a>:</div><div id="35" class="line none">   35             return __ATOMIC_RELEASE;</div><div id="36" class="line none">   36         case <a href="atomics.h.html#65">aws_memory_order_acq_rel</a>:</div><div id="37" class="line none">   37             return __ATOMIC_ACQ_REL;</div><div id="38" class="line none">   38         case <a href="atomics.h.html#74">aws_memory_order_seq_cst</a>:</div><div id="39" class="line none">   39             return __ATOMIC_SEQ_CST;</div><div id="40" class="line none">   40         default: /* Unknown memory order */</div><div id="41" class="line none">   41             <a href="../../../verification/cbmc/stubs/abort_override_assert_false.c.html#14">abort</a>();</div><div id="42" class="line none">   42     }</div><div id="43" class="line none">   43 }</div><div id="44" class="line none">   44 </div><div id="45" class="line none">   45 /**</div><div id="46" class="line none">   46  * Initializes an atomic variable with an integer value. This operation should be done before any</div><div id="47" class="line none">   47  * other operations on this atomic variable, and must be done before attempting any parallel operations.</div><div id="48" class="line none">   48  */</div><div id="49" class="line none">   49 AWS_STATIC_IMPL</div><div id="50" class="line none">   50 void <a href="atomics_gnu.inl.html#50">aws_atomic_init_int</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, size_t n) {</div><div id="51" class="line none">   51     <a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var) = n;</div><div id="52" class="line none">   52 }</div><div id="53" class="line none">   53 </div><div id="54" class="line none">   54 /**</div><div id="55" class="line none">   55  * Initializes an atomic variable with a pointer value. This operation should be done before any</div><div id="56" class="line none">   56  * other operations on this atomic variable, and must be done before attempting any parallel operations.</div><div id="57" class="line none">   57  */</div><div id="58" class="line none">   58 AWS_STATIC_IMPL</div><div id="59" class="line none">   59 void <a href="atomics_gnu.inl.html#59">aws_atomic_init_ptr</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, void *p) {</div><div id="60" class="line none">   60     <a href="atomics.h.html#20">AWS_ATOMIC_VAR_PTRVAL</a>(var) = p;</div><div id="61" class="line none">   61 }</div><div id="62" class="line none">   62 </div><div id="63" class="line none">   63 /**</div><div id="64" class="line none">   64  * Reads an atomic var as an integer, using the specified ordering, and returns the result.</div><div id="65" class="line none">   65  */</div><div id="66" class="line none">   66 AWS_STATIC_IMPL</div><div id="67" class="line none">   67 size_t <a href="atomics_gnu.inl.html#67">aws_atomic_load_int_explicit</a>(volatile const struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, enum <a href="atomics.h.html#34">aws_memory_order</a> memory_order) {</div><div id="68" class="line none">   68     return __atomic_load_n(&amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var), <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(memory_order));</div><div id="69" class="line none">   69 }</div><div id="70" class="line none">   70 </div><div id="71" class="line none">   71 /**</div><div id="72" class="line none">   72  * Reads an atomic var as a pointer, using the specified ordering, and returns the result.</div><div id="73" class="line none">   73  */</div><div id="74" class="line none">   74 AWS_STATIC_IMPL</div><div id="75" class="line none">   75 void *<a href="atomics_gnu.inl.html#75">aws_atomic_load_ptr_explicit</a>(volatile const struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, enum <a href="atomics.h.html#34">aws_memory_order</a> memory_order) {</div><div id="76" class="line none">   76     return __atomic_load_n(&amp;<a href="atomics.h.html#20">AWS_ATOMIC_VAR_PTRVAL</a>(var), <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(memory_order));</div><div id="77" class="line none">   77 }</div><div id="78" class="line none">   78 </div><div id="79" class="line none">   79 /**</div><div id="80" class="line none">   80  * Stores an integer into an atomic var, using the specified ordering.</div><div id="81" class="line none">   81  */</div><div id="82" class="line none">   82 AWS_STATIC_IMPL</div><div id="83" class="line none">   83 void <a href="atomics_gnu.inl.html#83">aws_atomic_store_int_explicit</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, size_t n, enum <a href="atomics.h.html#34">aws_memory_order</a> memory_order) {</div><div id="84" class="line none">   84     __atomic_store_n(&amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var), n, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(memory_order));</div><div id="85" class="line none">   85 }</div><div id="86" class="line none">   86 </div><div id="87" class="line none">   87 /**</div><div id="88" class="line none">   88  * Stores an pointer into an atomic var, using the specified ordering.</div><div id="89" class="line none">   89  */</div><div id="90" class="line none">   90 AWS_STATIC_IMPL</div><div id="91" class="line none">   91 void <a href="atomics_gnu.inl.html#91">aws_atomic_store_ptr_explicit</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, void *p, enum <a href="atomics.h.html#34">aws_memory_order</a> memory_order) {</div><div id="92" class="line none">   92     __atomic_store_n(&amp;<a href="atomics.h.html#20">AWS_ATOMIC_VAR_PTRVAL</a>(var), p, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(memory_order));</div><div id="93" class="line none">   93 }</div><div id="94" class="line none">   94 </div><div id="95" class="line none">   95 /**</div><div id="96" class="line none">   96  * Exchanges an integer with the value in an atomic_var, using the specified ordering.</div><div id="97" class="line none">   97  * Returns the value that was previously in the atomic_var.</div><div id="98" class="line none">   98  */</div><div id="99" class="line none">   99 AWS_STATIC_IMPL</div><div id="100" class="line none">  100 size_t <a href="atomics_gnu.inl.html#100">aws_atomic_exchange_int_explicit</a>(</div><div id="101" class="line none">  101     volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var,</div><div id="102" class="line none">  102     size_t n,</div><div id="103" class="line none">  103     enum <a href="atomics.h.html#34">aws_memory_order</a> memory_order) {</div><div id="104" class="line none">  104     return __atomic_exchange_n(&amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var), n, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(memory_order));</div><div id="105" class="line none">  105 }</div><div id="106" class="line none">  106 </div><div id="107" class="line none">  107 /**</div><div id="108" class="line none">  108  * Exchanges a pointer with the value in an atomic_var, using the specified ordering.</div><div id="109" class="line none">  109  * Returns the value that was previously in the atomic_var.</div><div id="110" class="line none">  110  */</div><div id="111" class="line none">  111 AWS_STATIC_IMPL</div><div id="112" class="line none">  112 void *<a href="atomics_gnu.inl.html#112">aws_atomic_exchange_ptr_explicit</a>(</div><div id="113" class="line none">  113     volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var,</div><div id="114" class="line none">  114     void *p,</div><div id="115" class="line none">  115     enum <a href="atomics.h.html#34">aws_memory_order</a> memory_order) {</div><div id="116" class="line none">  116     return __atomic_exchange_n(&amp;<a href="atomics.h.html#20">AWS_ATOMIC_VAR_PTRVAL</a>(var), p, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(memory_order));</div><div id="117" class="line none">  117 }</div><div id="118" class="line none">  118 </div><div id="119" class="line none">  119 /**</div><div id="120" class="line none">  120  * Atomically compares *var to *expected; if they are equal, atomically sets *var = desired. Otherwise, *expected is set</div><div id="121" class="line none">  121  * to the value in *var. On success, the memory ordering used was order_success; otherwise, it was order_failure.</div><div id="122" class="line none">  122  * order_failure must be no stronger than order_success, and must not be release or acq_rel.</div><div id="123" class="line none">  123  */</div><div id="124" class="line none">  124 AWS_STATIC_IMPL</div><div id="125" class="line none">  125 bool <a href="atomics_gnu.inl.html#125">aws_atomic_compare_exchange_int_explicit</a>(</div><div id="126" class="line none">  126     volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var,</div><div id="127" class="line none">  127     size_t *expected,</div><div id="128" class="line none">  128     size_t desired,</div><div id="129" class="line none">  129     enum <a href="atomics.h.html#34">aws_memory_order</a> order_success,</div><div id="130" class="line none">  130     enum <a href="atomics.h.html#34">aws_memory_order</a> order_failure) {</div><div id="131" class="line none">  131     return __atomic_compare_exchange_n(</div><div id="132" class="line none">  132         &amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var),</div><div id="133" class="line none">  133         expected,</div><div id="134" class="line none">  134         desired,</div><div id="135" class="line none">  135         false,</div><div id="136" class="line none">  136         <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(order_success),</div><div id="137" class="line none">  137         <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(order_failure));</div><div id="138" class="line none">  138 }</div><div id="139" class="line none">  139 </div><div id="140" class="line none">  140 /**</div><div id="141" class="line none">  141  * Atomically compares *var to *expected; if they are equal, atomically sets *var = desired. Otherwise, *expected is set</div><div id="142" class="line none">  142  * to the value in *var. On success, the memory ordering used was order_success; otherwise, it was order_failure.</div><div id="143" class="line none">  143  * order_failure must be no stronger than order_success, and must not be release or acq_rel.</div><div id="144" class="line none">  144  */</div><div id="145" class="line none">  145 AWS_STATIC_IMPL</div><div id="146" class="line none">  146 bool <a href="atomics_gnu.inl.html#146">aws_atomic_compare_exchange_ptr_explicit</a>(</div><div id="147" class="line none">  147     volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var,</div><div id="148" class="line none">  148     void **expected,</div><div id="149" class="line none">  149     void *desired,</div><div id="150" class="line none">  150     enum <a href="atomics.h.html#34">aws_memory_order</a> order_success,</div><div id="151" class="line none">  151     enum <a href="atomics.h.html#34">aws_memory_order</a> order_failure) {</div><div id="152" class="line none">  152     return __atomic_compare_exchange_n(</div><div id="153" class="line none">  153         &amp;<a href="atomics.h.html#20">AWS_ATOMIC_VAR_PTRVAL</a>(var),</div><div id="154" class="line none">  154         expected,</div><div id="155" class="line none">  155         desired,</div><div id="156" class="line none">  156         false,</div><div id="157" class="line none">  157         <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(order_success),</div><div id="158" class="line none">  158         <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(order_failure));</div><div id="159" class="line none">  159 }</div><div id="160" class="line none">  160 </div><div id="161" class="line none">  161 /**</div><div id="162" class="line none">  162  * Atomically adds n to *var, and returns the previous value of *var.</div><div id="163" class="line none">  163  */</div><div id="164" class="line none">  164 AWS_STATIC_IMPL</div><div id="165" class="line none">  165 size_t <a href="atomics_gnu.inl.html#165">aws_atomic_fetch_add_explicit</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, size_t n, enum <a href="atomics.h.html#34">aws_memory_order</a> <a href="../../../../sources/openssl/ec_override.c.html#30">order</a>) {</div><div id="166" class="line none">  166     return __atomic_fetch_add(&amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var), n, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(<a href="../../../../sources/openssl/ec_override.c.html#30">order</a>));</div><div id="167" class="line none">  167 }</div><div id="168" class="line none">  168 </div><div id="169" class="line none">  169 /**</div><div id="170" class="line none">  170  * Atomically subtracts n from *var, and returns the previous value of *var.</div><div id="171" class="line none">  171  */</div><div id="172" class="line none">  172 AWS_STATIC_IMPL</div><div id="173" class="line none">  173 size_t <a href="atomics_gnu.inl.html#173">aws_atomic_fetch_sub_explicit</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, size_t n, enum <a href="atomics.h.html#34">aws_memory_order</a> <a href="../../../../sources/openssl/ec_override.c.html#30">order</a>) {</div><div id="174" class="line none">  174     return __atomic_fetch_sub(&amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var), n, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(<a href="../../../../sources/openssl/ec_override.c.html#30">order</a>));</div><div id="175" class="line none">  175 }</div><div id="176" class="line none">  176 </div><div id="177" class="line none">  177 /**</div><div id="178" class="line none">  178  * Atomically ORs n with *var, and returns the previous value of *var.</div><div id="179" class="line none">  179  */</div><div id="180" class="line none">  180 AWS_STATIC_IMPL</div><div id="181" class="line none">  181 size_t <a href="atomics_gnu.inl.html#181">aws_atomic_fetch_or_explicit</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, size_t n, enum <a href="atomics.h.html#34">aws_memory_order</a> <a href="../../../../sources/openssl/ec_override.c.html#30">order</a>) {</div><div id="182" class="line none">  182     return __atomic_fetch_or(&amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var), n, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(<a href="../../../../sources/openssl/ec_override.c.html#30">order</a>));</div><div id="183" class="line none">  183 }</div><div id="184" class="line none">  184 </div><div id="185" class="line none">  185 /**</div><div id="186" class="line none">  186  * Atomically ANDs n with *var, and returns the previous value of *var.</div><div id="187" class="line none">  187  */</div><div id="188" class="line none">  188 AWS_STATIC_IMPL</div><div id="189" class="line none">  189 size_t <a href="atomics_gnu.inl.html#189">aws_atomic_fetch_and_explicit</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, size_t n, enum <a href="atomics.h.html#34">aws_memory_order</a> <a href="../../../../sources/openssl/ec_override.c.html#30">order</a>) {</div><div id="190" class="line none">  190     return __atomic_fetch_and(&amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var), n, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(<a href="../../../../sources/openssl/ec_override.c.html#30">order</a>));</div><div id="191" class="line none">  191 }</div><div id="192" class="line none">  192 </div><div id="193" class="line none">  193 /**</div><div id="194" class="line none">  194  * Atomically XORs n with *var, and returns the previous value of *var.</div><div id="195" class="line none">  195  */</div><div id="196" class="line none">  196 AWS_STATIC_IMPL</div><div id="197" class="line none">  197 size_t <a href="atomics_gnu.inl.html#197">aws_atomic_fetch_xor_explicit</a>(volatile struct <a href="atomics.h.html#16">aws_atomic_var</a> *var, size_t n, enum <a href="atomics.h.html#34">aws_memory_order</a> <a href="../../../../sources/openssl/ec_override.c.html#30">order</a>) {</div><div id="198" class="line none">  198     return __atomic_fetch_xor(&amp;<a href="atomics.h.html#21">AWS_ATOMIC_VAR_INTVAL</a>(var), n, <a href="atomics_gnu.inl.html#28">aws_atomic_priv_xlate_order</a>(<a href="../../../../sources/openssl/ec_override.c.html#30">order</a>));</div><div id="199" class="line none">  199 }</div><div id="200" class="line none">  200 </div><div id="201" class="line none">  201 /**</div><div id="202" class="line none">  202  * Provides the same reordering guarantees as an atomic operation with the specified memory order, without</div><div id="203" class="line none">  203  * needing to actually perform an atomic operation.</div><div id="204" class="line none">  204  */</div><div id="205" class="line none">  205 AWS_STATIC_IMPL</div><div id="206" class="line none">  206 void <a href="atomics_gnu.inl.html#206">aws_atomic_thread_fence</a>(enum <a href="atomics.h.html#34">aws_memory_order</a> <a href="../../../../sources/openssl/ec_override.c.html#30">order</a>) {</div><div id="207" class="line none">  207     __atomic_thread_fence(<a href="../../../../sources/openssl/ec_override.c.html#30">order</a>);</div><div id="208" class="line none">  208 }</div><div id="209" class="line none">  209 </div><div id="210" class="line none">  210 #ifdef __clang__</div><div id="211" class="line none">  211 #    pragma clang diagnostic pop</div><div id="212" class="line none">  212 #else</div><div id="213" class="line none">  213 #    pragma GCC diagnostic pop</div><div id="214" class="line none">  214 #endif</div><div id="215" class="line none">  215 </div><div id="216" class="line none">  216 #define AWS_ATOMICS_HAVE_THREAD_FENCE</div><div id="217" class="line none">  217 AWS_EXTERN_C_END</div><div id="218" class="line none">  218 #endif /* AWS_COMMON_ATOMICS_GNU_INL */</div>
</div>
</body>
</html>
