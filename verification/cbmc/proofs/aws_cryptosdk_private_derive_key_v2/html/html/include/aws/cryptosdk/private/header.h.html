
<html>
<head>
<title>include/aws/cryptosdk/private/header.h</title>
<link rel="stylesheet" type="text/css" href="../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * Licensed under the Apache License, Version 2.0 (the "License"). You may not use</div><div id="5" class="line none">    5  * this file except in compliance with the License. A copy of the License is</div><div id="6" class="line none">    6  * located at</div><div id="7" class="line none">    7  *</div><div id="8" class="line none">    8  *     http://aws.amazon.com/apache2.0/</div><div id="9" class="line none">    9  *</div><div id="10" class="line none">   10  * or in the "license" file accompanying this file. This file is distributed on an</div><div id="11" class="line none">   11  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</div><div id="12" class="line none">   12  * implied. See the License for the specific language governing permissions and</div><div id="13" class="line none">   13  * limitations under the License.</div><div id="14" class="line none">   14  */</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 #ifndef <a href="header.h.html#17">AWS_CRYPTOSDK_PRIVATE_HEADER_H</a></div><div id="17" class="line none">   17 #define <a href="header.h.html#17">AWS_CRYPTOSDK_PRIVATE_HEADER_H</a></div><div id="18" class="line none">   18 </div><div id="19" class="line none">   19 #include &lt;aws/common/byte_buf.h&gt;</div><div id="20" class="line none">   20 #include &lt;aws/common/hash_table.h&gt;</div><div id="21" class="line none">   21 #include "aws/cryptosdk/header.h"</div><div id="22" class="line none">   22 #include "aws/cryptosdk/materials.h"  // struct aws_cryptosdk_edk</div><div id="23" class="line none">   23 </div><div id="24" class="line none">   24 struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> {</div><div id="25" class="line none">   25     struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="26" class="line none">   26 </div><div id="27" class="line none">   27     uint16_t <a href="header.h.html#27">alg_id</a>;</div><div id="28" class="line none">   28 </div><div id="29" class="line none">   29     uint32_t <a href="header.h.html#29">frame_len</a>;</div><div id="30" class="line none">   30 </div><div id="31" class="line none">   31     struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> <a href="header.h.html#31">iv</a>, <a href="header.h.html#31">auth_tag</a>, <a href="header.h.html#31">message_id</a>, <a href="header.h.html#31">alg_suite_data</a>;</div><div id="32" class="line none">   32 </div><div id="33" class="line none">   33     // aws_string * -&gt; aws_string *</div><div id="34" class="line none">   34     struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#48">aws_hash_table</a> <a href="header.h.html#34">enc_ctx</a>;</div><div id="35" class="line none">   35     struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> <a href="header.h.html#35">edk_list</a>;</div><div id="36" class="line none">   36 </div><div id="37" class="line none">   37     // number of bytes of header except for IV and auth tag,</div><div id="38" class="line none">   38     // i.e., exactly the bytes that get authenticated</div><div id="39" class="line none">   39     size_t <a href="header.h.html#39">auth_len</a>;</div><div id="40" class="line none">   40 };</div><div id="41" class="line none">   41 </div><div id="42" class="line none">   42 enum <a href="header.h.html#42">aws_cryptosdk_hdr_type</a> {</div><div id="43" class="line none">   43     // Only one data type is currently defined.</div><div id="44" class="line none">   44     <a href="header.h.html#44">AWS_CRYPTOSDK_HEADER_TYPE_CUSTOMER_AED</a> = 0x80</div><div id="45" class="line none">   45 };</div><div id="46" class="line none">   46 </div><div id="47" class="line none">   47 enum <a href="header.h.html#47">aws_cryptosdk_hdr_content_type</a> {</div><div id="48" class="line none">   48     <a href="header.h.html#48">AWS_CRYPTOSDK_HEADER_CTYPE_NONFRAMED</a> = 0x01,</div><div id="49" class="line none">   49     <a href="header.h.html#49">AWS_CRYPTOSDK_HEADER_CTYPE_FRAMED</a>    = 0x02</div><div id="50" class="line none">   50 };</div><div id="51" class="line none">   51 </div><div id="52" class="line none">   52 /**</div><div id="53" class="line none">   53  * Initializes the header datastructure; on return, all fields are zeroed,</div><div id="54" class="line none">   54  * except for enc_ctx and edk_tbl, which are empty.</div><div id="55" class="line none">   55  */</div><div id="56" class="line none">   56 int aws_cryptosdk_hdr_init(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>);</div><div id="57" class="line none">   57 </div><div id="58" class="line none">   58 /**</div><div id="59" class="line none">   59  * Frees all memory which has been allocated to hdr object and zeroizes hdr.</div><div id="60" class="line none">   60  * This method is idempotent - that is, it can safely be called multiple times</div><div id="61" class="line none">   61  * on the same header without an intervening init; however it cannot be called</div><div id="62" class="line none">   62  * on an _uninitialized_ header.</div><div id="63" class="line none">   63  */</div><div id="64" class="line none">   64 void aws_cryptosdk_hdr_clean_up(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr);</div><div id="65" class="line none">   65 </div><div id="66" class="line none">   66 /**</div><div id="67" class="line none">   67  * Resets the header to the same state as it would have after hdr_init</div><div id="68" class="line none">   68  */</div><div id="69" class="line none">   69 void aws_cryptosdk_hdr_clear(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr);</div><div id="70" class="line none">   70 </div><div id="71" class="line none">   71 /**</div><div id="72" class="line none">   72  * Reads raw header data from src and populates hdr with all of the information about the</div><div id="73" class="line none">   73  * message. hdr must have been initialized with aws_cryptosdk_hdr_init.</div><div id="74" class="line none">   74  *</div><div id="75" class="line none">   75  * This function will clear the header before parsing, and will leave the header in a cleared</div><div id="76" class="line none">   76  * state on failure.</div><div id="77" class="line none">   77  */</div><div id="78" class="line none">   78 int aws_cryptosdk_hdr_parse(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cursor);</div><div id="79" class="line none">   79 </div><div id="80" class="line none">   80 /**</div><div id="81" class="line none">   81  * Parses the header version from the cursor into *header_version.</div><div id="82" class="line none">   82  */</div><div id="83" class="line none">   83 int aws_cryptosdk_priv_hdr_parse_header_version(</div><div id="84" class="line none">   84     struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, uint8_t *header_version, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="85" class="line none">   85 </div><div id="86" class="line none">   86 /**</div><div id="87" class="line none">   87  * Parses the message type from the cursor and asserts that it equals</div><div id="88" class="line none">   88  * AWS_CRYPTOSDK_HEADER_TYPE_CUSTOMER_AED.</div><div id="89" class="line none">   89  */</div><div id="90" class="line none">   90 int aws_cryptosdk_priv_hdr_parse_message_type(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="91" class="line none">   91 </div><div id="92" class="line none">   92 /**</div><div id="93" class="line none">   93  * Parses the algorithm ID from the cursor into hdr-&gt;alg_id and sets *alg_props</div><div id="94" class="line none">   94  * to the corresponding aws_cryptosdk_alg_properties struct.</div><div id="95" class="line none">   95  */</div><div id="96" class="line none">   96 int aws_cryptosdk_priv_hdr_parse_alg_id(</div><div id="97" class="line none">   97     struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr,</div><div id="98" class="line none">   98     const struct <a href="../cipher.h.html#54">aws_cryptosdk_alg_properties</a> **alg_props,</div><div id="99" class="line none">   99     uint8_t header_version,</div><div id="100" class="line none">  100     struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="101" class="line none">  101 </div><div id="102" class="line none">  102 /**</div><div id="103" class="line none">  103  * Parses the message ID from the cursor into hdr-&gt;message_id, using alg_props</div><div id="104" class="line none">  104  * to determine the correct length of message ID.</div><div id="105" class="line none">  105  */</div><div id="106" class="line none">  106 int aws_cryptosdk_priv_hdr_parse_message_id(</div><div id="107" class="line none">  107     struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, const struct <a href="../cipher.h.html#54">aws_cryptosdk_alg_properties</a> *alg_props, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="108" class="line none">  108 </div><div id="109" class="line none">  109 /**</div><div id="110" class="line none">  110  * Parses the AAD length and AAD raw data from the cursor, deserializing the</div><div id="111" class="line none">  111  * raw data into hdr-&gt;enc_ctx.</div><div id="112" class="line none">  112  */</div><div id="113" class="line none">  113 int aws_cryptosdk_priv_hdr_parse_aad(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="114" class="line none">  114 </div><div id="115" class="line none">  115 /**</div><div id="116" class="line none">  116  * Parses the EDK count and EDKs' raw data from the cursor, deserializing the</div><div id="117" class="line none">  117  * raw data into hdr-&gt;edk_list.</div><div id="118" class="line none">  118  */</div><div id="119" class="line none">  119 int aws_cryptosdk_priv_hdr_parse_edks(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="120" class="line none">  120 </div><div id="121" class="line none">  121 /**</div><div id="122" class="line none">  122  * Parses the content type from the cursor into *content_type.</div><div id="123" class="line none">  123  */</div><div id="124" class="line none">  124 int aws_cryptosdk_priv_hdr_parse_content_type(</div><div id="125" class="line none">  125     struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, uint8_t *content_type, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="126" class="line none">  126 </div><div id="127" class="line none">  127 /**</div><div id="128" class="line none">  128  * Parses the 32-bit reserved field from the cursor and asserts that it is</div><div id="129" class="line none">  129  * equal to zero.</div><div id="130" class="line none">  130  */</div><div id="131" class="line none">  131 int aws_cryptosdk_priv_hdr_parse_reserved(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="132" class="line none">  132 </div><div id="133" class="line none">  133 /**</div><div id="134" class="line none">  134  * Parses the IV length into *iv_len and asserts that it is correct for</div><div id="135" class="line none">  135  * hdr-&gt;alg_id.</div><div id="136" class="line none">  136  */</div><div id="137" class="line none">  137 int aws_cryptosdk_priv_hdr_parse_iv_len(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, uint8_t *<a href="../cipher.h.html#77">iv_len</a>, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="138" class="line none">  138 </div><div id="139" class="line none">  139 /**</div><div id="140" class="line none">  140  * Parses the frame length into hdr-&gt;frame_len and asserts that it is</div><div id="141" class="line none">  141  * consistent with content_type.</div><div id="142" class="line none">  142  */</div><div id="143" class="line none">  143 int aws_cryptosdk_priv_hdr_parse_frame_len(</div><div id="144" class="line none">  144     struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, uint8_t content_type, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="145" class="line none">  145 </div><div id="146" class="line none">  146 /**</div><div id="147" class="line none">  147  * Parses the algorithm suite data into hdr-&gt;alg_suite_data, using alg_props to</div><div id="148" class="line none">  148  * determine the appropriate length.</div><div id="149" class="line none">  149  */</div><div id="150" class="line none">  150 int aws_cryptosdk_priv_hdr_parse_alg_suite_data(</div><div id="151" class="line none">  151     struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, const struct <a href="../cipher.h.html#54">aws_cryptosdk_alg_properties</a> *alg_props, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="152" class="line none">  152 </div><div id="153" class="line none">  153 /**</div><div id="154" class="line none">  154  * Parses the IV into hdr-&gt;iv, using iv_len as the length.</div><div id="155" class="line none">  155  */</div><div id="156" class="line none">  156 int aws_cryptosdk_priv_hdr_parse_iv(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, uint8_t <a href="../cipher.h.html#77">iv_len</a>, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="157" class="line none">  157 </div><div id="158" class="line none">  158 /**</div><div id="159" class="line none">  159  * Parses the auth tag into hdr-&gt;auth_tag, using hdr-&gt;alg_id to determine the</div><div id="160" class="line none">  160  * tag length.</div><div id="161" class="line none">  161  */</div><div id="162" class="line none">  162 int aws_cryptosdk_priv_hdr_parse_auth_tag(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, struct <a href="../../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#38">aws_byte_cursor</a> *cur);</div><div id="163" class="line none">  163 </div><div id="164" class="line none">  164 /**</div><div id="165" class="line none">  165  * Clears hdr and raises AWS_ERROR_SHORT_BUFFER. Used when reading from a</div><div id="166" class="line none">  166  * buffer with insufficient data to parse.</div><div id="167" class="line none">  167  */</div><div id="168" class="line none">  168 int aws_cryptosdk_priv_hdr_parse_err_short_buf(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr);</div><div id="169" class="line none">  169 </div><div id="170" class="line none">  170 /**</div><div id="171" class="line none">  171  * Clears hdr and raises AWS_CRYPTOSDK_ERR_BAD_CIPHERTEXT. Used for parse</div><div id="172" class="line none">  172  * errors that indicate a malformed message header, such as unrecognized field</div><div id="173" class="line none">  173  * constants and mismatches between values parsed from the header and those</div><div id="174" class="line none">  174  * defined by the algorithm suite.</div><div id="175" class="line none">  175  */</div><div id="176" class="line none">  176 int aws_cryptosdk_priv_hdr_parse_err_generic(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr);</div><div id="177" class="line none">  177 </div><div id="178" class="line none">  178 /**</div><div id="179" class="line none">  179  * Clears hdr and returns AWS_OP_ERR without raising a new error. Used to</div><div id="180" class="line none">  180  * indicate allocation failure during parsing.</div><div id="181" class="line none">  181  */</div><div id="182" class="line none">  182 int aws_cryptosdk_priv_hdr_parse_err_mem(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr);</div><div id="183" class="line none">  183 </div><div id="184" class="line none">  184 /**</div><div id="185" class="line none">  185  * Clears hdr and returns AWS_OP_ERR without raising a new error. Used to</div><div id="186" class="line none">  186  * rethrow errors that arise from functions called in order to parse a header</div><div id="187" class="line none">  187  * field.</div><div id="188" class="line none">  188  */</div><div id="189" class="line none">  189 int aws_cryptosdk_priv_hdr_parse_err_rethrow(struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr);</div><div id="190" class="line none">  190 </div><div id="191" class="line none">  191 /**</div><div id="192" class="line none">  192  * Reads information from already parsed hdr object and determines how many bytes are</div><div id="193" class="line none">  193  * needed to serialize.</div><div id="194" class="line none">  194  *</div><div id="195" class="line none">  195  * Returns number of bytes, or zero if hdr was not parsed correctly.</div><div id="196" class="line none">  196  *</div><div id="197" class="line none">  197  * Warning: running this on a hdr which has not already been run through</div><div id="198" class="line none">  198  * aws_cryptosdk_hdr_parse_init (or which has been zeroized) can result in a seg fault.</div><div id="199" class="line none">  199  */</div><div id="200" class="line none">  200 int aws_cryptosdk_hdr_size(const struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr);</div><div id="201" class="line none">  201 </div><div id="202" class="line none">  202 /**</div><div id="203" class="line none">  203  * Attempts to write a parsed header.</div><div id="204" class="line none">  204  *</div><div id="205" class="line none">  205  * The number of bytes written to outbuf is placed at *bytes_written. If outbuf is too</div><div id="206" class="line none">  206  * small, returns AWS_OP_ERR, sets the error code to AWS_ERROR_SHORT_BUFFER, and zeroizes</div><div id="207" class="line none">  207  * the output buffer.</div><div id="208" class="line none">  208  *</div><div id="209" class="line none">  209  * Using aws_cryptosdk_hdr_size to determine how much memory to allocate to outbuf ahead</div><div id="210" class="line none">  210  * of time guarantees that the short buffer error will not occur.</div><div id="211" class="line none">  211  */</div><div id="212" class="line none">  212 int aws_cryptosdk_hdr_write(const struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr, size_t *bytes_written, uint8_t *outbuf, size_t outlen);</div><div id="213" class="line none">  213 </div><div id="214" class="line none">  214 /**</div><div id="215" class="line none">  215  * Returns number of bytes in auth tag for known algorithms, -1 for unknown algorithms.</div><div id="216" class="line none">  216  */</div><div id="217" class="line none">  217 int aws_cryptosdk_private_algorithm_taglen(uint16_t <a href="header.h.html#27">alg_id</a>);</div><div id="218" class="line none">  218 </div><div id="219" class="line none">  219 /**</div><div id="220" class="line none">  220  * Returns number of bytes in IV for known algorithms, -1 for unknown algorithms.</div><div id="221" class="line none">  221  */</div><div id="222" class="line none">  222 int aws_cryptosdk_private_algorithm_ivlen(uint16_t <a href="header.h.html#27">alg_id</a>);</div><div id="223" class="line none">  223 </div><div id="224" class="line none">  224 /**</div><div id="225" class="line none">  225  * Returns the total length of statically sized fields for known header</div><div id="226" class="line none">  226  * versions, or -1 for unknown header versions.</div><div id="227" class="line none">  227  */</div><div id="228" class="line none">  228 int aws_cryptosdk_private_header_version_static_fields_len(uint8_t header_version);</div><div id="229" class="line none">  229 </div><div id="230" class="line none">  230 /**</div><div id="231" class="line none">  231  * Returns true for known algorithms, or false for unknown algorithms.</div><div id="232" class="line none">  232  */</div><div id="233" class="line none">  233 bool aws_cryptosdk_algorithm_is_known(uint16_t <a href="header.h.html#27">alg_id</a>);</div><div id="234" class="line none">  234 </div><div id="235" class="line none">  235 /**</div><div id="236" class="line none">  236  * Returns true for key-committing algorithms, or false otherwise.</div><div id="237" class="line none">  237  */</div><div id="238" class="line none">  238 bool aws_cryptosdk_algorithm_is_committing(uint16_t <a href="header.h.html#27">alg_id</a>);</div><div id="239" class="line none">  239 </div><div id="240" class="line none">  240 /**</div><div id="241" class="line none">  241  * Evaluates the set of properties that define the shape of all valid aws_cryptosdk_hdr structures.</div><div id="242" class="line none">  242  * It is also a cheap check, in the sense it run in constant time (i.e., no loops or recursion).</div><div id="243" class="line none">  243  */</div><div id="244" class="line none">  244 bool aws_cryptosdk_hdr_is_valid(const struct <a href="header.h.html#24">aws_cryptosdk_hdr</a> *hdr);</div><div id="245" class="line none">  245 </div><div id="246" class="line none">  246 #endif  // AWS_CRYPTOSDK_PRIVATE_HEADER_H</div>
</div>
</body>
</html>
