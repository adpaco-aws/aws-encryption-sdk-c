
<html>
<head>
<title>verification/cbmc/aws-c-common/include/aws/common/math.inl</title>
<link rel="stylesheet" type="text/css" href="../../../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 #ifndef AWS_COMMON_MATH_INL</div><div id="2" class="line none">    2 #define AWS_COMMON_MATH_INL</div><div id="3" class="line none">    3 </div><div id="4" class="line none">    4 /**</div><div id="5" class="line none">    5  * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="6" class="line none">    6  * SPDX-License-Identifier: Apache-2.0.</div><div id="7" class="line none">    7  */</div><div id="8" class="line none">    8 </div><div id="9" class="line none">    9 #include &lt;aws/common/common.h&gt;</div><div id="10" class="line none">   10 #include &lt;aws/common/config.h&gt;</div><div id="11" class="line none">   11 #include &lt;aws/common/math.h&gt;</div><div id="12" class="line none">   12 </div><div id="13" class="line none">   13 #include &lt;limits.h&gt;</div><div id="14" class="line none">   14 #include &lt;stdlib.h&gt;</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 AWS_EXTERN_C_BEGIN</div><div id="17" class="line none">   17 </div><div id="18" class="line none">   18 #if defined(AWS_HAVE_GCC_OVERFLOW_MATH_EXTENSIONS) &amp;&amp; (defined(__clang__) || !defined(__cplusplus))</div><div id="19" class="line none">   19 /*</div><div id="20" class="line none">   20  * GCC and clang have these super convenient overflow checking builtins...</div><div id="21" class="line none">   21  * but (in the case of GCC) they're only available when building C source.</div><div id="22" class="line none">   22  * We'll fall back to one of the other inlinable variants (or a non-inlined version)</div><div id="23" class="line none">   23  * if we are building this header on G++.</div><div id="24" class="line none">   24  */</div><div id="25" class="line none">   25 #    include &lt;aws/common/math.gcc_overflow.inl&gt;</div><div id="26" class="line none">   26 #elif defined(__x86_64__) &amp;&amp; defined(AWS_HAVE_GCC_INLINE_ASM)</div><div id="27" class="line none">   27 #    include &lt;aws/common/math.gcc_x64_asm.inl&gt;</div><div id="28" class="line none">   28 #elif defined(__aarch64__) &amp;&amp; defined(AWS_HAVE_GCC_INLINE_ASM)</div><div id="29" class="line none">   29 #    include &lt;aws/common/math.gcc_arm64_asm.inl&gt;</div><div id="30" class="line none">   30 #elif defined(AWS_HAVE_MSVC_MULX)</div><div id="31" class="line none">   31 #    include &lt;aws/common/math.msvc.inl&gt;</div><div id="32" class="line none">   32 #elif defined(CBMC)</div><div id="33" class="line none">   33 #    include &lt;aws/common/math.cbmc.inl&gt;</div><div id="34" class="line none">   34 #else</div><div id="35" class="line none">   35 #    ifndef AWS_HAVE_GCC_OVERFLOW_MATH_EXTENSIONS</div><div id="36" class="line none">   36 /* Fall back to the pure-C implementations */</div><div id="37" class="line none">   37 #        include &lt;aws/common/math.fallback.inl&gt;</div><div id="38" class="line none">   38 #    else</div><div id="39" class="line none">   39 /*</div><div id="40" class="line none">   40  * We got here because we are building in C++ mode but we only support overflow extensions</div><div id="41" class="line none">   41  * in C mode. Because the fallback is _slow_ (involving a division), we'd prefer to make a</div><div id="42" class="line none">   42  * non-inline call to the fast C intrinsics.</div><div id="43" class="line none">   43  */</div><div id="44" class="line none">   44 #    endif /*  AWS_HAVE_GCC_OVERFLOW_MATH_EXTENSIONS */</div><div id="45" class="line none">   45 #endif     /*  defined(AWS_HAVE_GCC_OVERFLOW_MATH_EXTENSIONS) &amp;&amp; (defined(__clang__) || !defined(__cplusplus)) */</div><div id="46" class="line none">   46 </div><div id="47" class="line none">   47 #if defined(__clang__) || defined(__GNUC__)</div><div id="48" class="line none">   48 #    include &lt;aws/common/math.gcc_builtin.inl&gt;</div><div id="49" class="line none">   49 #endif</div><div id="50" class="line none">   50 </div><div id="51" class="line none">   51 #if _MSC_VER</div><div id="52" class="line none">   52 #    pragma warning(push)</div><div id="53" class="line none">   53 #    pragma warning(disable : 4127) /*Disable "conditional expression is constant" */</div><div id="54" class="line none">   54 #endif                              /* _MSC_VER */</div><div id="55" class="line none">   55 </div><div id="56" class="line none">   56 AWS_STATIC_IMPL uint64_t <a href="math.inl.html#56">aws_sub_u64_saturating</a>(uint64_t a, uint64_t b) {</div><div id="57" class="line none">   57     return a &lt;= b ? 0 : a - b;</div><div id="58" class="line none">   58 }</div><div id="59" class="line none">   59 </div><div id="60" class="line none">   60 AWS_STATIC_IMPL int <a href="math.inl.html#60">aws_sub_u64_checked</a>(uint64_t a, uint64_t b, uint64_t *<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>) {</div><div id="61" class="line none">   61     if (a &lt; b) {</div><div id="62" class="line none">   62         return <a href="error.inl.html#17">aws_raise_error</a>(<a href="error.h.html#148">AWS_ERROR_OVERFLOW_DETECTED</a>);</div><div id="63" class="line none">   63     }</div><div id="64" class="line none">   64 </div><div id="65" class="line none">   65     *<a href="../../../../sources/openssl/ec_override.c.html#282">r</a> = a - b;</div><div id="66" class="line none">   66     return <a href="error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="67" class="line none">   67 }</div><div id="68" class="line none">   68 </div><div id="69" class="line none">   69 AWS_STATIC_IMPL uint32_t <a href="math.inl.html#69">aws_sub_u32_saturating</a>(uint32_t a, uint32_t b) {</div><div id="70" class="line none">   70     return a &lt;= b ? 0 : a - b;</div><div id="71" class="line none">   71 }</div><div id="72" class="line none">   72 </div><div id="73" class="line none">   73 AWS_STATIC_IMPL int <a href="math.inl.html#73">aws_sub_u32_checked</a>(uint32_t a, uint32_t b, uint32_t *<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>) {</div><div id="74" class="line none">   74     if (a &lt; b) {</div><div id="75" class="line none">   75         return <a href="error.inl.html#17">aws_raise_error</a>(<a href="error.h.html#148">AWS_ERROR_OVERFLOW_DETECTED</a>);</div><div id="76" class="line none">   76     }</div><div id="77" class="line none">   77 </div><div id="78" class="line none">   78     *<a href="../../../../sources/openssl/ec_override.c.html#282">r</a> = a - b;</div><div id="79" class="line none">   79     return <a href="error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="80" class="line none">   80 }</div><div id="81" class="line none">   81 </div><div id="82" class="line none">   82 /**</div><div id="83" class="line none">   83  * Multiplies a * b. If the result overflows, returns SIZE_MAX.</div><div id="84" class="line none">   84  */</div><div id="85" class="line none">   85 AWS_STATIC_IMPL size_t <a href="math.inl.html#85">aws_mul_size_saturating</a>(size_t a, size_t b) {</div><div id="86" class="line none">   86 #if SIZE_BITS == 32</div><div id="87" class="line none">   87     return (size_t)<a href="math.cbmc.inl.html#46">aws_mul_u32_saturating</a>(a, b);</div><div id="88" class="line none">   88 #elif SIZE_BITS == 64</div><div id="89" class="line none">   89     return (size_t)<a href="math.cbmc.inl.html#26">aws_mul_u64_saturating</a>(a, b);</div><div id="90" class="line none">   90 #else</div><div id="91" class="line none">   91 #    error "Target not supported"</div><div id="92" class="line none">   92 #endif</div><div id="93" class="line none">   93 }</div><div id="94" class="line none">   94 </div><div id="95" class="line none">   95 /**</div><div id="96" class="line none">   96  * Multiplies a * b and returns the result in *r. If the result</div><div id="97" class="line none">   97  * overflows, returns AWS_OP_ERR; otherwise returns AWS_OP_SUCCESS.</div><div id="98" class="line none">   98  */</div><div id="99" class="line none">   99 AWS_STATIC_IMPL int <a href="math.inl.html#99">aws_mul_size_checked</a>(size_t a, size_t b, size_t *<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>) {</div><div id="100" class="line none">  100 #if SIZE_BITS == 32</div><div id="101" class="line none">  101     return <a href="math.cbmc.inl.html#56">aws_mul_u32_checked</a>(a, b, (uint32_t *)<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>);</div><div id="102" class="line none">  102 #elif SIZE_BITS == 64</div><div id="103" class="line none">  103     return <a href="math.cbmc.inl.html#36">aws_mul_u64_checked</a>(a, b, (uint64_t *)<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>);</div><div id="104" class="line none">  104 #else</div><div id="105" class="line none">  105 #    error "Target not supported"</div><div id="106" class="line none">  106 #endif</div><div id="107" class="line none">  107 }</div><div id="108" class="line none">  108 </div><div id="109" class="line none">  109 /**</div><div id="110" class="line none">  110  * Adds a + b.  If the result overflows returns SIZE_MAX.</div><div id="111" class="line none">  111  */</div><div id="112" class="line none">  112 AWS_STATIC_IMPL size_t <a href="math.inl.html#112">aws_add_size_saturating</a>(size_t a, size_t b) {</div><div id="113" class="line none">  113 #if SIZE_BITS == 32</div><div id="114" class="line none">  114     return (size_t)<a href="math.cbmc.inl.html#86">aws_add_u32_saturating</a>(a, b);</div><div id="115" class="line none">  115 #elif SIZE_BITS == 64</div><div id="116" class="line none">  116     return (size_t)<a href="math.cbmc.inl.html#66">aws_add_u64_saturating</a>(a, b);</div><div id="117" class="line none">  117 #else</div><div id="118" class="line none">  118 #    error "Target not supported"</div><div id="119" class="line none">  119 #endif</div><div id="120" class="line none">  120 }</div><div id="121" class="line none">  121 </div><div id="122" class="line none">  122 /**</div><div id="123" class="line none">  123  * Adds a + b and returns the result in *r. If the result</div><div id="124" class="line none">  124  * overflows, returns AWS_OP_ERR; otherwise returns AWS_OP_SUCCESS.</div><div id="125" class="line none">  125  */</div><div id="126" class="line none">  126 AWS_STATIC_IMPL int <a href="math.inl.html#126">aws_add_size_checked</a>(size_t a, size_t b, size_t *<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>) {</div><div id="127" class="line none">  127 #if SIZE_BITS == 32</div><div id="128" class="line none">  128     return <a href="math.cbmc.inl.html#96">aws_add_u32_checked</a>(a, b, (uint32_t *)<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>);</div><div id="129" class="line none">  129 #elif SIZE_BITS == 64</div><div id="130" class="line none">  130     return <a href="math.cbmc.inl.html#76">aws_add_u64_checked</a>(a, b, (uint64_t *)<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>);</div><div id="131" class="line none">  131 #else</div><div id="132" class="line none">  132 #    error "Target not supported"</div><div id="133" class="line none">  133 #endif</div><div id="134" class="line none">  134 }</div><div id="135" class="line none">  135 </div><div id="136" class="line none">  136 AWS_STATIC_IMPL size_t <a href="math.inl.html#136">aws_sub_size_saturating</a>(size_t a, size_t b) {</div><div id="137" class="line none">  137 #if SIZE_BITS == 32</div><div id="138" class="line none">  138     return (size_t)<a href="math.inl.html#69">aws_sub_u32_saturating</a>(a, b);</div><div id="139" class="line none">  139 #elif SIZE_BITS == 64</div><div id="140" class="line none">  140     return (size_t)<a href="math.inl.html#56">aws_sub_u64_saturating</a>(a, b);</div><div id="141" class="line none">  141 #else</div><div id="142" class="line none">  142 #    error "Target not supported"</div><div id="143" class="line none">  143 #endif</div><div id="144" class="line none">  144 }</div><div id="145" class="line none">  145 </div><div id="146" class="line none">  146 AWS_STATIC_IMPL int <a href="math.inl.html#146">aws_sub_size_checked</a>(size_t a, size_t b, size_t *<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>) {</div><div id="147" class="line none">  147 #if SIZE_BITS == 32</div><div id="148" class="line none">  148     return <a href="math.inl.html#73">aws_sub_u32_checked</a>(a, b, (uint32_t *)<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>);</div><div id="149" class="line none">  149 #elif SIZE_BITS == 64</div><div id="150" class="line none">  150     return <a href="math.inl.html#60">aws_sub_u64_checked</a>(a, b, (uint64_t *)<a href="../../../../sources/openssl/ec_override.c.html#282">r</a>);</div><div id="151" class="line none">  151 #else</div><div id="152" class="line none">  152 #    error "Target not supported"</div><div id="153" class="line none">  153 #endif</div><div id="154" class="line none">  154 }</div><div id="155" class="line none">  155 </div><div id="156" class="line none">  156 /**</div><div id="157" class="line none">  157  * Function to check if x is power of 2</div><div id="158" class="line none">  158  */</div><div id="159" class="line none">  159 AWS_STATIC_IMPL bool <a href="math.inl.html#159">aws_is_power_of_two</a>(const size_t x) {</div><div id="160" class="line none">  160     /* First x in the below expression is for the case when x is 0 */</div><div id="161" class="line none">  161     return x &amp;&amp; (!(x &amp; (x - 1)));</div><div id="162" class="line none">  162 }</div><div id="163" class="line none">  163 </div><div id="164" class="line none">  164 /**</div><div id="165" class="line none">  165  * Function to find the smallest result that is power of 2 &gt;= n. Returns AWS_OP_ERR if this cannot</div><div id="166" class="line none">  166  * be done without overflow</div><div id="167" class="line none">  167  */</div><div id="168" class="line none">  168 AWS_STATIC_IMPL int <a href="math.inl.html#168">aws_round_up_to_power_of_two</a>(size_t n, size_t *result) {</div><div id="169" class="line none">  169     if (n == 0) {</div><div id="170" class="line none">  170         *result = 1;</div><div id="171" class="line none">  171         return <a href="error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="172" class="line none">  172     }</div><div id="173" class="line none">  173     if (n &gt; SIZE_MAX_POWER_OF_TWO) {</div><div id="174" class="line none">  174         return <a href="error.inl.html#17">aws_raise_error</a>(<a href="error.h.html#148">AWS_ERROR_OVERFLOW_DETECTED</a>);</div><div id="175" class="line none">  175     }</div><div id="176" class="line none">  176 </div><div id="177" class="line none">  177     n--;</div><div id="178" class="line none">  178     n |= n &gt;&gt; 1;</div><div id="179" class="line none">  179     n |= n &gt;&gt; 2;</div><div id="180" class="line none">  180     n |= n &gt;&gt; 4;</div><div id="181" class="line none">  181     n |= n &gt;&gt; 8;</div><div id="182" class="line none">  182     n |= n &gt;&gt; 16;</div><div id="183" class="line none">  183 #if SIZE_BITS == 64</div><div id="184" class="line none">  184     n |= n &gt;&gt; 32;</div><div id="185" class="line none">  185 #endif</div><div id="186" class="line none">  186     n++;</div><div id="187" class="line none">  187     *result = n;</div><div id="188" class="line none">  188     return <a href="error.h.html#15">AWS_OP_SUCCESS</a>;</div><div id="189" class="line none">  189 }</div><div id="190" class="line none">  190 </div><div id="191" class="line none">  191 #if _MSC_VER</div><div id="192" class="line none">  192 #    pragma warning(pop)</div><div id="193" class="line none">  193 #endif /* _MSC_VER */</div><div id="194" class="line none">  194 </div><div id="195" class="line none">  195 AWS_STATIC_IMPL uint8_t <a href="math.inl.html#195">aws_min_u8</a>(uint8_t a, uint8_t b) {</div><div id="196" class="line none">  196     return a &lt; b ? a : b;</div><div id="197" class="line none">  197 }</div><div id="198" class="line none">  198 </div><div id="199" class="line none">  199 AWS_STATIC_IMPL uint8_t <a href="math.inl.html#199">aws_max_u8</a>(uint8_t a, uint8_t b) {</div><div id="200" class="line none">  200     return a &gt; b ? a : b;</div><div id="201" class="line none">  201 }</div><div id="202" class="line none">  202 </div><div id="203" class="line none">  203 AWS_STATIC_IMPL int8_t <a href="math.inl.html#203">aws_min_i8</a>(int8_t a, int8_t b) {</div><div id="204" class="line none">  204     return a &lt; b ? a : b;</div><div id="205" class="line none">  205 }</div><div id="206" class="line none">  206 </div><div id="207" class="line none">  207 AWS_STATIC_IMPL int8_t <a href="math.inl.html#207">aws_max_i8</a>(int8_t a, int8_t b) {</div><div id="208" class="line none">  208     return a &gt; b ? a : b;</div><div id="209" class="line none">  209 }</div><div id="210" class="line none">  210 </div><div id="211" class="line none">  211 AWS_STATIC_IMPL uint16_t <a href="math.inl.html#211">aws_min_u16</a>(uint16_t a, uint16_t b) {</div><div id="212" class="line none">  212     return a &lt; b ? a : b;</div><div id="213" class="line none">  213 }</div><div id="214" class="line none">  214 </div><div id="215" class="line none">  215 AWS_STATIC_IMPL uint16_t <a href="math.inl.html#215">aws_max_u16</a>(uint16_t a, uint16_t b) {</div><div id="216" class="line none">  216     return a &gt; b ? a : b;</div><div id="217" class="line none">  217 }</div><div id="218" class="line none">  218 </div><div id="219" class="line none">  219 AWS_STATIC_IMPL int16_t <a href="math.inl.html#219">aws_min_i16</a>(int16_t a, int16_t b) {</div><div id="220" class="line none">  220     return a &lt; b ? a : b;</div><div id="221" class="line none">  221 }</div><div id="222" class="line none">  222 </div><div id="223" class="line none">  223 AWS_STATIC_IMPL int16_t <a href="math.inl.html#223">aws_max_i16</a>(int16_t a, int16_t b) {</div><div id="224" class="line none">  224     return a &gt; b ? a : b;</div><div id="225" class="line none">  225 }</div><div id="226" class="line none">  226 </div><div id="227" class="line none">  227 AWS_STATIC_IMPL uint32_t <a href="math.inl.html#227">aws_min_u32</a>(uint32_t a, uint32_t b) {</div><div id="228" class="line none">  228     return a &lt; b ? a : b;</div><div id="229" class="line none">  229 }</div><div id="230" class="line none">  230 </div><div id="231" class="line none">  231 AWS_STATIC_IMPL uint32_t <a href="math.inl.html#231">aws_max_u32</a>(uint32_t a, uint32_t b) {</div><div id="232" class="line none">  232     return a &gt; b ? a : b;</div><div id="233" class="line none">  233 }</div><div id="234" class="line none">  234 </div><div id="235" class="line none">  235 AWS_STATIC_IMPL int32_t <a href="math.inl.html#235">aws_min_i32</a>(int32_t a, int32_t b) {</div><div id="236" class="line none">  236     return a &lt; b ? a : b;</div><div id="237" class="line none">  237 }</div><div id="238" class="line none">  238 </div><div id="239" class="line none">  239 AWS_STATIC_IMPL int32_t <a href="math.inl.html#239">aws_max_i32</a>(int32_t a, int32_t b) {</div><div id="240" class="line none">  240     return a &gt; b ? a : b;</div><div id="241" class="line none">  241 }</div><div id="242" class="line none">  242 </div><div id="243" class="line none">  243 AWS_STATIC_IMPL uint64_t <a href="math.inl.html#243">aws_min_u64</a>(uint64_t a, uint64_t b) {</div><div id="244" class="line none">  244     return a &lt; b ? a : b;</div><div id="245" class="line none">  245 }</div><div id="246" class="line none">  246 </div><div id="247" class="line none">  247 AWS_STATIC_IMPL uint64_t <a href="math.inl.html#247">aws_max_u64</a>(uint64_t a, uint64_t b) {</div><div id="248" class="line none">  248     return a &gt; b ? a : b;</div><div id="249" class="line none">  249 }</div><div id="250" class="line none">  250 </div><div id="251" class="line none">  251 AWS_STATIC_IMPL int64_t <a href="math.inl.html#251">aws_min_i64</a>(int64_t a, int64_t b) {</div><div id="252" class="line none">  252     return a &lt; b ? a : b;</div><div id="253" class="line none">  253 }</div><div id="254" class="line none">  254 </div><div id="255" class="line none">  255 AWS_STATIC_IMPL int64_t <a href="math.inl.html#255">aws_max_i64</a>(int64_t a, int64_t b) {</div><div id="256" class="line none">  256     return a &gt; b ? a : b;</div><div id="257" class="line none">  257 }</div><div id="258" class="line none">  258 </div><div id="259" class="line none">  259 AWS_STATIC_IMPL size_t <a href="math.inl.html#259">aws_min_size</a>(size_t a, size_t b) {</div><div id="260" class="line none">  260     return a &lt; b ? a : b;</div><div id="261" class="line none">  261 }</div><div id="262" class="line none">  262 </div><div id="263" class="line none">  263 AWS_STATIC_IMPL size_t <a href="math.inl.html#263">aws_max_size</a>(size_t a, size_t b) {</div><div id="264" class="line none">  264     return a &gt; b ? a : b;</div><div id="265" class="line none">  265 }</div><div id="266" class="line none">  266 </div><div id="267" class="line none">  267 AWS_STATIC_IMPL int <a href="math.inl.html#267">aws_min_int</a>(int a, int b) {</div><div id="268" class="line none">  268     return a &lt; b ? a : b;</div><div id="269" class="line none">  269 }</div><div id="270" class="line none">  270 </div><div id="271" class="line none">  271 AWS_STATIC_IMPL int <a href="math.inl.html#271">aws_max_int</a>(int a, int b) {</div><div id="272" class="line none">  272     return a &gt; b ? a : b;</div><div id="273" class="line none">  273 }</div><div id="274" class="line none">  274 </div><div id="275" class="line none">  275 AWS_STATIC_IMPL float <a href="math.inl.html#275">aws_min_float</a>(float a, float b) {</div><div id="276" class="line none">  276     return a &lt; b ? a : b;</div><div id="277" class="line none">  277 }</div><div id="278" class="line none">  278 </div><div id="279" class="line none">  279 AWS_STATIC_IMPL float <a href="math.inl.html#279">aws_max_float</a>(float a, float b) {</div><div id="280" class="line none">  280     return a &gt; b ? a : b;</div><div id="281" class="line none">  281 }</div><div id="282" class="line none">  282 </div><div id="283" class="line none">  283 AWS_STATIC_IMPL double <a href="math.inl.html#283">aws_min_double</a>(double a, double b) {</div><div id="284" class="line none">  284     return a &lt; b ? a : b;</div><div id="285" class="line none">  285 }</div><div id="286" class="line none">  286 </div><div id="287" class="line none">  287 AWS_STATIC_IMPL double <a href="math.inl.html#287">aws_max_double</a>(double a, double b) {</div><div id="288" class="line none">  288     return a &gt; b ? a : b;</div><div id="289" class="line none">  289 }</div><div id="290" class="line none">  290 </div><div id="291" class="line none">  291 AWS_EXTERN_C_END</div><div id="292" class="line none">  292 </div><div id="293" class="line none">  293 #endif /* AWS_COMMON_MATH_INL */</div>
</div>
</body>
</html>
