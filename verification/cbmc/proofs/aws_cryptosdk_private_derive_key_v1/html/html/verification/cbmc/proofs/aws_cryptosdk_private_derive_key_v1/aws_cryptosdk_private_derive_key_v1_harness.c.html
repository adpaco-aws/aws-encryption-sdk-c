
<html>
<head>
<title>verification/cbmc/proofs/aws_cryptosdk_private_derive_key_v1/aws_cryptosdk_private_derive_key_v1_harness.c</title>
<link rel="stylesheet" type="text/css" href="../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * Licensed under the Apache License, Version 2.0 (the "License").</div><div id="5" class="line none">    5  * You may not use this file except in compliance with the License.</div><div id="6" class="line none">    6  * A copy of the License is located at</div><div id="7" class="line none">    7  *</div><div id="8" class="line none">    8  *  http://aws.amazon.com/apache2.0</div><div id="9" class="line none">    9  *</div><div id="10" class="line none">   10  * or in the "license" file accompanying this file. This file is distributed</div><div id="11" class="line none">   11  * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either</div><div id="12" class="line none">   12  * express or implied. See the License for the specific language governing</div><div id="13" class="line none">   13  * permissions and limitations under the License.</div><div id="14" class="line none">   14  */</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 #include &lt;aws/cryptosdk/<a href="../../sources/openssl/evp_override.c.html#437">cipher</a>.h&gt;</div><div id="17" class="line none">   17 #include &lt;aws/cryptosdk/private/<a href="../../sources/openssl/evp_override.c.html#437">cipher</a>.h&gt;</div><div id="18" class="line none">   18 #include &lt;aws/cryptosdk/private/hkdf.h&gt;</div><div id="19" class="line none">   19 #include &lt;make_common_data_structures.h&gt;</div><div id="20" class="line none">   20 #include &lt;utils.h&gt;</div><div id="21" class="line none">   21 </div><div id="22" class="line none">   22 void <a href="aws_cryptosdk_private_derive_key_v1_harness.c.html#22">aws_cryptosdk_private_derive_key_v1_harness</a>() {</div><div id="23" class="line hit">   23     struct <a href="../../../../include/aws/cryptosdk/cipher.h.html#54">aws_cryptosdk_alg_properties</a> *<a href="../../../../source/cipher_openssl.c.html#75">props</a> = <a href="../../sources/make_common_data_structures.c.html#46">ensure_alg_properties_attempt_allocation</a>(MAX_STRING_LEN);</div><div id="24" class="line hit">   24     struct <a href="../../../../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a> *<a href="../../../../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>            = <a href="../../sources/make_common_data_structures.c.html#58">ensure_content_key_attempt_allocation</a>();</div><div id="25" class="line hit">   25     struct <a href="../../../../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a> *<a href="../../../../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>                  = <a href="../../sources/make_common_data_structures.c.html#63">ensure_data_key_attempt_allocation</a>();</div><div id="26" class="line hit">   26     struct <a href="../../aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>            = malloc(sizeof(*<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>));</div><div id="27" class="line none">   27 </div><div id="28" class="line none">   28     /* Assumptions */</div><div id="29" class="line hit">   29     __CPROVER_assume(<a href="../../../../source/cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="../../../../source/cipher_openssl.c.html#75">props</a>));</div><div id="30" class="line none">   30 </div><div id="31" class="line hit">   31     __CPROVER_assume(<a href="../../../../source/cipher.c.html#1060">aws_cryptosdk_content_key_is_valid</a>(<a href="../../../../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>));</div><div id="32" class="line none">   32 </div><div id="33" class="line hit">   33     __CPROVER_assume(<a href="../../../../source/cipher.c.html#1056">aws_cryptosdk_data_key_is_valid</a>(<a href="../../../../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>));</div><div id="34" class="line none">   34 </div><div id="35" class="line hit">   35     __CPROVER_assume(<a href="../../aws-c-common/verification/cbmc/include/proof_helpers/utils.h.html#19">IMPLIES</a>(<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a> != NULL, <a href="../../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#13">aws_byte_buf_is_bounded</a>(<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>, MAX_BUFFER_SIZE)));</div><div id="36" class="line hit">   36     <a href="../../aws-c-common/verification/cbmc/sources/make_common_data_structures.c.html#21">ensure_byte_buf_has_allocated_buffer_member</a>(<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>);</div><div id="37" class="line hit">   37     __CPROVER_assume(<a href="../../aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>));</div><div id="38" class="line none">   38 </div><div id="39" class="line none">   39     /* Save current state of the data structure */</div><div id="40" class="line hit">   40     struct <a href="../../aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *old_message_id = <a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>;</div><div id="41" class="line hit">   41     struct <a href="../../aws-c-common/verification/cbmc/include/proof_helpers/utils.h.html#21">store_byte_from_buffer</a> old_byte_from_message_id;</div><div id="42" class="line hit">   42     <a href="../../aws-c-common/verification/cbmc/sources/utils.c.html#36">save_byte_from_array</a>(<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../../aws-c-common/include/aws/common/byte_buf.h.html#28">buffer</a>, <a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../../aws-c-common/include/aws/common/byte_buf.h.html#27">len</a>, &amp;old_byte_from_message_id);</div><div id="43" class="line none">   43 </div><div id="44" class="line none">   44     /* Operation under verification */</div><div id="45" class="line hit">   45     int rv =</div><div id="46" class="line hit">   46         <a href="../../../../source/cipher.c.html#319">__CPROVER_file_local_cipher_c_aws_cryptosdk_private_derive_key_v1</a>(<a href="../../../../source/cipher_openssl.c.html#75">props</a>, <a href="../../../../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>, <a href="../../../../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>, <a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>);</div><div id="47" class="line none">   47 </div><div id="48" class="line none">   48     /* Postconditions */</div><div id="49" class="line hit">   49     assert(<a href="../../../../source/cipher.c.html#269">aws_cryptosdk_alg_properties_is_valid</a>(<a href="../../../../source/cipher_openssl.c.html#75">props</a>));</div><div id="50" class="line hit">   50     assert(<a href="../../../../source/cipher.c.html#1060">aws_cryptosdk_content_key_is_valid</a>(<a href="../../../../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>));</div><div id="51" class="line hit">   51     assert(<a href="../../../../source/cipher.c.html#1056">aws_cryptosdk_data_key_is_valid</a>(<a href="../../../../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>));</div><div id="52" class="line hit">   52     assert(<a href="../../aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>));</div><div id="53" class="line hit">   53     <a href="../../aws-c-common/verification/cbmc/sources/utils.c.html#63">assert_byte_buf_equivalence</a>(<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>, old_message_id, &amp;old_byte_from_message_id);</div><div id="54" class="line hit">   54     if (rv == AWS_CRYPTOSDK_ERR_UNSUPPORTED_FORMAT) {</div><div id="55" class="line hit">   55         assert(<a href="../../../../include/aws/cryptosdk/private/header.h.html#31">message_id</a>-&gt;<a href="../../aws-c-common/include/aws/common/byte_buf.h.html#27">len</a> != <a href="../../../../source/cipher.c.html#30">MSG_ID_LEN</a>);</div><div id="56" class="line hit">   56     } else if (rv == <a href="../../aws-c-common/include/aws/common/error.h.html#15">AWS_OP_SUCCESS</a> &amp;&amp; <a href="../../../../source/cipher.c.html#239">aws_cryptosdk_which_sha</a>(<a href="../../../../source/cipher_openssl.c.html#75">props</a>-&gt;<a href="../../../../include/aws/cryptosdk/private/header.h.html#27">alg_id</a>) == <a href="../../../../include/aws/cryptosdk/private/hkdf.h.html#22">AWS_CRYPTOSDK_NOSHA</a>) {</div><div id="57" class="line hit">   57         assert(<a href="../../sources/utils.c.html#23">key_contents_match</a>(<a href="../../../../include/aws/cryptosdk/private/cipher.h.html#43">content_key</a>, <a href="../../../../include/aws/cryptosdk/private/cipher.h.html#39">data_key</a>, <a href="../../../../source/cipher_openssl.c.html#75">props</a>-&gt;<a href="../../../../include/aws/cryptosdk/cipher.h.html#70">data_key_len</a>));</div><div id="58" class="line hit">   58     }</div><div id="59" class="line hit">   59 }</div>
</div>
</body>
</html>
