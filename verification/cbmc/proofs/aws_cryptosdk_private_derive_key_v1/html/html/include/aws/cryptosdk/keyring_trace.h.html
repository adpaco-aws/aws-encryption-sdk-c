
<html>
<head>
<title>include/aws/cryptosdk/keyring_trace.h</title>
<link rel="stylesheet" type="text/css" href="../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * Licensed under the Apache License, Version 2.0 (the "License"). You may not use</div><div id="5" class="line none">    5  * this file except in compliance with the License. A copy of the License is</div><div id="6" class="line none">    6  * located at</div><div id="7" class="line none">    7  *</div><div id="8" class="line none">    8  *     http://aws.amazon.com/apache2.0/</div><div id="9" class="line none">    9  *</div><div id="10" class="line none">   10  * or in the "license" file accompanying this file. This file is distributed on an</div><div id="11" class="line none">   11  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</div><div id="12" class="line none">   12  * implied. See the License for the specific language governing permissions and</div><div id="13" class="line none">   13  * limitations under the License.</div><div id="14" class="line none">   14  */</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 #ifndef <a href="keyring_trace.h.html#17">AWS_CRYPTOSDK_KEYRING_TRACE_H</a></div><div id="17" class="line none">   17 #define <a href="keyring_trace.h.html#17">AWS_CRYPTOSDK_KEYRING_TRACE_H</a></div><div id="18" class="line none">   18 </div><div id="19" class="line none">   19 #include &lt;aws/common/array_list.h&gt;</div><div id="20" class="line none">   20 #include &lt;aws/common/string.h&gt;</div><div id="21" class="line none">   21 #include &lt;aws/cryptosdk/exports.h&gt;</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 /**</div><div id="24" class="line none">   24  * When a keyring is called it produces a trace of what actions it took with the</div><div id="25" class="line none">   25  * different wrapping keys it manages. The trace is a list of these records.</div><div id="26" class="line none">   26  *</div><div id="27" class="line none">   27  * The flags argument uses bit flags to indicate which actions were taken.</div><div id="28" class="line none">   28  *</div><div id="29" class="line none">   29  * The other arguments are identifiers which indicate which wrapping key was used</div><div id="30" class="line none">   30  * to do data key encryption by a keyring. Most keyring implementations write</div><div id="31" class="line none">   31  * the wrapping_key_namespace into the provider ID field of EDKs and the</div><div id="32" class="line none">   32  * wrapping_key_name into the provider info field of EDKs, and all new keyring</div><div id="33" class="line none">   33  * implementations should follow this practice. For legacy reasons, the raw AES</div><div id="34" class="line none">   34  * keyring includes other data in the provider ID field, but only the first part</div><div id="35" class="line none">   35  * of that field corresponds to what is stored in the name field here.</div><div id="36" class="line none">   36  *</div><div id="37" class="line none">   37  * Note: "Master Key (MK)" is used as a class name in the Java and Python</div><div id="38" class="line none">   38  * implementations of the AWS Encryption SDK, where it is an abstraction of a</div><div id="39" class="line none">   39  * single wrapping key, and "Master Key Provider (MKP)" is a class that provides</div><div id="40" class="line none">   40  * multiple wrapping keys. In the AWS Encryption SDK for C, the keyring</div><div id="41" class="line none">   41  * replaces both of these concepts. It handles one or multiple wrapping keys,</div><div id="42" class="line none">   42  * which makes it similar to an MKP, but from an API perspective it is in some</div><div id="43" class="line none">   43  * ways closer to an MK. In order to avoid confusion with the MK class of the</div><div id="44" class="line none">   44  * Java and Python SDKs, we always refer to a single entity used by a keyring</div><div id="45" class="line none">   45  * for data key encryption as a wrapping key.</div><div id="46" class="line none">   46  *</div><div id="47" class="line none">   47  * The motivating example of a wrapping key is a KMS CMK, for which the</div><div id="48" class="line none">   48  * namespace is "aws-kms" and the name is the key ARN.</div><div id="49" class="line none">   49  */</div><div id="50" class="line none">   50 struct <a href="keyring_trace.h.html#50">aws_cryptosdk_keyring_trace_record</a> {</div><div id="51" class="line none">   51     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *<a href="keyring_trace.h.html#51">wrapping_key_namespace</a>;</div><div id="52" class="line none">   52     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *<a href="keyring_trace.h.html#52">wrapping_key_name</a>;</div><div id="53" class="line none">   53     uint32_t <a href="keyring_trace.h.html#53">flags</a>;</div><div id="54" class="line none">   54 };</div><div id="55" class="line none">   55 </div><div id="56" class="line none">   56 /**</div><div id="57" class="line none">   57  * Bit flag indicating this wrapping key generated the data key.</div><div id="58" class="line none">   58  */</div><div id="59" class="line none">   59 #define <a href="keyring_trace.h.html#59">AWS_CRYPTOSDK_WRAPPING_KEY_GENERATED_DATA_KEY</a> 1</div><div id="60" class="line none">   60 </div><div id="61" class="line none">   61 /**</div><div id="62" class="line none">   62  * Bit flag indicating this wrapping key encrypted the data key.</div><div id="63" class="line none">   63  */</div><div id="64" class="line none">   64 #define <a href="keyring_trace.h.html#64">AWS_CRYPTOSDK_WRAPPING_KEY_ENCRYPTED_DATA_KEY</a> (1 &lt;&lt; 1)</div><div id="65" class="line none">   65 </div><div id="66" class="line none">   66 /**</div><div id="67" class="line none">   67  * Bit flag indicating this wrapping key decrypted the data key.</div><div id="68" class="line none">   68  */</div><div id="69" class="line none">   69 #define <a href="keyring_trace.h.html#69">AWS_CRYPTOSDK_WRAPPING_KEY_DECRYPTED_DATA_KEY</a> (1 &lt;&lt; 2)</div><div id="70" class="line none">   70 </div><div id="71" class="line none">   71 /**</div><div id="72" class="line none">   72  * Bit flag indicating this wrapping key signed the encryption context.</div><div id="73" class="line none">   73  */</div><div id="74" class="line none">   74 #define <a href="keyring_trace.h.html#74">AWS_CRYPTOSDK_WRAPPING_KEY_SIGNED_ENC_CTX</a> (1 &lt;&lt; 3)</div><div id="75" class="line none">   75 </div><div id="76" class="line none">   76 /**</div><div id="77" class="line none">   77  * Bit flag indicating this wrapping key verified the signature of the encryption context.</div><div id="78" class="line none">   78  */</div><div id="79" class="line none">   79 #define <a href="keyring_trace.h.html#79">AWS_CRYPTOSDK_WRAPPING_KEY_VERIFIED_ENC_CTX</a> (1 &lt;&lt; 4)</div><div id="80" class="line none">   80 </div><div id="81" class="line none">   81 #ifdef __cplusplus</div><div id="82" class="line none">   82 extern "C" {</div><div id="83" class="line none">   83 #endif</div><div id="84" class="line none">   84 </div><div id="85" class="line none">   85 /**</div><div id="86" class="line none">   86  * Evaluates the set of properties that define the shape of all valid</div><div id="87" class="line none">   87  * aws_cryptosdk_keyring_trace_record structures.</div><div id="88" class="line none">   88  */</div><div id="89" class="line none">   89 AWS_CRYPTOSDK_API</div><div id="90" class="line none">   90 bool aws_cryptosdk_keyring_trace_record_is_valid(struct <a href="keyring_trace.h.html#50">aws_cryptosdk_keyring_trace_record</a> *record);</div><div id="91" class="line none">   91 </div><div id="92" class="line none">   92 /**</div><div id="93" class="line none">   93  * Iterates over each memeber of a keyring_trace and ensures that each is a valid record.</div><div id="94" class="line none">   94  */</div><div id="95" class="line none">   95 AWS_CRYPTOSDK_API</div><div id="96" class="line none">   96 bool <a href="keyring_trace.h.html#96">aws_cryptosdk_keyring_trace_is_valid</a>(const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *trace);</div><div id="97" class="line none">   97 </div><div id="98" class="line none">   98 /**</div><div id="99" class="line none">   99  * Add a record to the trace with the specified namespace, name, and flags.</div><div id="100" class="line none">  100  * Makes duplicates of namespace and name strings. Will be deallocated</div><div id="101" class="line none">  101  * when the keyring trace object is cleared or cleaned up.</div><div id="102" class="line none">  102  */</div><div id="103" class="line none">  103 AWS_CRYPTOSDK_API</div><div id="104" class="line none">  104 int aws_cryptosdk_keyring_trace_add_record(</div><div id="105" class="line none">  105     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>,</div><div id="106" class="line none">  106     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *trace,</div><div id="107" class="line none">  107     const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *<a href="keyring_trace.h.html#51">wrapping_key_namespace</a>,</div><div id="108" class="line none">  108     const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/string.h.html#41">aws_string</a> *<a href="keyring_trace.h.html#52">wrapping_key_name</a>,</div><div id="109" class="line none">  109     uint32_t <a href="keyring_trace.h.html#53">flags</a>);</div><div id="110" class="line none">  110 </div><div id="111" class="line none">  111 /**</div><div id="112" class="line none">  112  * Same as aws_cryptosdk_keyring_trace_add_record except it takes C strings</div><div id="113" class="line none">  113  * instead of AWS strings.</div><div id="114" class="line none">  114  */</div><div id="115" class="line none">  115 AWS_CRYPTOSDK_API</div><div id="116" class="line none">  116 int aws_cryptosdk_keyring_trace_add_record_c_str(</div><div id="117" class="line none">  117     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>,</div><div id="118" class="line none">  118     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *trace,</div><div id="119" class="line none">  119     const char *<a href="keyring_trace.h.html#51">wrapping_key_namespace</a>,</div><div id="120" class="line none">  120     const char *<a href="keyring_trace.h.html#52">wrapping_key_name</a>,</div><div id="121" class="line none">  121     uint32_t <a href="keyring_trace.h.html#53">flags</a>);</div><div id="122" class="line none">  122 </div><div id="123" class="line none">  123 /**</div><div id="124" class="line none">  124  * Same as aws_cryptosdk_keyring_trace_add_record except it takes byte buffers</div><div id="125" class="line none">  125  * instead of AWS strings.</div><div id="126" class="line none">  126  */</div><div id="127" class="line none">  127 AWS_CRYPTOSDK_API</div><div id="128" class="line none">  128 int aws_cryptosdk_keyring_trace_add_record_buf(</div><div id="129" class="line none">  129     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>,</div><div id="130" class="line none">  130     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *trace,</div><div id="131" class="line none">  131     const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="keyring_trace.h.html#51">wrapping_key_namespace</a>,</div><div id="132" class="line none">  132     const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="keyring_trace.h.html#52">wrapping_key_name</a>,</div><div id="133" class="line none">  133     uint32_t <a href="keyring_trace.h.html#53">flags</a>);</div><div id="134" class="line none">  134 </div><div id="135" class="line none">  135 /**</div><div id="136" class="line none">  136  * Initialize a keyring trace.</div><div id="137" class="line none">  137  */</div><div id="138" class="line none">  138 AWS_CRYPTOSDK_API</div><div id="139" class="line none">  139 int aws_cryptosdk_keyring_trace_init(struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *trace);</div><div id="140" class="line none">  140 </div><div id="141" class="line none">  141 /**</div><div id="142" class="line none">  142  * Deallocate all memory from a keyring trace.</div><div id="143" class="line none">  143  */</div><div id="144" class="line none">  144 AWS_CRYPTOSDK_API</div><div id="145" class="line none">  145 void aws_cryptosdk_keyring_trace_clean_up(struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *trace);</div><div id="146" class="line none">  146 </div><div id="147" class="line none">  147 /**</div><div id="148" class="line none">  148  * Deallocate and remove all records from a keyring trace, but do not</div><div id="149" class="line none">  149  * deallocate the keyring trace itself.</div><div id="150" class="line none">  150  */</div><div id="151" class="line none">  151 AWS_CRYPTOSDK_API</div><div id="152" class="line none">  152 void aws_cryptosdk_keyring_trace_clear(struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *trace);</div><div id="153" class="line none">  153 </div><div id="154" class="line none">  154 #ifdef __cplusplus</div><div id="155" class="line none">  155 }</div><div id="156" class="line none">  156 #endif</div><div id="157" class="line none">  157 </div><div id="158" class="line none">  158 #endif  // AWS_CRYPTOSDK_KEYRING_TRACE_H</div>
</div>
</body>
</html>
