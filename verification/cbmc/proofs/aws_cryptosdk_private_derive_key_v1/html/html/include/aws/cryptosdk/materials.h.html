
<html>
<head>
<title>include/aws/cryptosdk/materials.h</title>
<link rel="stylesheet" type="text/css" href="../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * Licensed under the Apache License, Version 2.0 (the "License"). You may not use</div><div id="5" class="line none">    5  * this file except in compliance with the License. A copy of the License is</div><div id="6" class="line none">    6  * located at</div><div id="7" class="line none">    7  *</div><div id="8" class="line none">    8  *     http://aws.amazon.com/apache2.0/</div><div id="9" class="line none">    9  *</div><div id="10" class="line none">   10  * or in the "license" file accompanying this file. This file is distributed on an</div><div id="11" class="line none">   11  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</div><div id="12" class="line none">   12  * implied. See the License for the specific language governing permissions and</div><div id="13" class="line none">   13  * limitations under the License.</div><div id="14" class="line none">   14  */</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 #ifndef <a href="materials.h.html#17">AWS_CRYPTOSDK_MATERIALS_H</a></div><div id="17" class="line none">   17 #define <a href="materials.h.html#17">AWS_CRYPTOSDK_MATERIALS_H</a></div><div id="18" class="line none">   18 </div><div id="19" class="line none">   19 #include &lt;assert.h&gt;</div><div id="20" class="line none">   20 #include &lt;limits.h&gt;</div><div id="21" class="line none">   21 #include &lt;stdint.h&gt;</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 #include &lt;aws/common/array_list.h&gt;</div><div id="24" class="line none">   24 #include &lt;aws/common/atomics.h&gt;</div><div id="25" class="line none">   25 #include &lt;aws/common/byte_buf.h&gt;</div><div id="26" class="line none">   26 #include &lt;aws/common/common.h&gt;</div><div id="27" class="line none">   27 #include &lt;aws/common/hash_table.h&gt;</div><div id="28" class="line none">   28 </div><div id="29" class="line none">   29 #include &lt;aws/cryptosdk/<a href="../../../verification/cbmc/sources/openssl/evp_override.c.html#437">cipher</a>.h&gt;</div><div id="30" class="line none">   30 #include &lt;aws/cryptosdk/edk.h&gt;</div><div id="31" class="line none">   31 #include &lt;aws/cryptosdk/error.h&gt;</div><div id="32" class="line none">   32 #include &lt;aws/cryptosdk/exports.h&gt;</div><div id="33" class="line none">   33 #include &lt;aws/cryptosdk/header.h&gt;</div><div id="34" class="line none">   34 #include &lt;aws/cryptosdk/<a href="materials.h.html#177">keyring_trace</a>.h&gt;</div><div id="35" class="line none">   35 </div><div id="36" class="line none">   36 #ifdef __cplusplus</div><div id="37" class="line none">   37 extern "C" {</div><div id="38" class="line none">   38 #endif</div><div id="39" class="line none">   39 </div><div id="40" class="line none">   40 /**</div><div id="41" class="line none">   41  * @defgroup cmm_kr_highlevel Materials providers</div><div id="42" class="line none">   42  *</div><div id="43" class="line none">   43  * The behavior of the encryption SDK is largely defined by two types of materials providers -</div><div id="44" class="line none">   44  * the Crypto Materials Managers (CMMs) and Keyrings. In order to perform an encryption or</div><div id="45" class="line none">   45  * decryption operation, the @ref session must be given a CMM, which will typically be configured</div><div id="46" class="line none">   46  * to delegate to one or more keyrings to perform the key wrapping or unwrapping operation.</div><div id="47" class="line none">   47  *</div><div id="48" class="line none">   48  * Broadly speaking, you can think of a keyring as defining the underlying keys used to encrypt</div><div id="49" class="line none">   49  * and decrypt (and therefore, who has access to the final message), while CMMs can perform</div><div id="50" class="line none">   50  * higher-level manipulations on the overall encrypt/decrypt operation (such as caching the</div><div id="51" class="line none">   51  * results of invoking the keyring).</div><div id="52" class="line none">   52  *</div><div id="53" class="line none">   53  * CMM and keyring objects are reference counted to make it easier to construct higher-level</div><div id="54" class="line none">   54  * CMMs or keyrings out of other primitives; in general, functions in the encryption SDK which</div><div id="55" class="line none">   55  * take a CMM or keyring as an argument will appropriately increment the reference count (and</div><div id="56" class="line none">   56  * decrement it when they no longer have a reference). When this reference count reaches zero,</div><div id="57" class="line none">   57  * the CMM or keyring will be destroyed.</div><div id="58" class="line none">   58  *</div><div id="59" class="line none">   59  * All CMMs and keyrings provided as built-ins are thread-safe with respect to the API they</div><div id="60" class="line none">   60  * expose to the session; however, any configuration APIs that are specific to the type of</div><div id="61" class="line none">   61  * CMM or keyring in question may not be thread safe (that is, you can't safely change the</div><div id="62" class="line none">   62  * configuration while using the CMM or keyring on another thread's session object).</div><div id="63" class="line none">   63  */</div><div id="64" class="line none">   64 </div><div id="65" class="line none">   65 /**</div><div id="66" class="line none">   66  * @defgroup cmm_kr_lowlevel Low-level materials provider APIs</div><div id="67" class="line none">   67  *</div><div id="68" class="line none">   68  * This section contains low-level APIs of interest to developers of custom keyrings or CMMs.</div><div id="69" class="line none">   69  * @{</div><div id="70" class="line none">   70  */</div><div id="71" class="line none">   71 </div><div id="72" class="line none">   72 // Note: Most of this file will be in the low-level section.</div><div id="73" class="line none">   73 // To move something to the high-level section, use @ingroup cmm_kr_highlevel</div><div id="74" class="line none">   74 </div><div id="75" class="line none">   75 /**</div><div id="76" class="line none">   76  * Base type for a Crypto Materials Manager. Unless you are writing your own CMM, you should</div><div id="77" class="line none">   77  * not create this struct directly; see @ref aws_cryptosdk_default_cmm_new for a CMM</div><div id="78" class="line none">   78  * that will suffice in most situations.</div><div id="79" class="line none">   79  *</div><div id="80" class="line none">   80  * Implementers of CMMs should embed this struct in their implementation-specific state structure,</div><div id="81" class="line none">   81  * and use @ref aws_cryptosdk_cmm_base_init to initialize its contents.</div><div id="82" class="line none">   82  */</div><div id="83" class="line none">   83 struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> {</div><div id="84" class="line none">   84     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.h.html#16">aws_atomic_var</a> <a href="materials.h.html#84">refcount</a>;</div><div id="85" class="line none">   85     const struct <a href="materials.h.html#85">aws_cryptosdk_cmm_vt</a> *<a href="materials.h.html#85">vtable</a>;</div><div id="86" class="line none">   86 };</div><div id="87" class="line none">   87 </div><div id="88" class="line none">   88 /**</div><div id="89" class="line none">   89  * Base type for a keyring. Unless you are writing your own keyrings, you should</div><div id="90" class="line none">   90  * not create this struct directly; see @ref kms_keyring or @ref raw_keyring for built-in keyring</div><div id="91" class="line none">   91  * implementations.</div><div id="92" class="line none">   92  *</div><div id="93" class="line none">   93  * Implementers of keyrings should embed this struct in their implementation-specific state structure,</div><div id="94" class="line none">   94  * and use @ref aws_cryptosdk_keyring_base_init to initialize its contents.</div><div id="95" class="line none">   95  */</div><div id="96" class="line none">   96 struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> {</div><div id="97" class="line none">   97     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.h.html#16">aws_atomic_var</a> <a href="materials.h.html#84">refcount</a>;</div><div id="98" class="line none">   98     const struct <a href="materials.h.html#98">aws_cryptosdk_keyring_vt</a> *<a href="materials.h.html#85">vtable</a>;</div><div id="99" class="line none">   99 };</div><div id="100" class="line none">  100 </div><div id="101" class="line none">  101 /**</div><div id="102" class="line none">  102  * Governs how a @ref aws_cryptosdk_session behaves during configuration,</div><div id="103" class="line none">  103  * encryption, and decryption, with respect to key commitment.</div><div id="104" class="line none">  104  */</div><div id="105" class="line none">  105 enum <a href="materials.h.html#105">aws_cryptosdk_commitment_policy</a> {</div><div id="106" class="line none">  106     /**</div><div id="107" class="line none">  107      * Algorithm suite must support key commitment. Key commitment will be</div><div id="108" class="line none">  108      * included in ciphertext on encrypt. Valid key commitment must be present</div><div id="109" class="line none">  109      * in ciphertext on decrypt.</div><div id="110" class="line none">  110      */</div><div id="111" class="line none">  111     <a href="materials.h.html#111">COMMITMENT_POLICY_REQUIRE_ENCRYPT_REQUIRE_DECRYPT</a> = 0x598f396c,</div><div id="112" class="line none">  112 </div><div id="113" class="line none">  113     /**</div><div id="114" class="line none">  114      * Algorithm suite must support key commitment. Key commitment will be</div><div id="115" class="line none">  115      * included in ciphertext on encrypt. On decrypt, if a key commitment is</div><div id="116" class="line none">  116      * present on the ciphertext, then the key commitment must be valid.</div><div id="117" class="line none">  117      */</div><div id="118" class="line none">  118     <a href="materials.h.html#118">COMMITMENT_POLICY_REQUIRE_ENCRYPT_ALLOW_DECRYPT</a> = 0x493769b7,</div><div id="119" class="line none">  119 </div><div id="120" class="line none">  120     /**</div><div id="121" class="line none">  121      * Algorithm suite must NOT support key commitment. Key commitment will NOT</div><div id="122" class="line none">  122      * be included in ciphertext on encrypt. On decrypt, if a key commitment is</div><div id="123" class="line none">  123      * present on the ciphertext, then the key commitment must be valid.</div><div id="124" class="line none">  124      */</div><div id="125" class="line none">  125     <a href="materials.h.html#125">COMMITMENT_POLICY_FORBID_ENCRYPT_ALLOW_DECRYPT</a> = 0x2735f98a,</div><div id="126" class="line none">  126 };</div><div id="127" class="line none">  127 </div><div id="128" class="line none">  128 /**</div><div id="129" class="line none">  129  * Encryption request passed from the session to a CMM. In general, you should</div><div id="130" class="line none">  130  * not allocate or construct struct manually, since we may add additional</div><div id="131" class="line none">  131  * fields.</div><div id="132" class="line none">  132  */</div><div id="133" class="line none">  133 struct <a href="materials.h.html#133">aws_cryptosdk_enc_request</a> {</div><div id="134" class="line none">  134     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="135" class="line none">  135     /**</div><div id="136" class="line none">  136      * The encryption context for this message. CMMs are permitted to modify this</div><div id="137" class="line none">  137      * hash table in order to inject additional keys or otherwise modify the encryption</div><div id="138" class="line none">  138      * context.</div><div id="139" class="line none">  139      */</div><div id="140" class="line none">  140     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#48">aws_hash_table</a> *<a href="private/header.h.html#34">enc_ctx</a>;</div><div id="141" class="line none">  141     /**</div><div id="142" class="line none">  142      * The session will initially call generate_enc_materials on the CMM</div><div id="143" class="line none">  143      * with a zero requested_alg; it's up to one of the CMMs in the chain to fill</div><div id="144" class="line none">  144      * this in before the keyring is invoked. In particular, the default CMM will</div><div id="145" class="line none">  145      * fill in the algorithm ID it has been configured with, unless a CMM before</div><div id="146" class="line none">  146      * the default CMM filled in a different algorithm ID.</div><div id="147" class="line none">  147      */</div><div id="148" class="line none">  148     enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#148">requested_alg</a>;</div><div id="149" class="line none">  149     /**</div><div id="150" class="line none">  150      * An upper-bound on the plaintext size to be encrypted (comes from @ref</div><div id="151" class="line none">  151      * aws_cryptosdk_session_set_message_bound or @ref</div><div id="152" class="line none">  152      * aws_cryptosdk_session_set_message_size). If no bound has been set,</div><div id="153" class="line none">  153      * this will be UINT64_MAX.</div><div id="154" class="line none">  154      */</div><div id="155" class="line none">  155     uint64_t <a href="materials.h.html#155">plaintext_size</a>;</div><div id="156" class="line none">  156     /**</div><div id="157" class="line none">  157      * The key commitment policy to enforce when processing the encryption</div><div id="158" class="line none">  158      * request. The CMM is responsible for selecting an algorithm that</div><div id="159" class="line none">  159      * satisfies the commitment policy: if the commitment policy requires key</div><div id="160" class="line none">  160      * commitment, then the algorithm must be a key-committing one; otherwise,</div><div id="161" class="line none">  161      * the algorithm must NOT be a key-committing one.</div><div id="162" class="line none">  162      */</div><div id="163" class="line none">  163     enum <a href="materials.h.html#105">aws_cryptosdk_commitment_policy</a> <a href="materials.h.html#163">commitment_policy</a>;</div><div id="164" class="line none">  164 };</div><div id="165" class="line none">  165 </div><div id="166" class="line none">  166 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#166">aws_cryptosdk_enc_request_is_valid</a>(const struct <a href="materials.h.html#133">aws_cryptosdk_enc_request</a> *request) {</div><div id="167" class="line none">  167     return request &amp;&amp; <a href="../../../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#112">aws_allocator_is_valid</a>(request-&gt;<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>) &amp;&amp; <a href="../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#418">aws_hash_table_is_valid</a>(request-&gt;<a href="private/header.h.html#34">enc_ctx</a>);</div><div id="168" class="line none">  168 }</div><div id="169" class="line none">  169 </div><div id="170" class="line none">  170 /**</div><div id="171" class="line none">  171  * Materials returned from a CMM generate_enc_materials operation</div><div id="172" class="line none">  172  */</div><div id="173" class="line none">  173 struct <a href="materials.h.html#173">aws_cryptosdk_enc_materials</a> {</div><div id="174" class="line none">  174     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="175" class="line none">  175     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> <a href="materials.h.html#175">unencrypted_data_key</a>;</div><div id="176" class="line none">  176     /** Contains a trace of which wrapping keys took which actions in this request */</div><div id="177" class="line none">  177     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> <a href="materials.h.html#177">keyring_trace</a>;</div><div id="178" class="line none">  178     /** List of struct aws_cryptosdk_edk objects */</div><div id="179" class="line none">  179     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> <a href="materials.h.html#179">encrypted_data_keys</a>;</div><div id="180" class="line none">  180     /** Trailing signature context, or NULL if no trailing signature is needed for this algorithm */</div><div id="181" class="line none">  181     struct <a href="cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="materials.h.html#181">signctx</a>;</div><div id="182" class="line none">  182     enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>;</div><div id="183" class="line none">  183 };</div><div id="184" class="line none">  184 </div><div id="185" class="line none">  185 /**</div><div id="186" class="line none">  186  * Decryption request passed from session to CMM</div><div id="187" class="line none">  187  */</div><div id="188" class="line none">  188 struct <a href="materials.h.html#188">aws_cryptosdk_dec_request</a> {</div><div id="189" class="line none">  189     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="190" class="line none">  190     const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#48">aws_hash_table</a> *<a href="private/header.h.html#34">enc_ctx</a>;</div><div id="191" class="line none">  191     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> <a href="materials.h.html#179">encrypted_data_keys</a>;</div><div id="192" class="line none">  192     enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>;</div><div id="193" class="line none">  193 };</div><div id="194" class="line none">  194 </div><div id="195" class="line none">  195 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#195">aws_cryptosdk_dec_request_is_valid</a>(const struct <a href="materials.h.html#188">aws_cryptosdk_dec_request</a> *request) {</div><div id="196" class="line none">  196     return request &amp;&amp; <a href="../../../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#112">aws_allocator_is_valid</a>(request-&gt;<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>) &amp;&amp;</div><div id="197" class="line none">  197            <a href="edk.h.html#62">aws_cryptosdk_edk_list_is_valid</a>(&amp;request-&gt;<a href="materials.h.html#179">encrypted_data_keys</a>) &amp;&amp; <a href="../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#418">aws_hash_table_is_valid</a>(request-&gt;<a href="private/header.h.html#34">enc_ctx</a>);</div><div id="198" class="line none">  198 }</div><div id="199" class="line none">  199 </div><div id="200" class="line none">  200 /**</div><div id="201" class="line none">  201  * Decryption materials returned from CMM to session</div><div id="202" class="line none">  202  */</div><div id="203" class="line none">  203 struct <a href="materials.h.html#203">aws_cryptosdk_dec_materials</a> {</div><div id="204" class="line none">  204     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>;</div><div id="205" class="line none">  205     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> <a href="materials.h.html#175">unencrypted_data_key</a>;</div><div id="206" class="line none">  206     /** Contains a trace of which wrapping keys took which actions in this request */</div><div id="207" class="line none">  207     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> <a href="materials.h.html#177">keyring_trace</a>;</div><div id="208" class="line none">  208     /** Trailing signature context, or NULL if no trailing signature is needed for this algorithm */</div><div id="209" class="line none">  209     struct <a href="cipher.h.html#132">aws_cryptosdk_sig_ctx</a> *<a href="materials.h.html#181">signctx</a>;</div><div id="210" class="line none">  210     enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>;</div><div id="211" class="line none">  211 };</div><div id="212" class="line none">  212 </div><div id="213" class="line none">  213 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#213">aws_cryptosdk_enc_materials_is_valid</a>(</div><div id="214" class="line none">  214     const struct <a href="materials.h.html#173">aws_cryptosdk_enc_materials</a> *materials) {</div><div id="215" class="line none">  215     if (!AWS_OBJECT_PTR_IS_WRITABLE(materials)) {</div><div id="216" class="line none">  216         return false;</div><div id="217" class="line none">  217     }</div><div id="218" class="line none">  218     bool allocator_valid            = <a href="../../../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#112">aws_allocator_is_valid</a>(materials-&gt;<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>);</div><div id="219" class="line none">  219     bool unencrypted_data_key_valid = <a href="../../../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(&amp;materials-&gt;<a href="materials.h.html#175">unencrypted_data_key</a>);</div><div id="220" class="line none">  220     bool keyring_trace_valid        = <a href="keyring_trace.h.html#96">aws_cryptosdk_keyring_trace_is_valid</a>(&amp;materials-&gt;<a href="materials.h.html#177">keyring_trace</a>);</div><div id="221" class="line none">  221     bool encrypted_data_keys_valid  = <a href="edk.h.html#62">aws_cryptosdk_edk_list_is_valid</a>(&amp;materials-&gt;<a href="materials.h.html#179">encrypted_data_keys</a>);</div><div id="222" class="line none">  222     bool signctx_valid = (materials-&gt;<a href="materials.h.html#181">signctx</a> == NULL) || <a href="../../../source/cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(materials-&gt;<a href="materials.h.html#181">signctx</a>);</div><div id="223" class="line none">  223     return allocator_valid &amp;&amp; unencrypted_data_key_valid &amp;&amp; keyring_trace_valid &amp;&amp; encrypted_data_keys_valid &amp;&amp;</div><div id="224" class="line none">  224            signctx_valid;</div><div id="225" class="line none">  225 }</div><div id="226" class="line none">  226 </div><div id="227" class="line none">  227 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#227">aws_cryptosdk_dec_materials_is_valid</a>(</div><div id="228" class="line none">  228     const struct <a href="materials.h.html#203">aws_cryptosdk_dec_materials</a> *materials) {</div><div id="229" class="line none">  229     if (!AWS_OBJECT_PTR_IS_WRITABLE(materials)) {</div><div id="230" class="line none">  230         return false;</div><div id="231" class="line none">  231     }</div><div id="232" class="line none">  232     bool allocator_valid            = <a href="../../../verification/cbmc/aws-c-common/verification/cbmc/sources/proof_allocators.c.html#112">aws_allocator_is_valid</a>(materials-&gt;<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>);</div><div id="233" class="line none">  233     bool unencrypted_data_key_valid = <a href="../../../verification/cbmc/aws-c-common/source/byte_buf.c.html#58">aws_byte_buf_is_valid</a>(&amp;materials-&gt;<a href="materials.h.html#175">unencrypted_data_key</a>);</div><div id="234" class="line none">  234     bool keyring_trace_valid        = <a href="keyring_trace.h.html#96">aws_cryptosdk_keyring_trace_is_valid</a>(&amp;materials-&gt;<a href="materials.h.html#177">keyring_trace</a>);</div><div id="235" class="line none">  235     bool signctx_valid = (materials-&gt;<a href="materials.h.html#181">signctx</a> == NULL) || <a href="../../../source/cipher_openssl.c.html#82">aws_cryptosdk_sig_ctx_is_valid</a>(materials-&gt;<a href="materials.h.html#181">signctx</a>);</div><div id="236" class="line none">  236     return allocator_valid &amp;&amp; unencrypted_data_key_valid &amp;&amp; keyring_trace_valid &amp;&amp; signctx_valid;</div><div id="237" class="line none">  237 }</div><div id="238" class="line none">  238 </div><div id="239" class="line none">  239 #ifndef AWS_CRYPTOSDK_DOXYGEN /* do not document internal macros */</div><div id="240" class="line none">  240 </div><div id="241" class="line none">  241 /*</div><div id="242" class="line none">  242  * C99 standard dictates that "..." must have at least one argument behind it. Second arg of</div><div id="243" class="line none">  243  * _VF_CALL macros is always struct type, i.e., "cmm" or "keyring". These helper macros allow</div><div id="244" class="line none">  244  * us not to make struct_type a named argument, thus handling the case cleanly where there</div><div id="245" class="line none">  245  * are no more arguments.</div><div id="246" class="line none">  246  *</div><div id="247" class="line none">  247  * Note: We work around a VC++ preprocessor bug here. See https://stackoverflow.com/a/4750720</div><div id="248" class="line none">  248  */</div><div id="249" class="line none">  249 #    define <a href="materials.h.html#249">AWS_CRYPTOSDK_PRIVATE_STRUCT_NAME</a>(...) <a href="materials.h.html#250">AWS_CRYPTOSDK_PRIVATE_STRUCT_NAME_2</a>((__VA_ARGS__, throwaway))</div><div id="250" class="line none">  250 #    define <a href="materials.h.html#250">AWS_CRYPTOSDK_PRIVATE_STRUCT_NAME_2</a>(args) <a href="materials.h.html#251">AWS_CRYPTOSDK_PRIVATE_STRUCT_NAME_3</a> args</div><div id="251" class="line none">  251 #    define <a href="materials.h.html#251">AWS_CRYPTOSDK_PRIVATE_STRUCT_NAME_3</a>(struct_type, ...) struct_type</div><div id="252" class="line none">  252 </div><div id="253" class="line none">  253 #    define <a href="materials.h.html#253">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE</a>(...) <a href="materials.h.html#254">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE_2</a>((__VA_ARGS__, throwaway))</div><div id="254" class="line none">  254 #    define <a href="materials.h.html#254">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE_2</a>(args) <a href="materials.h.html#255">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE_3</a> args</div><div id="255" class="line none">  255 #    define <a href="materials.h.html#255">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE_3</a>(struct_type, ...) const struct aws_cryptosdk_##struct_type</div><div id="256" class="line none">  256 </div><div id="257" class="line none">  257 /**</div><div id="258" class="line none">  258  * Macro for virtual function calls that captures an integer return value. Checks that vt_size</div><div id="259" class="line none">  259  * is large enough and that pointer is non-null before attempting call. If checks fail, sets</div><div id="260" class="line none">  260  * AWS internal error to AWS_ERROR_UNIMPLEMENTED and returns the value of aws_raise_error(),</div><div id="261" class="line none">  261  * i.e., AWS_OP_ERR. Otherwise ret is set to return value of the virtual function call.</div><div id="262" class="line none">  262  *</div><div id="263" class="line none">  263  * Note that this depends on a naming convention of always using "cmm" or "keyring" as the</div><div id="264" class="line none">  264  * name of the pointer variable as the first argument of the virtual function in the inline</div><div id="265" class="line none">  265  * functions below which call this macro.</div><div id="266" class="line none">  266  */</div><div id="267" class="line none">  267 #    define <a href="materials.h.html#267">AWS_CRYPTOSDK_PRIVATE_VF_CALL</a>(fn_name, ...)                                                          \</div><div id="268" class="line none">  268         int ret;                                                                                                 \</div><div id="269" class="line none">  269         do {                                                                                                     \</div><div id="270" class="line none">  270             <a href="materials.h.html#253">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE</a>(__VA_ARGS__) *pbase =                                                \</div><div id="271" class="line none">  271                 (<a href="materials.h.html#253">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE</a>(__VA_ARGS__) *)<a href="materials.h.html#249">AWS_CRYPTOSDK_PRIVATE_STRUCT_NAME</a>(__VA_ARGS__);  \</div><div id="272" class="line none">  272             ptrdiff_t memb_offset = (const uint8_t *)&amp;(pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;fn_name - (const uint8_t *)pbase-&gt;<a href="materials.h.html#85">vtable</a>; \</div><div id="273" class="line none">  273             if (memb_offset + sizeof((pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;fn_name) &gt; (pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;<a href="materials.h.html#373">vt_size</a> ||                     \</div><div id="274" class="line none">  274                 !(pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;fn_name) {                                                                     \</div><div id="275" class="line none">  275                 return <a href="../../../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../../../verification/cbmc/aws-c-common/include/aws/common/error.h.html#180">AWS_ERROR_UNIMPLEMENTED</a>);                                                 \</div><div id="276" class="line none">  276             }                                                                                                    \</div><div id="277" class="line none">  277             ret = (pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;fn_name(__VA_ARGS__);                                                         \</div><div id="278" class="line none">  278         } while (0)</div><div id="279" class="line none">  279 </div><div id="280" class="line none">  280 /**</div><div id="281" class="line none">  281  * Macro for virtual function calls with no return value, e.g. destroy. Checks that vt_size is</div><div id="282" class="line none">  282  * large enough and that pointer is non-null before attempting call. If checks fail, sets error</div><div id="283" class="line none">  283  * code to AWS_ERROR_UNIMPLEMENTED and otherwise is a no-op.</div><div id="284" class="line none">  284  */</div><div id="285" class="line none">  285 #    define <a href="materials.h.html#285">AWS_CRYPTOSDK_PRIVATE_VF_CALL_NO_RETURN</a>(fn_name, ...)                                                \</div><div id="286" class="line none">  286         do {                                                                                                     \</div><div id="287" class="line none">  287             <a href="materials.h.html#253">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE</a>(__VA_ARGS__) *pbase =                                                \</div><div id="288" class="line none">  288                 (<a href="materials.h.html#253">AWS_CRYPTOSDK_PRIVATE_BASE_TYPE</a>(__VA_ARGS__) *)<a href="materials.h.html#249">AWS_CRYPTOSDK_PRIVATE_STRUCT_NAME</a>(__VA_ARGS__);  \</div><div id="289" class="line none">  289             ptrdiff_t memb_offset = (const uint8_t *)&amp;(pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;fn_name - (const uint8_t *)pbase-&gt;<a href="materials.h.html#85">vtable</a>; \</div><div id="290" class="line none">  290             if (memb_offset + sizeof((pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;fn_name) &gt; (pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;<a href="materials.h.html#373">vt_size</a> ||                     \</div><div id="291" class="line none">  291                 !(pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;fn_name) {                                                                     \</div><div id="292" class="line none">  292                 <a href="../../../verification/cbmc/aws-c-common/include/aws/common/error.inl.html#17">aws_raise_error</a>(<a href="../../../verification/cbmc/aws-c-common/include/aws/common/error.h.html#180">AWS_ERROR_UNIMPLEMENTED</a>);                                                        \</div><div id="293" class="line none">  293             } else {                                                                                             \</div><div id="294" class="line none">  294                 (pbase-&gt;<a href="materials.h.html#85">vtable</a>)-&gt;fn_name(__VA_ARGS__);                                                           \</div><div id="295" class="line none">  295             }                                                                                                    \</div><div id="296" class="line none">  296         } while (0)</div><div id="297" class="line none">  297 </div><div id="298" class="line none">  298 /**</div><div id="299" class="line none">  299  * Internal function: Decrement a refcount; return true if the object should be destroyed.</div><div id="300" class="line none">  300  */</div><div id="301" class="line none">  301 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#301">aws_cryptosdk_private_refcount_down</a>(struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.h.html#16">aws_atomic_var</a> *<a href="materials.h.html#84">refcount</a>) {</div><div id="302" class="line none">  302     /*</div><div id="303" class="line none">  303      * Memory ordering note: We must use release_acquire memory order here. Otherwise, we have the following race:</div><div id="304" class="line none">  304      *</div><div id="305" class="line none">  305      * Program order:</div><div id="306" class="line none">  306      *</div><div id="307" class="line none">  307      * Thread A:</div><div id="308" class="line none">  308      *   Release(obj) [if down() { free(obj) } ]</div><div id="309" class="line none">  309      *</div><div id="310" class="line none">  310      * Thread B:</div><div id="311" class="line none">  311      *   obj-&gt;foo = 1;</div><div id="312" class="line none">  312      *   Release(obj)</div><div id="313" class="line none">  313      *</div><div id="314" class="line none">  314      * Execution order:</div><div id="315" class="line none">  315      *</div><div id="316" class="line none">  316      * Thread B: down() -&gt; false</div><div id="317" class="line none">  317      * Thread A: down() -&gt; true</div><div id="318" class="line none">  318      * Thread A: free(obj)</div><div id="319" class="line none">  319      * Thread B: obj-&gt;foo = 1</div><div id="320" class="line none">  320      *</div><div id="321" class="line none">  321      * To prevent this we use release_acquire order. The release forbids any memory accesses sequenced-before the</div><div id="322" class="line none">  322      * atomic decrement of down() from being reordered later. This prevents thread B from reordering the obj-&gt;foo</div><div id="323" class="line none">  323      * access to come after the down(). The acquire ensures that the atomic decrements of down() calls correctly</div><div id="324" class="line none">  324      * synchronize-with one-another.</div><div id="325" class="line none">  325      */</div><div id="326" class="line none">  326     size_t old_count = <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics_gnu.inl.html#173">aws_atomic_fetch_sub_explicit</a>(<a href="materials.h.html#84">refcount</a>, 1, <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.h.html#65">aws_memory_order_acq_rel</a>);</div><div id="327" class="line none">  327 </div><div id="328" class="line none">  328     assert(old_count != 0);</div><div id="329" class="line none">  329 </div><div id="330" class="line none">  330     return old_count == 1;</div><div id="331" class="line none">  331 }</div><div id="332" class="line none">  332 </div><div id="333" class="line none">  333 /**</div><div id="334" class="line none">  334  * Internal function: Increment a refcount.</div><div id="335" class="line none">  335  */</div><div id="336" class="line none">  336 AWS_CRYPTOSDK_STATIC_INLINE void <a href="materials.h.html#336">aws_cryptosdk_private_refcount_up</a>(struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.h.html#16">aws_atomic_var</a> *<a href="materials.h.html#84">refcount</a>) {</div><div id="337" class="line none">  337     /*</div><div id="338" class="line none">  338      * Memory ordering note: It is safe to use relaxed here. As an invariant, we assume that,</div><div id="339" class="line none">  339      * on entry, the thread has some guarantee that the refcount will not reach zero until after</div><div id="340" class="line none">  340      * refcount_up completes. As long as this guarantee is maintained until the next release barrier,</div><div id="341" class="line none">  341      * there is no problem; if we down() on the current thread, we achieve this explicitly. Otherwise,</div><div id="342" class="line none">  342      * if we communicate to some other thread that it is safe to release the reference, that communication</div><div id="343" class="line none">  343      * needs to be in release order, as it's effectively a proxy down() call, for the same reasons outlined</div><div id="344" class="line none">  344      * above in refcount_down().</div><div id="345" class="line none">  345      *</div><div id="346" class="line none">  346      * Since we've established that our initial reference won't be released until a release barrier</div><div id="347" class="line none">  347      * occurs, we are happy to let the increment be deferred until that barrier occurs. We're also</div><div id="348" class="line none">  348      * perfectly happy with a refcount increment happening logically earlier than expected, since this</div><div id="349" class="line none">  349      * won't cause the object to be freed unexpectedly.</div><div id="350" class="line none">  350      *</div><div id="351" class="line none">  351      * We also note that acquire order is not required: We know that the object itself is already valid</div><div id="352" class="line none">  352      * when we enter refcount_up - that is, refcount_up does not change the internal state of the object.</div><div id="353" class="line none">  353      * Therefore, it's okay if some code accesses the logical state of the object "before" the refcount</div><div id="354" class="line none">  354      * increment, so long as the object is not actually freed.</div><div id="355" class="line none">  355      */</div><div id="356" class="line none">  356     size_t old_count = <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics_gnu.inl.html#165">aws_atomic_fetch_add_explicit</a>(<a href="materials.h.html#84">refcount</a>, 1, <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.h.html#39">aws_memory_order_relaxed</a>);</div><div id="357" class="line none">  357 </div><div id="358" class="line none">  358     assert(old_count != 0 &amp;&amp; old_count != SIZE_MAX);</div><div id="359" class="line none">  359 </div><div id="360" class="line none">  360     // Suppress unused variable warning when NDEBUG is set</div><div id="361" class="line none">  361     (void)old_count;</div><div id="362" class="line none">  362 }</div><div id="363" class="line none">  363 #endif  // AWS_CRYPTOSDK_DOXYGEN</div><div id="364" class="line none">  364 </div><div id="365" class="line none">  365 /**</div><div id="366" class="line none">  366  * Virtual tables for CMM and keyring. Any implementation should declare a static instance of</div><div id="367" class="line none">  367  * this, and pass it to @ref aws_cryptosdk_cmm_base_init to initialize the base struct</div><div id="368" class="line none">  368  */</div><div id="369" class="line none">  369 struct <a href="materials.h.html#85">aws_cryptosdk_cmm_vt</a> {</div><div id="370" class="line none">  370     /**</div><div id="371" class="line none">  371      * Always set to sizeof(struct aws_cryptosdk_cmm_vt).</div><div id="372" class="line none">  372      */</div><div id="373" class="line none">  373     size_t <a href="materials.h.html#373">vt_size</a>;</div><div id="374" class="line none">  374     /**</div><div id="375" class="line none">  375      * Identifier for debugging purposes only.</div><div id="376" class="line none">  376      */</div><div id="377" class="line none">  377     const char *<a href="materials.h.html#377">name</a>;</div><div id="378" class="line none">  378     /**</div><div id="379" class="line none">  379      * VIRTUAL FUNCTION: must implement unless it is a no-op. It is better to implement it as</div><div id="380" class="line none">  380      * a no-op function to avoid setting error code.</div><div id="381" class="line none">  381      */</div><div id="382" class="line none">  382     void (*<a href="materials.h.html#382">destroy</a>)(struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm);</div><div id="383" class="line none">  383 </div><div id="384" class="line none">  384     /**</div><div id="385" class="line none">  385      * VIRTUAL FUNCTION: must implement if used for encryption.</div><div id="386" class="line none">  386      */</div><div id="387" class="line none">  387     int (*<a href="materials.h.html#387">generate_enc_materials</a>)(</div><div id="388" class="line none">  388         struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm,</div><div id="389" class="line none">  389         struct <a href="materials.h.html#173">aws_cryptosdk_enc_materials</a> **output,</div><div id="390" class="line none">  390         struct <a href="materials.h.html#133">aws_cryptosdk_enc_request</a> *request);</div><div id="391" class="line none">  391     /**</div><div id="392" class="line none">  392      * VIRTUAL FUNCTION: must implement if used for decryption.</div><div id="393" class="line none">  393      */</div><div id="394" class="line none">  394     int (*<a href="materials.h.html#394">decrypt_materials</a>)(</div><div id="395" class="line none">  395         struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm,</div><div id="396" class="line none">  396         struct <a href="materials.h.html#203">aws_cryptosdk_dec_materials</a> **output,</div><div id="397" class="line none">  397         struct <a href="materials.h.html#188">aws_cryptosdk_dec_request</a> *request);</div><div id="398" class="line none">  398 };</div><div id="399" class="line none">  399 </div><div id="400" class="line none">  400 /**</div><div id="401" class="line none">  401  * Putting this here for now, until we get it merged into the atomics.h in c-common</div><div id="402" class="line none">  402  */</div><div id="403" class="line none">  403 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#403">aws_atomic_var_is_valid_int</a>(const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.h.html#16">aws_atomic_var</a> *var) {</div><div id="404" class="line none">  404     return AWS_MEM_IS_WRITABLE(var, sizeof(size_t));</div><div id="405" class="line none">  405 }</div><div id="406" class="line none">  406 </div><div id="407" class="line none">  407 /**</div><div id="408" class="line none">  408  * Putting this here for now, until we get it merged into the atomics.h in c-common</div><div id="409" class="line none">  409  */</div><div id="410" class="line none">  410 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#410">aws_atomic_var_is_valid_ptr</a>(const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.h.html#16">aws_atomic_var</a> *var) {</div><div id="411" class="line none">  411     return AWS_OBJECT_PTR_IS_WRITABLE(var) &amp;&amp; AWS_OBJECT_PTR_IS_WRITABLE((size_t *)<a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.inl.html#26">aws_atomic_load_ptr</a>(var));</div><div id="412" class="line none">  412 }</div><div id="413" class="line none">  413 </div><div id="414" class="line none">  414 /**</div><div id="415" class="line none">  415  * Constant time check of data-structure invariants for struct aws_cryptosdk_cmm_vt</div><div id="416" class="line none">  416  */</div><div id="417" class="line none">  417 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#417">aws_cryptosdk_cmm_vtable_is_valid</a>(const struct <a href="materials.h.html#85">aws_cryptosdk_cmm_vt</a> *<a href="materials.h.html#85">vtable</a>) {</div><div id="418" class="line none">  418     return AWS_OBJECT_PTR_IS_READABLE(<a href="materials.h.html#85">vtable</a>) &amp;&amp; <a href="materials.h.html#85">vtable</a>-&gt;<a href="materials.h.html#373">vt_size</a> == sizeof(struct <a href="materials.h.html#85">aws_cryptosdk_cmm_vt</a>) &amp;&amp;</div><div id="419" class="line none">  419            <a href="../../../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#42">aws_c_string_is_valid</a>(<a href="materials.h.html#85">vtable</a>-&gt;<a href="materials.h.html#377">name</a>);</div><div id="420" class="line none">  420 }</div><div id="421" class="line none">  421 </div><div id="422" class="line none">  422 /**</div><div id="423" class="line none">  423  * Constant time check of data-structure invariants for struct aws_cryptosdk_cmm. Since implementations of the</div><div id="424" class="line none">  424  * cmm may add additional fields, they may define their own, specialized is_valid functions that use this as a base.</div><div id="425" class="line none">  425  */</div><div id="426" class="line none">  426 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#426">aws_cryptosdk_cmm_base_is_valid</a>(const struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm) {</div><div id="427" class="line none">  427     return AWS_OBJECT_PTR_IS_WRITABLE(cmm) &amp;&amp; <a href="materials.h.html#403">aws_atomic_var_is_valid_int</a>(&amp;cmm-&gt;<a href="materials.h.html#84">refcount</a>) &amp;&amp;</div><div id="428" class="line none">  428            <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.inl.html#18">aws_atomic_load_int</a>(&amp;cmm-&gt;<a href="materials.h.html#84">refcount</a>) &gt; 0 &amp;&amp; <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.inl.html#18">aws_atomic_load_int</a>(&amp;cmm-&gt;<a href="materials.h.html#84">refcount</a>) &lt;= SIZE_MAX &amp;&amp;</div><div id="429" class="line none">  429            <a href="materials.h.html#417">aws_cryptosdk_cmm_vtable_is_valid</a>(cmm-&gt;<a href="materials.h.html#85">vtable</a>);</div><div id="430" class="line none">  430 }</div><div id="431" class="line none">  431 </div><div id="432" class="line none">  432 /**</div><div id="433" class="line none">  433  * Initialize the base structure for a CMM. The implementation of a CMM needs to call this function to set up the</div><div id="434" class="line none">  434  * vtable and reference count. On return, the reference count is initialized to 1.</div><div id="435" class="line none">  435  */</div><div id="436" class="line none">  436 AWS_CRYPTOSDK_STATIC_INLINE void <a href="materials.h.html#436">aws_cryptosdk_cmm_base_init</a>(</div><div id="437" class="line none">  437     struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm, const struct <a href="materials.h.html#85">aws_cryptosdk_cmm_vt</a> *<a href="materials.h.html#85">vtable</a>) {</div><div id="438" class="line none">  438     AWS_PRECONDITION(AWS_OBJECT_PTR_IS_WRITABLE(cmm));</div><div id="439" class="line none">  439     AWS_PRECONDITION(<a href="materials.h.html#417">aws_cryptosdk_cmm_vtable_is_valid</a>(<a href="materials.h.html#85">vtable</a>));</div><div id="440" class="line none">  440     cmm-&gt;<a href="materials.h.html#85">vtable</a> = <a href="materials.h.html#85">vtable</a>;</div><div id="441" class="line none">  441     <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics_gnu.inl.html#50">aws_atomic_init_int</a>(&amp;cmm-&gt;<a href="materials.h.html#84">refcount</a>, 1);</div><div id="442" class="line none">  442     AWS_POSTCONDITION(<a href="materials.h.html#426">aws_cryptosdk_cmm_base_is_valid</a>(cmm));</div><div id="443" class="line none">  443 }</div><div id="444" class="line none">  444 </div><div id="445" class="line none">  445 /**</div><div id="446" class="line none">  446  * @ingroup cmm_kr_highlevel</div><div id="447" class="line none">  447  * Decrements the reference count on the CMM. If the new reference count is zero, the CMM is destroyed.</div><div id="448" class="line none">  448  */</div><div id="449" class="line none">  449 AWS_CRYPTOSDK_STATIC_INLINE void <a href="materials.h.html#449">aws_cryptosdk_cmm_release</a>(struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm) {</div><div id="450" class="line none">  450     AWS_PRECONDITION(!cmm || <a href="materials.h.html#426">aws_cryptosdk_cmm_base_is_valid</a>(cmm));</div><div id="451" class="line none">  451     if (cmm &amp;&amp; <a href="materials.h.html#301">aws_cryptosdk_private_refcount_down</a>(&amp;cmm-&gt;<a href="materials.h.html#84">refcount</a>)) {</div><div id="452" class="line none">  452         <a href="materials.h.html#285">AWS_CRYPTOSDK_PRIVATE_VF_CALL_NO_RETURN</a>(<a href="materials.h.html#382">destroy</a>, cmm);</div><div id="453" class="line none">  453     }</div><div id="454" class="line none">  454 }</div><div id="455" class="line none">  455 </div><div id="456" class="line none">  456 /**</div><div id="457" class="line none">  457  * @ingroup cmm_kr_highlevel</div><div id="458" class="line none">  458  * Increments the reference count on the CMM.</div><div id="459" class="line none">  459  */</div><div id="460" class="line none">  460 AWS_CRYPTOSDK_STATIC_INLINE struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *<a href="materials.h.html#460">aws_cryptosdk_cmm_retain</a>(struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm) {</div><div id="461" class="line none">  461     AWS_PRECONDITION(<a href="materials.h.html#426">aws_cryptosdk_cmm_base_is_valid</a>(cmm));</div><div id="462" class="line none">  462     AWS_PRECONDITION(<a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.inl.html#18">aws_atomic_load_int</a>(&amp;cmm-&gt;<a href="materials.h.html#84">refcount</a>) &lt; SIZE_MAX);</div><div id="463" class="line none">  463     <a href="materials.h.html#336">aws_cryptosdk_private_refcount_up</a>(&amp;cmm-&gt;<a href="materials.h.html#84">refcount</a>);</div><div id="464" class="line none">  464     AWS_POSTCONDITION(<a href="materials.h.html#426">aws_cryptosdk_cmm_base_is_valid</a>(cmm));</div><div id="465" class="line none">  465     return cmm;</div><div id="466" class="line none">  466 }</div><div id="467" class="line none">  467 </div><div id="468" class="line none">  468 /**</div><div id="469" class="line none">  469  * Receives encryption request from user and attempts to generate encryption materials,</div><div id="470" class="line none">  470  * including an encrypted data key and a list of EDKs for doing encryption.</div><div id="471" class="line none">  471  *</div><div id="472" class="line none">  472  * On success returns AWS_OP_SUCCESS and allocates encryption materials object at address</div><div id="473" class="line none">  473  * pointed to by output.</div><div id="474" class="line none">  474  *</div><div id="475" class="line none">  475  * On failure returns AWS_OP_ERR, sets address pointed to by output to NULL, and sets</div><div id="476" class="line none">  476  * internal AWS error code.</div><div id="477" class="line none">  477  */</div><div id="478" class="line none">  478 AWS_CRYPTOSDK_STATIC_INLINE int <a href="materials.h.html#478">aws_cryptosdk_cmm_generate_enc_materials</a>(</div><div id="479" class="line none">  479     struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm,</div><div id="480" class="line none">  480     struct <a href="materials.h.html#173">aws_cryptosdk_enc_materials</a> **output,</div><div id="481" class="line none">  481     struct <a href="materials.h.html#133">aws_cryptosdk_enc_request</a> *request) {</div><div id="482" class="line none">  482     if (output) {</div><div id="483" class="line none">  483         *output = NULL;</div><div id="484" class="line none">  484     }</div><div id="485" class="line none">  485     AWS_ERROR_PRECONDITION(<a href="materials.h.html#426">aws_cryptosdk_cmm_base_is_valid</a>(cmm), <a href="../../../verification/cbmc/aws-c-common/include/aws/common/error.h.html#180">AWS_ERROR_UNIMPLEMENTED</a>);</div><div id="486" class="line none">  486     AWS_ERROR_PRECONDITION(output == NULL || AWS_OBJECT_PTR_IS_WRITABLE(output));</div><div id="487" class="line none">  487     AWS_ERROR_PRECONDITION(request == NULL || <a href="materials.h.html#166">aws_cryptosdk_enc_request_is_valid</a>(request));</div><div id="488" class="line none">  488     <a href="materials.h.html#267">AWS_CRYPTOSDK_PRIVATE_VF_CALL</a>(<a href="materials.h.html#387">generate_enc_materials</a>, cmm, output, request);</div><div id="489" class="line none">  489     return ret;</div><div id="490" class="line none">  490 }</div><div id="491" class="line none">  491 </div><div id="492" class="line none">  492 /**</div><div id="493" class="line none">  493  * Receives decryption request from user and attempts to get decryption materials.</div><div id="494" class="line none">  494  *</div><div id="495" class="line none">  495  * On success returns AWS_OP_SUCCESS and allocates decryption materials object at address</div><div id="496" class="line none">  496  * pointed to by output.</div><div id="497" class="line none">  497  *</div><div id="498" class="line none">  498  * On failure returns AWS_OP_ERR, sets address pointed to by output to NULL, and sets</div><div id="499" class="line none">  499  * internal AWS error code.</div><div id="500" class="line none">  500  */</div><div id="501" class="line none">  501 AWS_CRYPTOSDK_STATIC_INLINE int <a href="materials.h.html#501">aws_cryptosdk_cmm_decrypt_materials</a>(</div><div id="502" class="line none">  502     struct <a href="materials.h.html#83">aws_cryptosdk_cmm</a> *cmm,</div><div id="503" class="line none">  503     struct <a href="materials.h.html#203">aws_cryptosdk_dec_materials</a> **output,</div><div id="504" class="line none">  504     struct <a href="materials.h.html#188">aws_cryptosdk_dec_request</a> *request) {</div><div id="505" class="line none">  505     if (output) {</div><div id="506" class="line none">  506         *output = NULL;</div><div id="507" class="line none">  507     }</div><div id="508" class="line none">  508     AWS_ERROR_PRECONDITION(<a href="materials.h.html#426">aws_cryptosdk_cmm_base_is_valid</a>(cmm), <a href="../../../verification/cbmc/aws-c-common/include/aws/common/error.h.html#180">AWS_ERROR_UNIMPLEMENTED</a>);</div><div id="509" class="line none">  509     AWS_ERROR_PRECONDITION(output == NULL || AWS_OBJECT_PTR_IS_WRITABLE(output));</div><div id="510" class="line none">  510     AWS_ERROR_PRECONDITION(request == NULL || <a href="materials.h.html#195">aws_cryptosdk_dec_request_is_valid</a>(request));</div><div id="511" class="line none">  511 </div><div id="512" class="line none">  512     <a href="materials.h.html#267">AWS_CRYPTOSDK_PRIVATE_VF_CALL</a>(<a href="materials.h.html#394">decrypt_materials</a>, cmm, output, request);</div><div id="513" class="line none">  513     return ret;</div><div id="514" class="line none">  514 }</div><div id="515" class="line none">  515 </div><div id="516" class="line none">  516 struct <a href="materials.h.html#98">aws_cryptosdk_keyring_vt</a> {</div><div id="517" class="line none">  517     /**</div><div id="518" class="line none">  518      * Always set to sizeof(struct aws_cryptosdk_keyring_vt).</div><div id="519" class="line none">  519      */</div><div id="520" class="line none">  520     size_t <a href="materials.h.html#373">vt_size</a>;</div><div id="521" class="line none">  521     /**</div><div id="522" class="line none">  522      * Identifier for debugging purposes only.</div><div id="523" class="line none">  523      */</div><div id="524" class="line none">  524     const char *<a href="materials.h.html#377">name</a>;</div><div id="525" class="line none">  525     /**</div><div id="526" class="line none">  526      * VIRTUAL FUNCTION: must implement unless it is a no-op. It is better to implement it as</div><div id="527" class="line none">  527      * a no-op function to avoid setting error code.</div><div id="528" class="line none">  528      */</div><div id="529" class="line none">  529     void (*<a href="materials.h.html#382">destroy</a>)(struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring);</div><div id="530" class="line none">  530 </div><div id="531" class="line none">  531     /**</div><div id="532" class="line none">  532      * VIRTUAL FUNCTION: must implement if used for encryption.</div><div id="533" class="line none">  533      *</div><div id="534" class="line none">  534      * When the buffer for the unencrypted data key is not NULL at the time of the call, it</div><div id="535" class="line none">  535      * must not be changed by callee. All buffers for EDKs pushed onto the list must be in a</div><div id="536" class="line none">  536      * valid state, which means either that they are set to all zeroes or that they have been</div><div id="537" class="line none">  537      * initialized using one of the byte buffer initialization functions. This assures proper</div><div id="538" class="line none">  538      * clean up and serialization.</div><div id="539" class="line none">  539      */</div><div id="540" class="line none">  540     int (*<a href="materials.h.html#540">on_encrypt</a>)(</div><div id="541" class="line none">  541         struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring,</div><div id="542" class="line none">  542         struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *request_alloc,</div><div id="543" class="line none">  543         struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="materials.h.html#175">unencrypted_data_key</a>,</div><div id="544" class="line none">  544         struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *<a href="materials.h.html#177">keyring_trace</a>,</div><div id="545" class="line none">  545         struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *edks,</div><div id="546" class="line none">  546         const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#48">aws_hash_table</a> *<a href="private/header.h.html#34">enc_ctx</a>,</div><div id="547" class="line none">  547         enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>);</div><div id="548" class="line none">  548 </div><div id="549" class="line none">  549     /**</div><div id="550" class="line none">  550      * VIRTUAL FUNCTION: must implement if used for decryption.</div><div id="551" class="line none">  551      *</div><div id="552" class="line none">  552      * Implementations must properly initialize the unencrypted data key buffer when an</div><div id="553" class="line none">  553      * EDK is decrypted and leave the unencrypted data key buffer pointer set to NULL</div><div id="554" class="line none">  554      * when no EDK is decrypted. Implementations should return AWS_OP_SUCCESS regardless</div><div id="555" class="line none">  555      * of whether the unencrypted data key is recovered, except in cases of internal errors.</div><div id="556" class="line none">  556      */</div><div id="557" class="line none">  557     int (*<a href="materials.h.html#557">on_decrypt</a>)(</div><div id="558" class="line none">  558         struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring,</div><div id="559" class="line none">  559         struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *request_alloc,</div><div id="560" class="line none">  560         struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="materials.h.html#175">unencrypted_data_key</a>,</div><div id="561" class="line none">  561         struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *<a href="materials.h.html#177">keyring_trace</a>,</div><div id="562" class="line none">  562         const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *edks,</div><div id="563" class="line none">  563         const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#48">aws_hash_table</a> *<a href="private/header.h.html#34">enc_ctx</a>,</div><div id="564" class="line none">  564         enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>);</div><div id="565" class="line none">  565 };</div><div id="566" class="line none">  566 </div><div id="567" class="line none">  567 /**</div><div id="568" class="line none">  568  * Constant time check of data-structure invariants for struct aws_cryptosdk_keyring_vt.</div><div id="569" class="line none">  569  */</div><div id="570" class="line none">  570 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#570">aws_cryptosdk_keyring_vt_is_valid</a>(const struct <a href="materials.h.html#98">aws_cryptosdk_keyring_vt</a> *<a href="materials.h.html#85">vtable</a>) {</div><div id="571" class="line none">  571     return AWS_OBJECT_PTR_IS_READABLE(<a href="materials.h.html#85">vtable</a>) &amp;&amp; <a href="../../../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#42">aws_c_string_is_valid</a>(<a href="materials.h.html#85">vtable</a>-&gt;<a href="materials.h.html#377">name</a>) &amp;&amp;</div><div id="572" class="line none">  572            /* Always set to sizeof(struct aws_cryptosdk_keyring_vt). */</div><div id="573" class="line none">  573            (<a href="materials.h.html#85">vtable</a>-&gt;<a href="materials.h.html#373">vt_size</a> == sizeof(struct <a href="materials.h.html#98">aws_cryptosdk_keyring_vt</a>));</div><div id="574" class="line none">  574 }</div><div id="575" class="line none">  575 </div><div id="576" class="line none">  576 /**</div><div id="577" class="line none">  577  * Constant time check of data-structure invariants for struct aws_cryptosdk_keyring.</div><div id="578" class="line none">  578  */</div><div id="579" class="line none">  579 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#579">aws_cryptosdk_keyring_is_valid</a>(const struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring) {</div><div id="580" class="line none">  580     return AWS_OBJECT_PTR_IS_READABLE(keyring) &amp;&amp; <a href="materials.h.html#403">aws_atomic_var_is_valid_int</a>(&amp;keyring-&gt;<a href="materials.h.html#84">refcount</a>) &amp;&amp;</div><div id="581" class="line none">  581            (<a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.inl.html#18">aws_atomic_load_int</a>(&amp;keyring-&gt;<a href="materials.h.html#84">refcount</a>) &gt; 0) &amp;&amp; (<a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.inl.html#18">aws_atomic_load_int</a>(&amp;keyring-&gt;<a href="materials.h.html#84">refcount</a>) &lt;= SIZE_MAX) &amp;&amp;</div><div id="582" class="line none">  582            (keyring-&gt;<a href="materials.h.html#85">vtable</a> == NULL || <a href="materials.h.html#570">aws_cryptosdk_keyring_vt_is_valid</a>(keyring-&gt;<a href="materials.h.html#85">vtable</a>));</div><div id="583" class="line none">  583 }</div><div id="584" class="line none">  584 </div><div id="585" class="line none">  585 /**</div><div id="586" class="line none">  586  * Initialize the base structure for a keyring. The implementation of a keyring needs to call this function</div><div id="587" class="line none">  587  * to set up the vtable and reference count. On return, the reference count is initialized to 1.</div><div id="588" class="line none">  588  */</div><div id="589" class="line none">  589 AWS_CRYPTOSDK_STATIC_INLINE void <a href="materials.h.html#589">aws_cryptosdk_keyring_base_init</a>(</div><div id="590" class="line none">  590     struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring, const struct <a href="materials.h.html#98">aws_cryptosdk_keyring_vt</a> *<a href="materials.h.html#85">vtable</a>) {</div><div id="591" class="line none">  591     AWS_PRECONDITION(keyring != NULL);</div><div id="592" class="line none">  592     AWS_PRECONDITION(<a href="materials.h.html#85">vtable</a> == NULL || <a href="materials.h.html#570">aws_cryptosdk_keyring_vt_is_valid</a>(<a href="materials.h.html#85">vtable</a>));</div><div id="593" class="line none">  593     AWS_PRECONDITION(<a href="materials.h.html#85">vtable</a> == NULL || <a href="../../../verification/cbmc/aws-c-common/include/aws/common/string.inl.html#42">aws_c_string_is_valid</a>(<a href="materials.h.html#85">vtable</a>-&gt;<a href="materials.h.html#377">name</a>));</div><div id="594" class="line none">  594     keyring-&gt;<a href="materials.h.html#85">vtable</a> = <a href="materials.h.html#85">vtable</a>;</div><div id="595" class="line none">  595     <a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics_gnu.inl.html#50">aws_atomic_init_int</a>(&amp;keyring-&gt;<a href="materials.h.html#84">refcount</a>, 1);</div><div id="596" class="line none">  596 }</div><div id="597" class="line none">  597 </div><div id="598" class="line none">  598 /**</div><div id="599" class="line none">  599  * @ingroup cmm_kr_highlevel</div><div id="600" class="line none">  600  * Decrements the reference count on the keyring; if the new reference count is zero, the keyring is destroyed.</div><div id="601" class="line none">  601  */</div><div id="602" class="line none">  602 AWS_CRYPTOSDK_STATIC_INLINE void <a href="materials.h.html#602">aws_cryptosdk_keyring_release</a>(struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring) {</div><div id="603" class="line none">  603     AWS_PRECONDITION(!keyring || (<a href="materials.h.html#579">aws_cryptosdk_keyring_is_valid</a>(keyring) &amp;&amp; keyring-&gt;<a href="materials.h.html#85">vtable</a> != NULL));</div><div id="604" class="line none">  604     if (keyring &amp;&amp; <a href="materials.h.html#301">aws_cryptosdk_private_refcount_down</a>(&amp;keyring-&gt;<a href="materials.h.html#84">refcount</a>)) {</div><div id="605" class="line none">  605         <a href="materials.h.html#285">AWS_CRYPTOSDK_PRIVATE_VF_CALL_NO_RETURN</a>(<a href="materials.h.html#382">destroy</a>, keyring);</div><div id="606" class="line none">  606     }</div><div id="607" class="line none">  607 }</div><div id="608" class="line none">  608 </div><div id="609" class="line none">  609 /**</div><div id="610" class="line none">  610  * @ingroup cmm_kr_highlevel</div><div id="611" class="line none">  611  * Increments the reference count on the keyring.</div><div id="612" class="line none">  612  */</div><div id="613" class="line none">  613 AWS_CRYPTOSDK_STATIC_INLINE struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *<a href="materials.h.html#613">aws_cryptosdk_keyring_retain</a>(</div><div id="614" class="line none">  614     struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring) {</div><div id="615" class="line none">  615     AWS_PRECONDITION(<a href="materials.h.html#579">aws_cryptosdk_keyring_is_valid</a>(keyring));</div><div id="616" class="line none">  616     AWS_PRECONDITION(<a href="materials.h.html#403">aws_atomic_var_is_valid_int</a>(&amp;keyring-&gt;<a href="materials.h.html#84">refcount</a>));</div><div id="617" class="line none">  617     AWS_PRECONDITION(<a href="../../../verification/cbmc/aws-c-common/include/aws/common/atomics.inl.html#18">aws_atomic_load_int</a>(&amp;keyring-&gt;<a href="materials.h.html#84">refcount</a>) &lt; SIZE_MAX);</div><div id="618" class="line none">  618     <a href="materials.h.html#336">aws_cryptosdk_private_refcount_up</a>(&amp;keyring-&gt;<a href="materials.h.html#84">refcount</a>);</div><div id="619" class="line none">  619     return keyring;</div><div id="620" class="line none">  620 }</div><div id="621" class="line none">  621 </div><div id="622" class="line none">  622 /**</div><div id="623" class="line none">  623  * If byte buffer for unencrypted_data_key is already allocated, this makes zero or more</div><div id="624" class="line none">  624  * encrypted data keys which decrypt to that data key and pushes them onto the EDK list.</div><div id="625" class="line none">  625  *</div><div id="626" class="line none">  626  * If byte buffer for unencrypted_data_key is not already allocated, this may make a new</div><div id="627" class="line none">  627  * data key, allocating the buffer and putting the data key into that buffer. It also makes</div><div id="628" class="line none">  628  * zero or more encrypted data keys which decrypt to that data key and pushes them onto</div><div id="629" class="line none">  629  * the EDK list.</div><div id="630" class="line none">  630  *</div><div id="631" class="line none">  631  * On success (1) AWS_OP_SUCCESS is returned, (2) if the unencrypted_data_key buffer was</div><div id="632" class="line none">  632  * previously allocated, it will be unchanged, (3) if the unencrypted_data_key buffer was</div><div id="633" class="line none">  633  * not previously allocated, it may now be allocated, (4) zero or more EDKS will be</div><div id="634" class="line none">  634  * appended to the list of EDKS.</div><div id="635" class="line none">  635  *</div><div id="636" class="line none">  636  * On failure AWS_OP_ERR is returned, an internal AWS error code is set.</div><div id="637" class="line none">  637  */</div><div id="638" class="line none">  638 AWS_CRYPTOSDK_API</div><div id="639" class="line none">  639 int aws_cryptosdk_keyring_on_encrypt(</div><div id="640" class="line none">  640     struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring,</div><div id="641" class="line none">  641     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *request_alloc,</div><div id="642" class="line none">  642     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="materials.h.html#175">unencrypted_data_key</a>,</div><div id="643" class="line none">  643     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *<a href="materials.h.html#177">keyring_trace</a>,</div><div id="644" class="line none">  644     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *edks,</div><div id="645" class="line none">  645     const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#48">aws_hash_table</a> *<a href="private/header.h.html#34">enc_ctx</a>,</div><div id="646" class="line none">  646     enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>);</div><div id="647" class="line none">  647 </div><div id="648" class="line none">  648 /**</div><div id="649" class="line none">  649  * The KR attempts to find one of the EDKs to decrypt.</div><div id="650" class="line none">  650  *</div><div id="651" class="line none">  651  * On success AWS_OP_SUCCESS will be returned. This does not necessarily mean that the</div><div id="652" class="line none">  652  * data key will be decrypted, as it is normal behavior that a particular KR may not</div><div id="653" class="line none">  653  * find an EDK that it can decrypt. To determine whether the data key was decrypted,</div><div id="654" class="line none">  654  * check unencrypted_data_key.buffer. If the data key was not decrypted, that pointer</div><div id="655" class="line none">  655  * will be set to NULL. If the data key was decrypted, that pointer will point to the</div><div id="656" class="line none">  656  * bytes of the key.</div><div id="657" class="line none">  657  *</div><div id="658" class="line none">  658  * On internal failure, AWS_OP_ERR will be returned and an error code will be set.</div><div id="659" class="line none">  659  */</div><div id="660" class="line none">  660 AWS_CRYPTOSDK_API</div><div id="661" class="line none">  661 int aws_cryptosdk_keyring_on_decrypt(</div><div id="662" class="line none">  662     struct <a href="materials.h.html#96">aws_cryptosdk_keyring</a> *keyring,</div><div id="663" class="line none">  663     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *request_alloc,</div><div id="664" class="line none">  664     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/byte_buf.h.html#25">aws_byte_buf</a> *<a href="materials.h.html#175">unencrypted_data_key</a>,</div><div id="665" class="line none">  665     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *<a href="materials.h.html#177">keyring_trace</a>,</div><div id="666" class="line none">  666     const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#15">aws_array_list</a> *edks,</div><div id="667" class="line none">  667     const struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/hash_table.h.html#48">aws_hash_table</a> *<a href="private/header.h.html#34">enc_ctx</a>,</div><div id="668" class="line none">  668     enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>);</div><div id="669" class="line none">  669 </div><div id="670" class="line none">  670 /**</div><div id="671" class="line none">  671  * Allocates a new encryption materials object, including allocating memory to the list</div><div id="672" class="line none">  672  * of EDKs. The list of EDKs will be empty and no memory will be allocated to any byte</div><div id="673" class="line none">  673  * buffers in that list, nor will memory be allocated to the unencrypted data key buffer.</div><div id="674" class="line none">  674  *</div><div id="675" class="line none">  675  * On failure, returns NULL and an error code will be set.</div><div id="676" class="line none">  676  */</div><div id="677" class="line none">  677 AWS_CRYPTOSDK_API</div><div id="678" class="line none">  678 struct <a href="materials.h.html#173">aws_cryptosdk_enc_materials</a> *aws_cryptosdk_enc_materials_new(</div><div id="679" class="line none">  679     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>);</div><div id="680" class="line none">  680 </div><div id="681" class="line none">  681 /**</div><div id="682" class="line none">  682  * Deallocates all memory associated with the encryption materials object including the</div><div id="683" class="line none">  683  * object itself. All keys in the materials will have their associated memory also</div><div id="684" class="line none">  684  * deallocated, but make sure that they have been initialized properly per the comments</div><div id="685" class="line none">  685  * on aws_cryptosdk_keyring_generate_data_key.</div><div id="686" class="line none">  686  */</div><div id="687" class="line none">  687 AWS_CRYPTOSDK_API</div><div id="688" class="line none">  688 void aws_cryptosdk_enc_materials_destroy(struct <a href="materials.h.html#173">aws_cryptosdk_enc_materials</a> *enc_mat);</div><div id="689" class="line none">  689 </div><div id="690" class="line none">  690 /**</div><div id="691" class="line none">  691  * Allocates a new decryption materials object. Note that no memory will be allocated to</div><div id="692" class="line none">  692  * the byte buffer for  the unencrypted data key. That will only be allocated when an EDK</div><div id="693" class="line none">  693  * is decrypted.</div><div id="694" class="line none">  694  *</div><div id="695" class="line none">  695  * On failure, returns NULL and an internal AWS error code is set.</div><div id="696" class="line none">  696  */</div><div id="697" class="line none">  697 AWS_CRYPTOSDK_API</div><div id="698" class="line none">  698 struct <a href="materials.h.html#203">aws_cryptosdk_dec_materials</a> *aws_cryptosdk_dec_materials_new(</div><div id="699" class="line none">  699     struct <a href="../../../verification/cbmc/aws-c-common/include/aws/common/allocator.h.html#15">aws_allocator</a> *<a href="../../../verification/cbmc/aws-c-common/include/aws/common/array_list.h.html#16">alloc</a>, enum <a href="header.h.html#26">aws_cryptosdk_alg_id</a> <a href="materials.h.html#182">alg</a>);</div><div id="700" class="line none">  700 </div><div id="701" class="line none">  701 /**</div><div id="702" class="line none">  702  * Deallocates all memory associated with the decryption materials object including the</div><div id="703" class="line none">  703  * object itself and the unencrypted data key it is holding, if an EDK has been decrypted</div><div id="704" class="line none">  704  * successfully.</div><div id="705" class="line none">  705  */</div><div id="706" class="line none">  706 AWS_CRYPTOSDK_API</div><div id="707" class="line none">  707 void aws_cryptosdk_dec_materials_destroy(struct <a href="materials.h.html#203">aws_cryptosdk_dec_materials</a> *dec_mat);</div><div id="708" class="line none">  708 </div><div id="709" class="line none">  709 /**</div><div id="710" class="line none">  710  * Returns true if the given uint32_t is a valid @ref aws_cryptosdk_commitment_policy, or false otherwise.</div><div id="711" class="line none">  711  */</div><div id="712" class="line none">  712 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#712">aws_cryptosdk_commitment_policy_is_valid</a>(uint32_t <a href="materials.h.html#163">commitment_policy</a>) {</div><div id="713" class="line none">  713     switch (<a href="materials.h.html#163">commitment_policy</a>) {</div><div id="714" class="line none">  714         case <a href="materials.h.html#111">COMMITMENT_POLICY_REQUIRE_ENCRYPT_REQUIRE_DECRYPT</a>:</div><div id="715" class="line none">  715         case <a href="materials.h.html#118">COMMITMENT_POLICY_REQUIRE_ENCRYPT_ALLOW_DECRYPT</a>:</div><div id="716" class="line none">  716         case <a href="materials.h.html#125">COMMITMENT_POLICY_FORBID_ENCRYPT_ALLOW_DECRYPT</a>: return true;</div><div id="717" class="line none">  717         default: return false;</div><div id="718" class="line none">  718     }</div><div id="719" class="line none">  719 }</div><div id="720" class="line none">  720 </div><div id="721" class="line none">  721 /**</div><div id="722" class="line none">  722  * Returns true if encryption must include key commitment under the given key</div><div id="723" class="line none">  723  * commitment policy, or false otherwise.</div><div id="724" class="line none">  724  */</div><div id="725" class="line none">  725 AWS_CRYPTOSDK_STATIC_INLINE bool <a href="materials.h.html#725">aws_cryptosdk_commitment_policy_encrypt_must_include_commitment</a>(</div><div id="726" class="line none">  726     enum <a href="materials.h.html#105">aws_cryptosdk_commitment_policy</a> <a href="materials.h.html#163">commitment_policy</a>) {</div><div id="727" class="line none">  727     switch (<a href="materials.h.html#163">commitment_policy</a>) {</div><div id="728" class="line none">  728         case <a href="materials.h.html#111">COMMITMENT_POLICY_REQUIRE_ENCRYPT_REQUIRE_DECRYPT</a>:</div><div id="729" class="line none">  729         case <a href="materials.h.html#118">COMMITMENT_POLICY_REQUIRE_ENCRYPT_ALLOW_DECRYPT</a>: return true;</div><div id="730" class="line none">  730         case <a href="materials.h.html#125">COMMITMENT_POLICY_FORBID_ENCRYPT_ALLOW_DECRYPT</a>: return false;</div><div id="731" class="line none">  731         default: return false;</div><div id="732" class="line none">  732     }</div><div id="733" class="line none">  733 }</div><div id="734" class="line none">  734 </div><div id="735" class="line none">  735 #ifdef __cplusplus</div><div id="736" class="line none">  736 }</div><div id="737" class="line none">  737 #endif</div><div id="738" class="line none">  738 </div><div id="739" class="line none">  739 /** @} */  // doxygen group cmm_kr_lowlevel</div><div id="740" class="line none">  740 </div><div id="741" class="line none">  741 #endif  // AWS_CRYPTOSDK_MATERIALS_H</div>
</div>
</body>
</html>
